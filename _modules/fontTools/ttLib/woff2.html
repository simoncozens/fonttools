

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fontTools.ttLib.woff2 &mdash; fontTools Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> fontTools
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../afmLib.html">afmLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agl.html">agl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cffLib/index.html">cffLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../colorLib/index.html">colorLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cu2qu/index.html">cu2qu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../designspaceLib/index.html">designspaceLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../encodings/index.html">encodings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../feaLib/index.html">feaLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../merge.html">merge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mtiLib.html">mtiLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../otlLib/index.html">otlLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pens/index.html">pens</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subset/index.html">subset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svgLib/index.html">svgLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../t1Lib.html">t1Lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ttLib/index.html">ttLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ttx.html">ttx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ufoLib/index.html">ufoLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../unicode.html">unicode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../unicodedata/index.html">unicodedata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../varLib/index.html">varLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voltLib.html">voltLib</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">fontTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../ttLib.html">fontTools.ttLib</a> &raquo;</li>
        
      <li>fontTools.ttLib.woff2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fontTools.ttLib.woff2</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">fontTools.misc.py23</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">fontTools.misc</span> <span class="k">import</span> <span class="n">sstruct</span>
<span class="kn">from</span> <span class="nn">fontTools.misc.arrayTools</span> <span class="k">import</span> <span class="n">calcIntBounds</span>
<span class="kn">from</span> <span class="nn">fontTools.misc.textTools</span> <span class="k">import</span> <span class="n">pad</span>
<span class="kn">from</span> <span class="nn">fontTools.ttLib</span> <span class="k">import</span> <span class="p">(</span><span class="n">TTFont</span><span class="p">,</span> <span class="n">TTLibError</span><span class="p">,</span> <span class="n">getTableModule</span><span class="p">,</span> <span class="n">getTableClass</span><span class="p">,</span>
	<span class="n">getSearchRange</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">fontTools.ttLib.sfnt</span> <span class="k">import</span> <span class="p">(</span><span class="n">SFNTReader</span><span class="p">,</span> <span class="n">SFNTWriter</span><span class="p">,</span> <span class="n">DirectoryEntry</span><span class="p">,</span>
	<span class="n">WOFFFlavorData</span><span class="p">,</span> <span class="n">sfntDirectoryFormat</span><span class="p">,</span> <span class="n">sfntDirectorySize</span><span class="p">,</span> <span class="n">SFNTDirectoryEntry</span><span class="p">,</span>
	<span class="n">sfntDirectoryEntrySize</span><span class="p">,</span> <span class="n">calcChecksum</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">fontTools.ttLib.tables</span> <span class="k">import</span> <span class="n">ttProgram</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;fontTools.ttLib.woff2&quot;</span><span class="p">)</span>

<span class="n">haveBrotli</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">brotli</span>
	<span class="n">haveBrotli</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
	<span class="k">pass</span>


<div class="viewcode-block" id="WOFF2Reader"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2Reader">[docs]</a><span class="k">class</span> <span class="nc">WOFF2Reader</span><span class="p">(</span><span class="n">SFNTReader</span><span class="p">):</span>

	<span class="n">flavor</span> <span class="o">=</span> <span class="s2">&quot;woff2&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">checkChecksums</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontNumber</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">haveBrotli</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
				<span class="s1">&#39;The WOFF2 decoder requires the Brotli Python extension, available at: &#39;</span>
				<span class="s1">&#39;https://github.com/google/brotli&#39;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;No module named brotli&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>

		<span class="n">signature</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">signature</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;wOF2&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;Not a WOFF2 font (bad signature)&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">DirectoryEntry</span> <span class="o">=</span> <span class="n">WOFF2DirectoryEntry</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">woff2DirectorySize</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">woff2DirectorySize</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;Not a WOFF2 font (not enough data)&#39;</span><span class="p">)</span>
		<span class="n">sstruct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">woff2DirectoryFormat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numTables</span><span class="p">):</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DirectoryEntry</span><span class="p">()</span>
			<span class="n">entry</span><span class="o">.</span><span class="n">fromFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
			<span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>
			<span class="n">entry</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">.</span><span class="n">length</span>

		<span class="n">totalUncompressedSize</span> <span class="o">=</span> <span class="n">offset</span>
		<span class="n">compressedData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totalCompressedSize</span><span class="p">)</span>
		<span class="n">decompressedData</span> <span class="o">=</span> <span class="n">brotli</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">compressedData</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">decompressedData</span><span class="p">)</span> <span class="o">!=</span> <span class="n">totalUncompressedSize</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
				<span class="s1">&#39;unexpected size for decompressed font data: expected </span><span class="si">%d</span><span class="s1">, found </span><span class="si">%d</span><span class="s1">&#39;</span>
				<span class="o">%</span> <span class="p">(</span><span class="n">totalUncompressedSize</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">decompressedData</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">decompressedData</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">():</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;reported &#39;length&#39; doesn&#39;t match the actual file size&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span> <span class="o">=</span> <span class="n">WOFF2FlavorData</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

		<span class="c1"># make empty TTFont to store data while reconstructing tables</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span> <span class="o">=</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">recalcBBoxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recalcTimestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Fetch the raw table data. Reconstruct transformed tables.&quot;&quot;&quot;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">Tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)]</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">):</span>
			<span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">transformed</span><span class="p">:</span>
				<span class="n">entry</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconstructTable</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">entry</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span>

<div class="viewcode-block" id="WOFF2Reader.reconstructTable"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2Reader.reconstructTable">[docs]</a>	<span class="k">def</span> <span class="nf">reconstructTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Reconstruct table named &#39;tag&#39; from transformed data.&quot;&quot;&quot;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">Tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)]</span>
		<span class="n">rawData</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">loadData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;glyf&#39;</span><span class="p">:</span>
			<span class="c1"># no need to pad glyph data when reconstructing</span>
			<span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
			<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconstructGlyf</span><span class="p">(</span><span class="n">rawData</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;loca&#39;</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconstructLoca</span><span class="p">()</span>
		<span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;hmtx&#39;</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reconstructHmtx</span><span class="p">(</span><span class="n">rawData</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;transform for table &#39;</span><span class="si">%s</span><span class="s2">&#39; is unknown&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span></div>

	<span class="k">def</span> <span class="nf">_reconstructGlyf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Return recostructed glyf table data, and set the corresponding loca&#39;s</span>
<span class="sd">		locations. Optionally pad glyph offsets to the specified number of bytes.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;loca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WOFF2LocaTable</span><span class="p">()</span>
		<span class="n">glyfTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;glyf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WOFF2GlyfTable</span><span class="p">()</span>
		<span class="n">glyfTable</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
			<span class="n">glyfTable</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">glyfTable</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span>

	<span class="k">def</span> <span class="nf">_reconstructLoca</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Return reconstructed loca table data. &quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="s1">&#39;loca&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">:</span>
			<span class="c1"># make sure glyf is reconstructed first</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;glyf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconstructTable</span><span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">)</span>
		<span class="n">locaTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;loca&#39;</span><span class="p">]</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">locaTable</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;loca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">origLength</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
				<span class="s2">&quot;reconstructed &#39;loca&#39; table doesn&#39;t match original size: &quot;</span>
				<span class="s2">&quot;expected </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span>
				<span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;loca&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">origLength</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">data</span>

	<span class="k">def</span> <span class="nf">_reconstructHmtx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Return reconstructed hmtx table data. &quot;&quot;&quot;</span>
		<span class="c1"># Before reconstructing &#39;hmtx&#39; table we need to parse other tables:</span>
		<span class="c1"># &#39;glyf&#39; is required for reconstructing the sidebearings from the glyphs&#39;</span>
		<span class="c1"># bounding box; &#39;hhea&#39; is needed for the numberOfHMetrics field.</span>
		<span class="k">if</span> <span class="s2">&quot;glyf&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span><span class="o">.</span><span class="n">transformedTables</span><span class="p">:</span>
			<span class="c1"># transformed &#39;glyf&#39; table is self-contained, thus &#39;loca&#39; not needed</span>
			<span class="n">tableDependencies</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;maxp&quot;</span><span class="p">,</span> <span class="s2">&quot;hhea&quot;</span><span class="p">,</span> <span class="s2">&quot;glyf&quot;</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># decompiling untransformed &#39;glyf&#39; requires &#39;loca&#39;, which requires &#39;head&#39;</span>
			<span class="n">tableDependencies</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;maxp&quot;</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="s2">&quot;hhea&quot;</span><span class="p">,</span> <span class="s2">&quot;loca&quot;</span><span class="p">,</span> <span class="s2">&quot;glyf&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tableDependencies</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_decompileTable</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="n">hmtxTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s2">&quot;hmtx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WOFF2HmtxTable</span><span class="p">()</span>
		<span class="n">hmtxTable</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">hmtxTable</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span>

	<span class="k">def</span> <span class="nf">_decompileTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Decompile table data and store it inside self.ttFont.&quot;&quot;&quot;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="o">.</span><span class="n">isLoaded</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
		<span class="n">tableClass</span> <span class="o">=</span> <span class="n">getTableClass</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">tableClass</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>
		<span class="n">table</span><span class="o">.</span><span class="n">decompile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span></div>


<div class="viewcode-block" id="WOFF2Writer"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2Writer">[docs]</a><span class="k">class</span> <span class="nc">WOFF2Writer</span><span class="p">(</span><span class="n">SFNTWriter</span><span class="p">):</span>

	<span class="n">flavor</span> <span class="o">=</span> <span class="s2">&quot;woff2&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">numTables</span><span class="p">,</span> <span class="n">sfntVersion</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\000\001\000\000</span><span class="s2">&quot;</span><span class="p">,</span>
		         <span class="n">flavor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flavorData</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">haveBrotli</span><span class="p">:</span>
			<span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
				<span class="s1">&#39;The WOFF2 encoder requires the Brotli Python extension, available at: &#39;</span>
				<span class="s1">&#39;https://github.com/google/brotli&#39;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;No module named brotli&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">numTables</span> <span class="o">=</span> <span class="n">numTables</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sfntVersion</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">sfntVersion</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span> <span class="o">=</span> <span class="n">WOFF2FlavorData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">flavorData</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">directoryFormat</span> <span class="o">=</span> <span class="n">woff2DirectoryFormat</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">directorySize</span> <span class="o">=</span> <span class="n">woff2DirectorySize</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">DirectoryEntry</span> <span class="o">=</span> <span class="n">WOFF2DirectoryEntry</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="s2">&quot;wOF2&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">nextTableOffset</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

		<span class="c1"># make empty TTFont to store data while normalising and transforming tables</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span> <span class="o">=</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">recalcBBoxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recalcTimestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Associate new entry named &#39;tag&#39; with raw table data.&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;cannot rewrite &#39;</span><span class="si">%s</span><span class="s2">&#39; table&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;DSIG&#39;</span><span class="p">:</span>
			<span class="c1"># always drop DSIG table, since the encoding process can invalidate it</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">numTables</span> <span class="o">-=</span> <span class="mi">1</span>
			<span class="k">return</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DirectoryEntry</span><span class="p">()</span>
		<span class="n">entry</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="n">entry</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">getKnownTagIndex</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
		<span class="c1"># WOFF2 table data are written to disk only on close(), after all tags</span>
		<span class="c1"># have been specified</span>
		<span class="n">entry</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>

<div class="viewcode-block" id="WOFF2Writer.close"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2Writer.close">[docs]</a>	<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; All tags must have been specified. Now write the table data and directory.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numTables</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;wrong number of tables; expected </span><span class="si">%d</span><span class="s2">, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numTables</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)))</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfntVersion</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00\x01\x00\x00</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
			<span class="n">isTrueType</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfntVersion</span> <span class="o">==</span> <span class="s2">&quot;OTTO&quot;</span><span class="p">:</span>
			<span class="n">isTrueType</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;Not a TrueType or OpenType font (bad sfntVersion)&quot;</span><span class="p">)</span>

		<span class="c1"># The WOFF2 spec no longer requires the glyph offsets to be 4-byte aligned.</span>
		<span class="c1"># However, the reference WOFF2 implementation still fails to reconstruct</span>
		<span class="c1"># &#39;unpadded&#39; glyf tables, therefore we need to &#39;normalise&#39; them.</span>
		<span class="c1"># See:</span>
		<span class="c1"># https://github.com/khaledhosny/ots/issues/60</span>
		<span class="c1"># https://github.com/google/woff2/issues/15</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="n">isTrueType</span>
			<span class="ow">and</span> <span class="s2">&quot;glyf&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span><span class="o">.</span><span class="n">transformedTables</span>
			<span class="ow">and</span> <span class="s2">&quot;glyf&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>
		<span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_normaliseGlyfAndLoca</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_setHeadTransformFlag</span><span class="p">()</span>

		<span class="c1"># To pass the legacy OpenType Sanitiser currently included in browsers,</span>
		<span class="c1"># we must sort the table directory and data alphabetically by tag.</span>
		<span class="c1"># See:</span>
		<span class="c1"># https://github.com/google/woff2/pull/3</span>
		<span class="c1"># https://lists.w3.org/Archives/Public/public-webfonts-wg/2015Mar/0000.html</span>
		<span class="c1"># TODO(user): remove to match spec once browsers are on newer OTS</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">totalSfntSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calcSFNTChecksumsLengthsAndOffsets</span><span class="p">()</span>

		<span class="n">fontData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformTables</span><span class="p">()</span>
		<span class="n">compressedFont</span> <span class="o">=</span> <span class="n">brotli</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">fontData</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">brotli</span><span class="o">.</span><span class="n">MODE_FONT</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">totalCompressedSize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressedFont</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calcTotalSize</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">majorVersion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minorVersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getVersion</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span>

		<span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_packTableDirectory</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pad</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="n">compressedFont</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_writeFlavorData</span><span class="p">()</span></div>

	<span class="k">def</span> <span class="nf">_normaliseGlyfAndLoca</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Recompile glyf and loca tables, aligning glyph offsets to multiples of</span>
<span class="sd">		&#39;padding&#39; size. Update the head table&#39;s &#39;indexToLocFormat&#39; accordingly while</span>
<span class="sd">		compiling loca.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sfntVersion</span> <span class="o">==</span> <span class="s2">&quot;OTTO&quot;</span><span class="p">:</span>
			<span class="k">return</span>

		<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;maxp&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;loca&#39;</span><span class="p">,</span> <span class="s1">&#39;glyf&#39;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_decompileTable</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;glyf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span>
		<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">,</span> <span class="s1">&#39;loca&#39;</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_compileTable</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_setHeadTransformFlag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Set bit 11 of &#39;head&#39; table flags to indicate that the font has undergone</span>
<span class="sd">		a lossless modifying transform. Re-compile head table data.&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_decompileTable</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_compileTable</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_decompileTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Fetch table data, decompile it, and store it inside self.ttFont. &quot;&quot;&quot;</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;missing required table: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="o">.</span><span class="n">isLoaded</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
			<span class="k">return</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
		<span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;loca&#39;</span><span class="p">:</span>
			<span class="n">tableClass</span> <span class="o">=</span> <span class="n">WOFF2LocaTable</span>
		<span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;glyf&#39;</span><span class="p">:</span>
			<span class="n">tableClass</span> <span class="o">=</span> <span class="n">WOFF2GlyfTable</span>
		<span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;hmtx&#39;</span><span class="p">:</span>
			<span class="n">tableClass</span> <span class="o">=</span> <span class="n">WOFF2HmtxTable</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">tableClass</span> <span class="o">=</span> <span class="n">getTableClass</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">tableClass</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span>
		<span class="n">table</span><span class="o">.</span><span class="n">decompile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_compileTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Compile table and store it in its &#39;data&#39; attribute. &quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_calcSFNTChecksumsLengthsAndOffsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Compute the &#39;original&#39; SFNT checksums, lengths and offsets for checksum</span>
<span class="sd">		adjustment calculation. Return the total size of the uncompressed font.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">sfntDirectorySize</span> <span class="o">+</span> <span class="n">sfntDirectoryEntrySize</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span>
			<span class="n">entry</span><span class="o">.</span><span class="n">origOffset</span> <span class="o">=</span> <span class="n">offset</span>
			<span class="n">entry</span><span class="o">.</span><span class="n">origLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;head&#39;</span><span class="p">:</span>
				<span class="n">entry</span><span class="o">.</span><span class="n">checkSum</span> <span class="o">=</span> <span class="n">calcChecksum</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\0\0\0\0</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">:])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">entry</span><span class="o">.</span><span class="n">checkSum</span> <span class="o">=</span> <span class="n">calcChecksum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">origLength</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span>
		<span class="k">return</span> <span class="n">offset</span>

	<span class="k">def</span> <span class="nf">_transformTables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Return transformed font data.&quot;&quot;&quot;</span>
		<span class="n">transformedTables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span><span class="o">.</span><span class="n">transformedTables</span>
		<span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">transformedTables</span><span class="p">:</span>
				<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformTable</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">entry</span><span class="o">.</span><span class="n">transformed</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="c1"># pass-through the table data without transformation</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">data</span>
				<span class="n">entry</span><span class="o">.</span><span class="n">transformed</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="n">entry</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nextTableOffset</span>
			<span class="n">entry</span><span class="o">.</span><span class="n">saveData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nextTableOffset</span> <span class="o">+=</span> <span class="n">entry</span><span class="o">.</span><span class="n">length</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">writeMasterChecksum</span><span class="p">()</span>
		<span class="n">fontData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">fontData</span>

<div class="viewcode-block" id="WOFF2Writer.transformTable"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2Writer.transformTable">[docs]</a>	<span class="k">def</span> <span class="nf">transformTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Return transformed table data, or None if some pre-conditions aren&#39;t</span>
<span class="sd">		met -- in which case, the non-transformed table data will be used.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;loca&quot;</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
		<span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;glyf&quot;</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;maxp&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;loca&#39;</span><span class="p">,</span> <span class="s1">&#39;glyf&#39;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_decompileTable</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
			<span class="n">glyfTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;glyf&#39;</span><span class="p">]</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">glyfTable</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;hmtx&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="s2">&quot;glyf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;maxp&quot;</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="s2">&quot;hhea&quot;</span><span class="p">,</span> <span class="s2">&quot;loca&quot;</span><span class="p">,</span> <span class="s2">&quot;glyf&quot;</span><span class="p">,</span> <span class="s2">&quot;hmtx&quot;</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_decompileTable</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
			<span class="n">hmtxTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">[</span><span class="s2">&quot;hmtx&quot;</span><span class="p">]</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">hmtxTable</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ttFont</span><span class="p">)</span>  <span class="c1"># can be None</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;Transform for table &#39;</span><span class="si">%s</span><span class="s2">&#39; is unknown&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span></div>

	<span class="k">def</span> <span class="nf">_calcMasterChecksum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Calculate checkSumAdjustment.&quot;&quot;&quot;</span>
		<span class="n">tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
		<span class="n">checksums</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tags</span><span class="p">)):</span>
			<span class="n">checksums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tags</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">checkSum</span><span class="p">)</span>

		<span class="c1"># Create a SFNT directory for checksum calculation purposes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">searchRange</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrySelector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rangeShift</span> <span class="o">=</span> <span class="n">getSearchRange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numTables</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">directory</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">sfntDirectoryFormat</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="n">tables</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
		<span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
			<span class="n">sfntEntry</span> <span class="o">=</span> <span class="n">SFNTDirectoryEntry</span><span class="p">()</span>
			<span class="n">sfntEntry</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">tag</span>
			<span class="n">sfntEntry</span><span class="o">.</span><span class="n">checkSum</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">checkSum</span>
			<span class="n">sfntEntry</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">origOffset</span>
			<span class="n">sfntEntry</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">origLength</span>
			<span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">sfntEntry</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

		<span class="n">directory_end</span> <span class="o">=</span> <span class="n">sfntDirectorySize</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span> <span class="o">*</span> <span class="n">sfntDirectoryEntrySize</span>
		<span class="k">assert</span> <span class="n">directory_end</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

		<span class="n">checksums</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calcChecksum</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
		<span class="n">checksum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">checksums</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
		<span class="c1"># BiboAfba!</span>
		<span class="n">checksumadjustment</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xB1B0AFBA</span> <span class="o">-</span> <span class="n">checksum</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
		<span class="k">return</span> <span class="n">checksumadjustment</span>

<div class="viewcode-block" id="WOFF2Writer.writeMasterChecksum"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2Writer.writeMasterChecksum">[docs]</a>	<span class="k">def</span> <span class="nf">writeMasterChecksum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Write checkSumAdjustment to the transformBuffer.&quot;&quot;&quot;</span>
		<span class="n">checksumadjustment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calcMasterChecksum</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">transformBuffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;L&quot;</span><span class="p">,</span> <span class="n">checksumadjustment</span><span class="p">))</span></div>

	<span class="k">def</span> <span class="nf">_calcTotalSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Calculate total size of WOFF2 font, including any meta- and/or private data.&quot;&quot;&quot;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directorySize</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">toString</span><span class="p">())</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totalCompressedSize</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calcFlavorDataOffsetsAndSize</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">offset</span>

	<span class="k">def</span> <span class="nf">_calcFlavorDataOffsetsAndSize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Calculate offsets and lengths for any meta- and/or private data.&quot;&quot;&quot;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">start</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span>
		<span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">metaData</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metaOrigLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">metaData</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metaOffset</span> <span class="o">=</span> <span class="n">offset</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">compressedMetaData</span> <span class="o">=</span> <span class="n">brotli</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span>
				<span class="n">data</span><span class="o">.</span><span class="n">metaData</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">brotli</span><span class="o">.</span><span class="n">MODE_TEXT</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metaLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compressedMetaData</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaLength</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metaOffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaLength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaOrigLength</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">compressedMetaData</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
		<span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">privData</span><span class="p">:</span>
			<span class="c1"># make sure private data is padded to 4-byte boundary</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">privOffset</span> <span class="o">=</span> <span class="n">offset</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">privLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">privData</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">privLength</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">privOffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">privLength</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">return</span> <span class="n">offset</span>

	<span class="k">def</span> <span class="nf">_getVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Return the WOFF2 font&#39;s (majorVersion, minorVersion) tuple.&quot;&quot;&quot;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span>
		<span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">majorVersion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">minorVersion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">majorVersion</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">minorVersion</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># if None, return &#39;fontRevision&#39; from &#39;head&#39; table</span>
			<span class="k">if</span> <span class="s1">&#39;head&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;HH&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

	<span class="k">def</span> <span class="nf">_packTableDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Return WOFF2 table directory data.&quot;&quot;&quot;</span>
		<span class="n">directory</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directoryFormat</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
			<span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">directory</span>

	<span class="k">def</span> <span class="nf">_writeFlavorData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Write metadata and/or private data using appropiate padding.&quot;&quot;&quot;</span>
		<span class="n">compressedMetaData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compressedMetaData</span>
		<span class="n">privData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flavorData</span><span class="o">.</span><span class="n">privData</span>
		<span class="k">if</span> <span class="n">compressedMetaData</span> <span class="ow">and</span> <span class="n">privData</span><span class="p">:</span>
			<span class="n">compressedMetaData</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">compressedMetaData</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">compressedMetaData</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metaOffset</span><span class="p">)</span>
			<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">metaOffset</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">compressedMetaData</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">privData</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">privOffset</span><span class="p">)</span>
			<span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">privOffset</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">privData</span><span class="p">)</span>

<div class="viewcode-block" id="WOFF2Writer.reordersTables"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2Writer.reordersTables">[docs]</a>	<span class="k">def</span> <span class="nf">reordersTables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="kc">True</span></div></div>


<span class="c1"># -- woff2 directory helpers and cruft</span>

<span class="n">woff2DirectoryFormat</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">		&gt; # big endian</span>
<span class="s2">		signature:           4s   # &quot;wOF2&quot;</span>
<span class="s2">		sfntVersion:         4s</span>
<span class="s2">		length:              L    # total woff2 file size</span>
<span class="s2">		numTables:           H    # number of tables</span>
<span class="s2">		reserved:            H    # set to 0</span>
<span class="s2">		totalSfntSize:       L    # uncompressed size</span>
<span class="s2">		totalCompressedSize: L    # compressed size</span>
<span class="s2">		majorVersion:        H    # major version of WOFF file</span>
<span class="s2">		minorVersion:        H    # minor version of WOFF file</span>
<span class="s2">		metaOffset:          L    # offset to metadata block</span>
<span class="s2">		metaLength:          L    # length of compressed metadata</span>
<span class="s2">		metaOrigLength:      L    # length of uncompressed metadata</span>
<span class="s2">		privOffset:          L    # offset to private data block</span>
<span class="s2">		privLength:          L    # length of private data block</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">woff2DirectorySize</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">woff2DirectoryFormat</span><span class="p">)</span>

<span class="n">woff2KnownTags</span> <span class="o">=</span> <span class="p">(</span>
	<span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="s2">&quot;head&quot;</span><span class="p">,</span> <span class="s2">&quot;hhea&quot;</span><span class="p">,</span> <span class="s2">&quot;hmtx&quot;</span><span class="p">,</span> <span class="s2">&quot;maxp&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;OS/2&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;cvt &quot;</span><span class="p">,</span>
	<span class="s2">&quot;fpgm&quot;</span><span class="p">,</span> <span class="s2">&quot;glyf&quot;</span><span class="p">,</span> <span class="s2">&quot;loca&quot;</span><span class="p">,</span> <span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="s2">&quot;CFF &quot;</span><span class="p">,</span> <span class="s2">&quot;VORG&quot;</span><span class="p">,</span> <span class="s2">&quot;EBDT&quot;</span><span class="p">,</span> <span class="s2">&quot;EBLC&quot;</span><span class="p">,</span> <span class="s2">&quot;gasp&quot;</span><span class="p">,</span>
	<span class="s2">&quot;hdmx&quot;</span><span class="p">,</span> <span class="s2">&quot;kern&quot;</span><span class="p">,</span> <span class="s2">&quot;LTSH&quot;</span><span class="p">,</span> <span class="s2">&quot;PCLT&quot;</span><span class="p">,</span> <span class="s2">&quot;VDMX&quot;</span><span class="p">,</span> <span class="s2">&quot;vhea&quot;</span><span class="p">,</span> <span class="s2">&quot;vmtx&quot;</span><span class="p">,</span> <span class="s2">&quot;BASE&quot;</span><span class="p">,</span> <span class="s2">&quot;GDEF&quot;</span><span class="p">,</span>
	<span class="s2">&quot;GPOS&quot;</span><span class="p">,</span> <span class="s2">&quot;GSUB&quot;</span><span class="p">,</span> <span class="s2">&quot;EBSC&quot;</span><span class="p">,</span> <span class="s2">&quot;JSTF&quot;</span><span class="p">,</span> <span class="s2">&quot;MATH&quot;</span><span class="p">,</span> <span class="s2">&quot;CBDT&quot;</span><span class="p">,</span> <span class="s2">&quot;CBLC&quot;</span><span class="p">,</span> <span class="s2">&quot;COLR&quot;</span><span class="p">,</span> <span class="s2">&quot;CPAL&quot;</span><span class="p">,</span>
	<span class="s2">&quot;SVG &quot;</span><span class="p">,</span> <span class="s2">&quot;sbix&quot;</span><span class="p">,</span> <span class="s2">&quot;acnt&quot;</span><span class="p">,</span> <span class="s2">&quot;avar&quot;</span><span class="p">,</span> <span class="s2">&quot;bdat&quot;</span><span class="p">,</span> <span class="s2">&quot;bloc&quot;</span><span class="p">,</span> <span class="s2">&quot;bsln&quot;</span><span class="p">,</span> <span class="s2">&quot;cvar&quot;</span><span class="p">,</span> <span class="s2">&quot;fdsc&quot;</span><span class="p">,</span>
	<span class="s2">&quot;feat&quot;</span><span class="p">,</span> <span class="s2">&quot;fmtx&quot;</span><span class="p">,</span> <span class="s2">&quot;fvar&quot;</span><span class="p">,</span> <span class="s2">&quot;gvar&quot;</span><span class="p">,</span> <span class="s2">&quot;hsty&quot;</span><span class="p">,</span> <span class="s2">&quot;just&quot;</span><span class="p">,</span> <span class="s2">&quot;lcar&quot;</span><span class="p">,</span> <span class="s2">&quot;mort&quot;</span><span class="p">,</span> <span class="s2">&quot;morx&quot;</span><span class="p">,</span>
	<span class="s2">&quot;opbd&quot;</span><span class="p">,</span> <span class="s2">&quot;prop&quot;</span><span class="p">,</span> <span class="s2">&quot;trak&quot;</span><span class="p">,</span> <span class="s2">&quot;Zapf&quot;</span><span class="p">,</span> <span class="s2">&quot;Silf&quot;</span><span class="p">,</span> <span class="s2">&quot;Glat&quot;</span><span class="p">,</span> <span class="s2">&quot;Gloc&quot;</span><span class="p">,</span> <span class="s2">&quot;Feat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sill&quot;</span><span class="p">)</span>

<span class="n">woff2FlagsFormat</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">		&gt; # big endian</span>
<span class="s2">		flags: B  # table type and flags</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">woff2FlagsSize</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">woff2FlagsFormat</span><span class="p">)</span>

<span class="n">woff2UnknownTagFormat</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">		&gt; # big endian</span>
<span class="s2">		tag: 4s  # 4-byte tag (optional)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">woff2UnknownTagSize</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">woff2UnknownTagFormat</span><span class="p">)</span>

<span class="n">woff2UnknownTagIndex</span> <span class="o">=</span> <span class="mh">0x3F</span>

<span class="n">woff2Base128MaxSize</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">woff2DirectoryEntryMaxSize</span> <span class="o">=</span> <span class="n">woff2FlagsSize</span> <span class="o">+</span> <span class="n">woff2UnknownTagSize</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">woff2Base128MaxSize</span>

<span class="n">woff2TransformedTableTags</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">,</span> <span class="s1">&#39;loca&#39;</span><span class="p">)</span>

<span class="n">woff2GlyfTableFormat</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">		&gt; # big endian</span>
<span class="s2">		version:                  L  # = 0x00000000</span>
<span class="s2">		numGlyphs:                H  # Number of glyphs</span>
<span class="s2">		indexFormat:              H  # Offset format for loca table</span>
<span class="s2">		nContourStreamSize:       L  # Size of nContour stream</span>
<span class="s2">		nPointsStreamSize:        L  # Size of nPoints stream</span>
<span class="s2">		flagStreamSize:           L  # Size of flag stream</span>
<span class="s2">		glyphStreamSize:          L  # Size of glyph stream</span>
<span class="s2">		compositeStreamSize:      L  # Size of composite stream</span>
<span class="s2">		bboxStreamSize:           L  # Comnined size of bboxBitmap and bboxStream</span>
<span class="s2">		instructionStreamSize:    L  # Size of instruction stream</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">woff2GlyfTableFormatSize</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">woff2GlyfTableFormat</span><span class="p">)</span>

<span class="n">bboxFormat</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">		&gt;	# big endian</span>
<span class="s2">		xMin:				h</span>
<span class="s2">		yMin:				h</span>
<span class="s2">		xMax:				h</span>
<span class="s2">		yMax:				h</span>
<span class="s2">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="getKnownTagIndex"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.getKnownTagIndex">[docs]</a><span class="k">def</span> <span class="nf">getKnownTagIndex</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Return index of &#39;tag&#39; in woff2KnownTags list. Return 63 if not found.&quot;&quot;&quot;</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">woff2KnownTags</span><span class="p">)):</span>
		<span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="n">woff2KnownTags</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
			<span class="k">return</span> <span class="n">i</span>
	<span class="k">return</span> <span class="n">woff2UnknownTagIndex</span></div>


<div class="viewcode-block" id="WOFF2DirectoryEntry"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2DirectoryEntry">[docs]</a><span class="k">class</span> <span class="nc">WOFF2DirectoryEntry</span><span class="p">(</span><span class="n">DirectoryEntry</span><span class="p">):</span>

<div class="viewcode-block" id="WOFF2DirectoryEntry.fromFile"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2DirectoryEntry.fromFile">[docs]</a>	<span class="k">def</span> <span class="nf">fromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">woff2DirectoryEntryMaxSize</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fromString</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">consumed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
		<span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">consumed</span><span class="p">)</span></div>

<div class="viewcode-block" id="WOFF2DirectoryEntry.fromString"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2DirectoryEntry.fromString">[docs]</a>	<span class="k">def</span> <span class="nf">fromString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;can&#39;t read table &#39;flags&#39;: not enough data&quot;</span><span class="p">)</span>
		<span class="n">dummy</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">unpack2</span><span class="p">(</span><span class="n">woff2FlagsFormat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x3F</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">:</span>
			<span class="c1"># if bits [0..5] of the flags byte == 63, read a 4-byte arbitrary tag value</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">woff2UnknownTagSize</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;can&#39;t read table &#39;tag&#39;: not enough data&quot;</span><span class="p">)</span>
			<span class="n">dummy</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">unpack2</span><span class="p">(</span><span class="n">woff2UnknownTagFormat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># otherwise, tag is derived from a fixed &#39;Known Tags&#39; table</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">woff2KnownTags</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">origLength</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">unpackBase128</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origLength</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformed</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">unpackBase128</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;loca&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
					<span class="s2">&quot;the transformLength of the &#39;loca&#39; table must be 0&quot;</span><span class="p">)</span>
		<span class="c1"># return left over data</span>
		<span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="WOFF2DirectoryEntry.toString"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2DirectoryEntry.toString">[docs]</a>	<span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">bytechr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;4s&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">packBase128</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origLength</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformed</span><span class="p">:</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">packBase128</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span></div>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">transformVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Return bits 6-7 of table entry&#39;s flags, which indicate the preprocessing</span>
<span class="sd">		transformation version number (between 0 and 3).</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span>

	<span class="nd">@transformVersion</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">transformVersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
		<span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">3</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">transformed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Return True if the table has any transformation, else return False.&quot;&quot;&quot;</span>
		<span class="c1"># For all tables in a font, except for &#39;glyf&#39; and &#39;loca&#39;, the transformation</span>
		<span class="c1"># version 0 indicates the null transform (where the original table data is</span>
		<span class="c1"># passed directly to the Brotli compressor). For &#39;glyf&#39; and &#39;loca&#39; tables,</span>
		<span class="c1"># transformation version 3 indicates the null transform</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;glyf&quot;</span><span class="p">,</span> <span class="s2">&quot;loca&quot;</span><span class="p">}:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformVersion</span> <span class="o">!=</span> <span class="mi">3</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformVersion</span> <span class="o">!=</span> <span class="mi">0</span>

	<span class="nd">@transformed</span><span class="o">.</span><span class="n">setter</span>
	<span class="k">def</span> <span class="nf">transformed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">booleanValue</span><span class="p">):</span>
		<span class="c1"># here we assume that a non-null transform means version 0 for &#39;glyf&#39; and</span>
		<span class="c1"># &#39;loca&#39; and 1 for every other table (e.g. hmtx); but that may change as</span>
		<span class="c1"># new transformation formats are introduced in the future (if ever).</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;glyf&quot;</span><span class="p">,</span> <span class="s2">&quot;loca&quot;</span><span class="p">}:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">transformVersion</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">booleanValue</span> <span class="k">else</span> <span class="mi">0</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">transformVersion</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">booleanValue</span><span class="p">)</span></div>


<div class="viewcode-block" id="WOFF2LocaTable"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2LocaTable">[docs]</a><span class="k">class</span> <span class="nc">WOFF2LocaTable</span><span class="p">(</span><span class="n">getTableClass</span><span class="p">(</span><span class="s1">&#39;loca&#39;</span><span class="p">)):</span>
	<span class="sd">&quot;&quot;&quot;Same as parent class. The only difference is that it attempts to preserve</span>
<span class="sd">	the &#39;indexFormat&#39; as encoded in the WOFF2 glyf table.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tableTag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">tag</span> <span class="ow">or</span> <span class="s1">&#39;loca&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="WOFF2LocaTable.compile"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2LocaTable.compile">[docs]</a>	<span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ttFont</span><span class="p">):</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">max_location</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">([])</span>
			<span class="n">max_location</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">if</span> <span class="s1">&#39;glyf&#39;</span> <span class="ow">in</span> <span class="n">ttFont</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;glyf&#39;</span><span class="p">],</span> <span class="s1">&#39;indexFormat&#39;</span><span class="p">):</span>
			<span class="c1"># copile loca using the indexFormat specified in the WOFF2 glyf table</span>
			<span class="n">indexFormat</span> <span class="o">=</span> <span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;glyf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">indexFormat</span>
			<span class="k">if</span> <span class="n">indexFormat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">max_location</span> <span class="o">&gt;=</span> <span class="mh">0x20000</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;indexFormat is 0 but local offsets &gt; 0x20000&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">l</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">):</span>
					<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;indexFormat is 0 but local offsets not multiples of 2&quot;</span><span class="p">)</span>
				<span class="n">locations</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)):</span>
					<span class="n">locations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">locations</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span> <span class="n">locations</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">locations</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># use the most compact indexFormat given the current glyph offsets</span>
			<span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">WOFF2LocaTable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">ttFont</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">data</span></div></div>


<div class="viewcode-block" id="WOFF2GlyfTable"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2GlyfTable">[docs]</a><span class="k">class</span> <span class="nc">WOFF2GlyfTable</span><span class="p">(</span><span class="n">getTableClass</span><span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">)):</span>
	<span class="sd">&quot;&quot;&quot;Decoder/Encoder for WOFF2 &#39;glyf&#39; table transform.&quot;&quot;&quot;</span>

	<span class="n">subStreams</span> <span class="o">=</span> <span class="p">(</span>
		<span class="s1">&#39;nContourStream&#39;</span><span class="p">,</span> <span class="s1">&#39;nPointsStream&#39;</span><span class="p">,</span> <span class="s1">&#39;flagStream&#39;</span><span class="p">,</span> <span class="s1">&#39;glyphStream&#39;</span><span class="p">,</span>
		<span class="s1">&#39;compositeStream&#39;</span><span class="p">,</span> <span class="s1">&#39;bboxStream&#39;</span><span class="p">,</span> <span class="s1">&#39;instructionStream&#39;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tableTag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">tag</span> <span class="ow">or</span> <span class="s1">&#39;glyf&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="WOFF2GlyfTable.reconstruct"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2GlyfTable.reconstruct">[docs]</a>	<span class="k">def</span> <span class="nf">reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ttFont</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Decompile transformed &#39;glyf&#39; data. &quot;&quot;&quot;</span>
		<span class="n">inputDataSize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">inputDataSize</span> <span class="o">&lt;</span> <span class="n">woff2GlyfTableFormatSize</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;not enough &#39;glyf&#39; data&quot;</span><span class="p">)</span>
		<span class="n">dummy</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">unpack2</span><span class="p">(</span><span class="n">woff2GlyfTableFormat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">woff2GlyfTableFormatSize</span>

		<span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subStreams</span><span class="p">:</span>
			<span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span> <span class="o">+</span> <span class="s1">&#39;Size&#39;</span><span class="p">)</span>
			<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span>

		<span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="n">inputDataSize</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
				<span class="s2">&quot;incorrect size of transformed &#39;glyf&#39; table: expected </span><span class="si">%d</span><span class="s2">, received </span><span class="si">%d</span><span class="s2"> bytes&quot;</span>
				<span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">inputDataSize</span><span class="p">))</span>

		<span class="n">bboxBitmapSize</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
		<span class="n">bboxBitmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span><span class="p">[:</span><span class="n">bboxBitmapSize</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bboxBitmap</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">bboxBitmap</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span><span class="p">[</span><span class="n">bboxBitmapSize</span><span class="p">:]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">nContourStream</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nContourStream</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nContourStream</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
		<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nContourStream</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span>

		<span class="k">if</span> <span class="s1">&#39;head&#39;</span> <span class="ow">in</span> <span class="n">ttFont</span><span class="p">:</span>
			<span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">indexToLocFormat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexFormat</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span> <span class="o">=</span> <span class="n">ttFont</span><span class="o">.</span><span class="n">getGlyphOrder</span><span class="p">()</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.notdef&quot;</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;glyph</span><span class="si">%.5d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span><span class="p">)])</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
					<span class="s2">&quot;incorrect glyphOrder: expected </span><span class="si">%d</span><span class="s2"> glyphs, found </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
					<span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span><span class="p">))</span>

		<span class="n">glyphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">glyphID</span><span class="p">,</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span><span class="p">):</span>
			<span class="n">glyph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decodeGlyph</span><span class="p">(</span><span class="n">glyphID</span><span class="p">)</span>
			<span class="n">glyphs</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">glyph</span></div>

<div class="viewcode-block" id="WOFF2GlyfTable.transform"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2GlyfTable.transform">[docs]</a>	<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ttFont</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Return transformed &#39;glyf&#39; data &quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphs</span><span class="p">)</span>
		<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphOrder</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span>
		<span class="k">if</span> <span class="s1">&#39;maxp&#39;</span> <span class="ow">in</span> <span class="n">ttFont</span><span class="p">:</span>
			<span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;maxp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">numGlyphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">indexFormat</span> <span class="o">=</span> <span class="n">ttFont</span><span class="p">[</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">indexToLocFormat</span>

		<span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subStreams</span><span class="p">:</span>
			<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
		<span class="n">bboxBitmapSize</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bboxBitmap</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">bboxBitmapSize</span><span class="p">)</span>

		<span class="k">for</span> <span class="n">glyphID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numGlyphs</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_encodeGlyph</span><span class="p">(</span><span class="n">glyphID</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bboxBitmap</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span>
		<span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subStreams</span><span class="p">:</span>
			<span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span> <span class="o">+</span> <span class="s1">&#39;Size&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">)))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">woff2GlyfTableFormat</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">bytesjoin</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subStreams</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">data</span></div>

	<span class="k">def</span> <span class="nf">_decodeGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphID</span><span class="p">):</span>
		<span class="n">glyph</span> <span class="o">=</span> <span class="n">getTableModule</span><span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Glyph</span><span class="p">()</span>
		<span class="n">glyph</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nContourStream</span><span class="p">[</span><span class="n">glyphID</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">glyph</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">glyph</span>
		<span class="k">elif</span> <span class="n">glyph</span><span class="o">.</span><span class="n">isComposite</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_decodeComponents</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_decodeCoordinates</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_decodeBBox</span><span class="p">(</span><span class="n">glyphID</span><span class="p">,</span> <span class="n">glyph</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">glyph</span>

	<span class="k">def</span> <span class="nf">_decodeComponents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compositeStream</span>
		<span class="n">glyph</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">haveInstructions</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">while</span> <span class="n">more</span><span class="p">:</span>
			<span class="n">component</span> <span class="o">=</span> <span class="n">getTableModule</span><span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">GlyphComponent</span><span class="p">()</span>
			<span class="n">more</span><span class="p">,</span> <span class="n">haveInstr</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">decompile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
			<span class="n">haveInstructions</span> <span class="o">=</span> <span class="n">haveInstructions</span> <span class="o">|</span> <span class="n">haveInstr</span>
			<span class="n">glyph</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">compositeStream</span> <span class="o">=</span> <span class="n">data</span>
		<span class="k">if</span> <span class="n">haveInstructions</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_decodeInstructions</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_decodeCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nPointsStream</span>
		<span class="n">endPtsOfContours</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">endPoint</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">numberOfContours</span><span class="p">):</span>
			<span class="n">ptsOfContour</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">unpack255UShort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">endPoint</span> <span class="o">+=</span> <span class="n">ptsOfContour</span>
			<span class="n">endPtsOfContours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">endPoint</span><span class="p">)</span>
		<span class="n">glyph</span><span class="o">.</span><span class="n">endPtsOfContours</span> <span class="o">=</span> <span class="n">endPtsOfContours</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nPointsStream</span> <span class="o">=</span> <span class="n">data</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_decodeTriplets</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_decodeInstructions</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_decodeInstructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="n">glyphStream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphStream</span>
		<span class="n">instructionStream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instructionStream</span>
		<span class="n">instructionLength</span><span class="p">,</span> <span class="n">glyphStream</span> <span class="o">=</span> <span class="n">unpack255UShort</span><span class="p">(</span><span class="n">glyphStream</span><span class="p">)</span>
		<span class="n">glyph</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">ttProgram</span><span class="o">.</span><span class="n">Program</span><span class="p">()</span>
		<span class="n">glyph</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">fromBytecode</span><span class="p">(</span><span class="n">instructionStream</span><span class="p">[:</span><span class="n">instructionLength</span><span class="p">])</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphStream</span> <span class="o">=</span> <span class="n">glyphStream</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">instructionStream</span> <span class="o">=</span> <span class="n">instructionStream</span><span class="p">[</span><span class="n">instructionLength</span><span class="p">:]</span>

	<span class="k">def</span> <span class="nf">_decodeBBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphID</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="n">haveBBox</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bboxBitmap</span><span class="p">[</span><span class="n">glyphID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">glyphID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
		<span class="k">if</span> <span class="n">glyph</span><span class="o">.</span><span class="n">isComposite</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">haveBBox</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;no bbox values for composite glyph </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">glyphID</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">haveBBox</span><span class="p">:</span>
			<span class="n">dummy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span> <span class="o">=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">unpack2</span><span class="p">(</span><span class="n">bboxFormat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span><span class="p">,</span> <span class="n">glyph</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">glyph</span><span class="o">.</span><span class="n">recalcBounds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_decodeTriplets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>

		<span class="k">def</span> <span class="nf">withSign</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">baseval</span><span class="p">):</span>
			<span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">baseval</span> <span class="ow">and</span> <span class="n">baseval</span> <span class="o">&lt;</span> <span class="mi">65536</span><span class="p">,</span> <span class="s1">&#39;integer overflow&#39;</span>
			<span class="k">return</span> <span class="n">baseval</span> <span class="k">if</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="n">baseval</span>

		<span class="n">nPoints</span> <span class="o">=</span> <span class="n">glyph</span><span class="o">.</span><span class="n">endPtsOfContours</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="n">flagSize</span> <span class="o">=</span> <span class="n">nPoints</span>
		<span class="k">if</span> <span class="n">flagSize</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flagStream</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;not enough &#39;flagStream&#39; data&quot;</span><span class="p">)</span>
		<span class="n">flagsData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagStream</span><span class="p">[:</span><span class="n">flagSize</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">flagStream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flagStream</span><span class="p">[</span><span class="n">flagSize</span><span class="p">:]</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">flagsData</span><span class="p">)</span>

		<span class="n">triplets</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphStream</span><span class="p">)</span>
		<span class="n">nTriplets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triplets</span><span class="p">)</span>
		<span class="k">assert</span> <span class="n">nPoints</span> <span class="o">&lt;=</span> <span class="n">nTriplets</span>

		<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">glyph</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">getTableModule</span><span class="p">(</span><span class="s1">&#39;glyf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">GlyphCoordinates</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPoints</span><span class="p">)</span>
		<span class="n">glyph</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
		<span class="n">tripletIndex</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPoints</span><span class="p">):</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">onCurve</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">flag</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">flag</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span>
			<span class="k">if</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">84</span><span class="p">:</span>
				<span class="n">nBytes</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="k">elif</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">:</span>
				<span class="n">nBytes</span> <span class="o">=</span> <span class="mi">2</span>
			<span class="k">elif</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">124</span><span class="p">:</span>
				<span class="n">nBytes</span> <span class="o">=</span> <span class="mi">3</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">nBytes</span> <span class="o">=</span> <span class="mi">4</span>
			<span class="k">assert</span> <span class="p">((</span><span class="n">tripletIndex</span> <span class="o">+</span> <span class="n">nBytes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nTriplets</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
				<span class="n">dx</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="n">dy</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="p">((</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span><span class="p">])</span>
			<span class="k">elif</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
				<span class="n">dx</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="p">(((</span><span class="n">flag</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span><span class="p">])</span>
				<span class="n">dy</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">elif</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">84</span><span class="p">:</span>
				<span class="n">b0</span> <span class="o">=</span> <span class="n">flag</span> <span class="o">-</span> <span class="mi">20</span>
				<span class="n">b1</span> <span class="o">=</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span><span class="p">]</span>
				<span class="n">dx</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">b0</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span>
				<span class="n">dy</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">b0</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">))</span>
			<span class="k">elif</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">:</span>
				<span class="n">b0</span> <span class="o">=</span> <span class="n">flag</span> <span class="o">-</span> <span class="mi">84</span>
				<span class="n">dx</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">b0</span> <span class="o">//</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span><span class="p">])</span>
				<span class="n">dy</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					<span class="mi">1</span> <span class="o">+</span> <span class="p">(((</span><span class="n">b0</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
			<span class="k">elif</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="mi">124</span><span class="p">:</span>
				<span class="n">b2</span> <span class="o">=</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
				<span class="n">dx</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="p">(</span><span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span>
				<span class="n">dy</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					<span class="p">((</span><span class="n">b2</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">dx</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span>
					<span class="p">(</span><span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
				<span class="n">dy</span> <span class="o">=</span> <span class="n">withSign</span><span class="p">(</span><span class="n">flag</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					<span class="p">(</span><span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">triplets</span><span class="p">[</span><span class="n">tripletIndex</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span>
			<span class="n">tripletIndex</span> <span class="o">+=</span> <span class="n">nBytes</span>
			<span class="n">x</span> <span class="o">+=</span> <span class="n">dx</span>
			<span class="n">y</span> <span class="o">+=</span> <span class="n">dy</span>
			<span class="n">glyph</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
			<span class="n">glyph</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">onCurve</span><span class="p">))</span>
		<span class="n">bytesConsumed</span> <span class="o">=</span> <span class="n">tripletIndex</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphStream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphStream</span><span class="p">[</span><span class="n">bytesConsumed</span><span class="p">:]</span>

	<span class="k">def</span> <span class="nf">_encodeGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphID</span><span class="p">):</span>
		<span class="n">glyphName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGlyphName</span><span class="p">(</span><span class="n">glyphID</span><span class="p">)</span>
		<span class="n">glyph</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nContourStream</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;h&quot;</span><span class="p">,</span> <span class="n">glyph</span><span class="o">.</span><span class="n">numberOfContours</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">glyph</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="k">elif</span> <span class="n">glyph</span><span class="o">.</span><span class="n">isComposite</span><span class="p">():</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_encodeComponents</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_encodeCoordinates</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_encodeBBox</span><span class="p">(</span><span class="n">glyphID</span><span class="p">,</span> <span class="n">glyph</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_encodeComponents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="n">lastcomponent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">components</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">haveInstructions</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">components</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">lastcomponent</span><span class="p">:</span>
				<span class="n">haveInstructions</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">glyph</span><span class="p">,</span> <span class="s2">&quot;program&quot;</span><span class="p">)</span>
				<span class="n">more</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="n">component</span> <span class="o">=</span> <span class="n">glyph</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">compositeStream</span> <span class="o">+=</span> <span class="n">component</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">more</span><span class="p">,</span> <span class="n">haveInstructions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">haveInstructions</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_encodeInstructions</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_encodeCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="n">lastEndPoint</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
		<span class="k">for</span> <span class="n">endPoint</span> <span class="ow">in</span> <span class="n">glyph</span><span class="o">.</span><span class="n">endPtsOfContours</span><span class="p">:</span>
			<span class="n">ptsOfContour</span> <span class="o">=</span> <span class="n">endPoint</span> <span class="o">-</span> <span class="n">lastEndPoint</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">nPointsStream</span> <span class="o">+=</span> <span class="n">pack255UShort</span><span class="p">(</span><span class="n">ptsOfContour</span><span class="p">)</span>
			<span class="n">lastEndPoint</span> <span class="o">=</span> <span class="n">endPoint</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_encodeTriplets</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_encodeInstructions</span><span class="p">(</span><span class="n">glyph</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_encodeInstructions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="n">instructions</span> <span class="o">=</span> <span class="n">glyph</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">getBytecode</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphStream</span> <span class="o">+=</span> <span class="n">pack255UShort</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instructions</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">instructionStream</span> <span class="o">+=</span> <span class="n">instructions</span>

	<span class="k">def</span> <span class="nf">_encodeBBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphID</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="k">assert</span> <span class="n">glyph</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;empty glyph has no bbox&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">glyph</span><span class="o">.</span><span class="n">isComposite</span><span class="p">():</span>
			<span class="c1"># for simple glyphs, compare the encoded bounding box info with the calculated</span>
			<span class="c1"># values, and if they match omit the bounding box info</span>
			<span class="n">currentBBox</span> <span class="o">=</span> <span class="n">glyph</span><span class="o">.</span><span class="n">xMin</span><span class="p">,</span> <span class="n">glyph</span><span class="o">.</span><span class="n">yMin</span><span class="p">,</span> <span class="n">glyph</span><span class="o">.</span><span class="n">xMax</span><span class="p">,</span> <span class="n">glyph</span><span class="o">.</span><span class="n">yMax</span>
			<span class="n">calculatedBBox</span> <span class="o">=</span> <span class="n">calcIntBounds</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">currentBBox</span> <span class="o">==</span> <span class="n">calculatedBBox</span><span class="p">:</span>
				<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bboxBitmap</span><span class="p">[</span><span class="n">glyphID</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">glyphID</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bboxStream</span> <span class="o">+=</span> <span class="n">sstruct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">bboxFormat</span><span class="p">,</span> <span class="n">glyph</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_encodeTriplets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyph</span><span class="p">):</span>
		<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyph</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
		<span class="n">coordinates</span> <span class="o">=</span> <span class="n">glyph</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
		<span class="n">coordinates</span><span class="o">.</span><span class="n">absoluteToRelative</span><span class="p">()</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
		<span class="n">triplets</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)):</span>
			<span class="n">onCurve</span> <span class="o">=</span> <span class="n">glyph</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">absX</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
			<span class="n">absY</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
			<span class="n">onCurveBit</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">onCurve</span> <span class="k">else</span> <span class="mi">128</span>
			<span class="n">xSignBit</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
			<span class="n">ySignBit</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
			<span class="n">xySignBits</span> <span class="o">=</span> <span class="n">xSignBit</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ySignBit</span>

			<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">absY</span> <span class="o">&lt;</span> <span class="mi">1280</span><span class="p">:</span>
				<span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onCurveBit</span> <span class="o">+</span> <span class="p">((</span><span class="n">absY</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">ySignBit</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absY</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">absX</span> <span class="o">&lt;</span> <span class="mi">1280</span><span class="p">:</span>
				<span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onCurveBit</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="p">((</span><span class="n">absX</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">xSignBit</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absX</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">absX</span> <span class="o">&lt;</span> <span class="mi">65</span> <span class="ow">and</span> <span class="n">absY</span> <span class="o">&lt;</span> <span class="mi">65</span><span class="p">:</span>
				<span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onCurveBit</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">((</span><span class="n">absX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="n">absY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">xySignBits</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">((((</span><span class="n">absX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">absY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
			<span class="k">elif</span> <span class="n">absX</span> <span class="o">&lt;</span> <span class="mi">769</span> <span class="ow">and</span> <span class="n">absY</span> <span class="o">&lt;</span> <span class="mi">769</span><span class="p">:</span>
				<span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onCurveBit</span> <span class="o">+</span> <span class="mi">84</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="p">(((</span><span class="n">absX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(((</span><span class="n">absY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">xySignBits</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">absX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">absY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">absX</span> <span class="o">&lt;</span> <span class="mi">4096</span> <span class="ow">and</span> <span class="n">absY</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">:</span>
				<span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onCurveBit</span> <span class="o">+</span> <span class="mi">120</span> <span class="o">+</span> <span class="n">xySignBits</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absX</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">absX</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">absY</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">))</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absY</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onCurveBit</span> <span class="o">+</span> <span class="mi">124</span> <span class="o">+</span> <span class="n">xySignBits</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absX</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absX</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absY</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">triplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absY</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">flagStream</span> <span class="o">+=</span> <span class="n">flags</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphStream</span> <span class="o">+=</span> <span class="n">triplets</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span></div>


<div class="viewcode-block" id="WOFF2HmtxTable"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2HmtxTable">[docs]</a><span class="k">class</span> <span class="nc">WOFF2HmtxTable</span><span class="p">(</span><span class="n">getTableClass</span><span class="p">(</span><span class="s2">&quot;hmtx&quot;</span><span class="p">)):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">tableTag</span> <span class="o">=</span> <span class="n">Tag</span><span class="p">(</span><span class="n">tag</span> <span class="ow">or</span> <span class="s1">&#39;hmtx&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="WOFF2HmtxTable.reconstruct"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2HmtxTable.reconstruct">[docs]</a>	<span class="k">def</span> <span class="nf">reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ttFont</span><span class="p">):</span>
		<span class="n">flags</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
		<span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mb">0b11111100</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;Bits 2-7 of &#39;</span><span class="si">%s</span><span class="s2">&#39; flags are reserved&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableTag</span><span class="p">)</span>

		<span class="c1"># When bit 0 is _not_ set, the lsb[] array is present</span>
		<span class="n">hasLsbArray</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span>
		<span class="c1"># When bit 1 is _not_ set, the leftSideBearing[] array is present</span>
		<span class="n">hasLeftSideBearingArray</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
		<span class="k">if</span> <span class="n">hasLsbArray</span> <span class="ow">and</span> <span class="n">hasLeftSideBearingArray</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
				<span class="s2">&quot;either bits 0 or 1 (or both) must set in transformed &#39;</span><span class="si">%s</span><span class="s2">&#39; flags&quot;</span>
				<span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableTag</span>
			<span class="p">)</span>

		<span class="n">glyfTable</span> <span class="o">=</span> <span class="n">ttFont</span><span class="p">[</span><span class="s2">&quot;glyf&quot;</span><span class="p">]</span>
		<span class="n">headerTable</span> <span class="o">=</span> <span class="n">ttFont</span><span class="p">[</span><span class="s2">&quot;hhea&quot;</span><span class="p">]</span>
		<span class="n">glyphOrder</span> <span class="o">=</span> <span class="n">glyfTable</span><span class="o">.</span><span class="n">glyphOrder</span>
		<span class="n">numGlyphs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyphOrder</span><span class="p">)</span>
		<span class="n">numberOfHMetrics</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">headerTable</span><span class="o">.</span><span class="n">numberOfHMetrics</span><span class="p">),</span> <span class="n">numGlyphs</span><span class="p">)</span>

		<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfHMetrics</span>
		<span class="n">advanceWidthArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfHMetrics</span><span class="p">])</span>
		<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
			<span class="n">advanceWidthArray</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfHMetrics</span><span class="p">:]</span>

		<span class="k">if</span> <span class="n">hasLsbArray</span><span class="p">:</span>
			<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfHMetrics</span>
			<span class="n">lsbArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfHMetrics</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
				<span class="n">lsbArray</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfHMetrics</span><span class="p">:]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># compute (proportional) glyphs&#39; lsb from their xMin</span>
			<span class="n">lsbArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glyphOrder</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">numberOfHMetrics</span><span class="p">:</span>
					<span class="k">break</span>
				<span class="n">glyph</span> <span class="o">=</span> <span class="n">glyfTable</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
				<span class="n">xMin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyph</span><span class="p">,</span> <span class="s2">&quot;xMin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">lsbArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xMin</span><span class="p">)</span>

		<span class="n">numberOfSideBearings</span> <span class="o">=</span> <span class="n">numGlyphs</span> <span class="o">-</span> <span class="n">numberOfHMetrics</span>
		<span class="k">if</span> <span class="n">hasLeftSideBearingArray</span><span class="p">:</span>
			<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfSideBearings</span>
			<span class="n">leftSideBearingArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfSideBearings</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
				<span class="n">leftSideBearingArray</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numberOfSideBearings</span><span class="p">:]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># compute (monospaced) glyphs&#39; leftSideBearing from their xMin</span>
			<span class="n">leftSideBearingArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;h&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glyphOrder</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numberOfHMetrics</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">glyph</span> <span class="o">=</span> <span class="n">glyfTable</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
				<span class="n">xMin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyph</span><span class="p">,</span> <span class="s2">&quot;xMin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">leftSideBearingArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xMin</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">data</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s2">&quot;too much &#39;</span><span class="si">%s</span><span class="s2">&#39; table data&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableTag</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfHMetrics</span><span class="p">):</span>
			<span class="n">glyphName</span> <span class="o">=</span> <span class="n">glyphOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">advanceWidth</span><span class="p">,</span> <span class="n">lsb</span> <span class="o">=</span> <span class="n">advanceWidthArray</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lsbArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">advanceWidth</span><span class="p">,</span> <span class="n">lsb</span><span class="p">)</span>
		<span class="n">lastAdvance</span> <span class="o">=</span> <span class="n">advanceWidthArray</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfSideBearings</span><span class="p">):</span>
			<span class="n">glyphName</span> <span class="o">=</span> <span class="n">glyphOrder</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">numberOfHMetrics</span><span class="p">]</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lastAdvance</span><span class="p">,</span> <span class="n">leftSideBearingArray</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="WOFF2HmtxTable.transform"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2HmtxTable.transform">[docs]</a>	<span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ttFont</span><span class="p">):</span>
		<span class="n">glyphOrder</span> <span class="o">=</span> <span class="n">ttFont</span><span class="o">.</span><span class="n">getGlyphOrder</span><span class="p">()</span>
		<span class="n">glyf</span> <span class="o">=</span> <span class="n">ttFont</span><span class="p">[</span><span class="s2">&quot;glyf&quot;</span><span class="p">]</span>
		<span class="n">hhea</span> <span class="o">=</span> <span class="n">ttFont</span><span class="p">[</span><span class="s2">&quot;hhea&quot;</span><span class="p">]</span>
		<span class="n">numberOfHMetrics</span> <span class="o">=</span> <span class="n">hhea</span><span class="o">.</span><span class="n">numberOfHMetrics</span>

		<span class="c1"># check if any of the proportional glyphs has left sidebearings that</span>
		<span class="c1"># differ from their xMin bounding box values.</span>
		<span class="n">hasLsbArray</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfHMetrics</span><span class="p">):</span>
			<span class="n">glyphName</span> <span class="o">=</span> <span class="n">glyphOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">lsb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">glyphName</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">lsb</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyf</span><span class="p">[</span><span class="n">glyphName</span><span class="p">],</span> <span class="s2">&quot;xMin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
				<span class="n">hasLsbArray</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">break</span>

		<span class="c1"># do the same for the monospaced glyphs (if any) at the end of hmtx table</span>
		<span class="n">hasLeftSideBearingArray</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfHMetrics</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyphOrder</span><span class="p">)):</span>
			<span class="n">glyphName</span> <span class="o">=</span> <span class="n">glyphOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="n">lsb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">glyphName</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">lsb</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyf</span><span class="p">[</span><span class="n">glyphName</span><span class="p">],</span> <span class="s2">&quot;xMin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
				<span class="n">hasLeftSideBearingArray</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="k">break</span>

		<span class="c1"># if we need to encode both sidebearings arrays, then no transformation is</span>
		<span class="c1"># applicable, and we must use the untransformed hmtx data</span>
		<span class="k">if</span> <span class="n">hasLsbArray</span> <span class="ow">and</span> <span class="n">hasLeftSideBearingArray</span><span class="p">:</span>
			<span class="k">return</span>

		<span class="c1"># set bit 0 and 1 when the respective arrays are _not_ present</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">hasLsbArray</span><span class="p">:</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">hasLeftSideBearingArray</span><span class="p">:</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

		<span class="n">advanceWidthArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
			<span class="s2">&quot;H&quot;</span><span class="p">,</span>
			<span class="p">[</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">glyphName</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glyphOrder</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numberOfHMetrics</span>
			<span class="p">]</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
			<span class="n">advanceWidthArray</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">advanceWidthArray</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

		<span class="k">if</span> <span class="n">hasLsbArray</span><span class="p">:</span>
			<span class="n">lsbArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
				<span class="s2">&quot;h&quot;</span><span class="p">,</span>
				<span class="p">[</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">glyphName</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
					<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glyphOrder</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numberOfHMetrics</span>
				<span class="p">]</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
				<span class="n">lsbArray</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">lsbArray</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

		<span class="k">if</span> <span class="n">hasLeftSideBearingArray</span><span class="p">:</span>
			<span class="n">leftSideBearingArray</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
				<span class="s2">&quot;h&quot;</span><span class="p">,</span>
				<span class="p">[</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="n">glyphOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
					<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberOfHMetrics</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyphOrder</span><span class="p">))</span>
				<span class="p">]</span>
			<span class="p">)</span>
			<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="s2">&quot;big&quot;</span><span class="p">:</span>
				<span class="n">leftSideBearingArray</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">leftSideBearingArray</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>

		<span class="k">return</span> <span class="n">data</span></div></div>


<div class="viewcode-block" id="WOFF2FlavorData"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.WOFF2FlavorData">[docs]</a><span class="k">class</span> <span class="nc">WOFF2FlavorData</span><span class="p">(</span><span class="n">WOFFFlavorData</span><span class="p">):</span>

	<span class="n">Flavor</span> <span class="o">=</span> <span class="s1">&#39;woff2&#39;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transformedTables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Data class that holds the WOFF2 header major/minor version, any</span>
<span class="sd">		metadata or private data (as bytes strings), and the set of</span>
<span class="sd">		table tags that have transformations applied (if reader is not None),</span>
<span class="sd">		or will have once the WOFF2 font is compiled.</span>

<span class="sd">		Args:</span>
<span class="sd">			reader: an SFNTReader (or subclass) object to read flavor data from.</span>
<span class="sd">			data: another WOFFFlavorData object to initialise data from.</span>
<span class="sd">			transformedTables: set of strings containing table tags to be transformed.</span>

<span class="sd">		Raises:</span>
<span class="sd">			ImportError if the brotli module is not installed.</span>

<span class="sd">		NOTE: The &#39;reader&#39; argument, on the one hand, and the &#39;data&#39; and</span>
<span class="sd">		&#39;transformedTables&#39; arguments, on the other hand, are mutually exclusive.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">haveBrotli</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;No module named brotli&quot;</span><span class="p">)</span>

		<span class="k">if</span> <span class="n">reader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
					<span class="s2">&quot;&#39;reader&#39; and &#39;data&#39; arguments are mutually exclusive&quot;</span>
				<span class="p">)</span>
			<span class="k">if</span> <span class="n">transformedTables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
					<span class="s2">&quot;&#39;reader&#39; and &#39;transformedTables&#39; arguments are mutually exclusive&quot;</span>
				<span class="p">)</span>

		<span class="k">if</span> <span class="n">transformedTables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span>
				<span class="s2">&quot;glyf&quot;</span> <span class="ow">in</span> <span class="n">transformedTables</span> <span class="ow">and</span> <span class="s2">&quot;loca&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transformedTables</span>
				<span class="ow">or</span> <span class="s2">&quot;loca&quot;</span> <span class="ow">in</span> <span class="n">transformedTables</span> <span class="ow">and</span> <span class="s2">&quot;glyf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transformedTables</span>
			<span class="p">):</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
					<span class="s2">&quot;&#39;glyf&#39; and &#39;loca&#39; must be transformed (or not) together&quot;</span>
				<span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">majorVersion</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">minorVersion</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">metaData</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">privData</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="n">reader</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">majorVersion</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">majorVersion</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">minorVersion</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">minorVersion</span>
			<span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">metaLength</span><span class="p">:</span>
				<span class="n">reader</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">metaOffset</span><span class="p">)</span>
				<span class="n">rawData</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">metaLength</span><span class="p">)</span>
				<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rawData</span><span class="p">)</span> <span class="o">==</span> <span class="n">reader</span><span class="o">.</span><span class="n">metaLength</span>
				<span class="n">metaData</span> <span class="o">=</span> <span class="n">brotli</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">rawData</span><span class="p">)</span>
				<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">metaData</span><span class="p">)</span> <span class="o">==</span> <span class="n">reader</span><span class="o">.</span><span class="n">metaOrigLength</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">metaData</span> <span class="o">=</span> <span class="n">metaData</span>
			<span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">privLength</span><span class="p">:</span>
				<span class="n">reader</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">privOffset</span><span class="p">)</span>
				<span class="n">privData</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">privLength</span><span class="p">)</span>
				<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">privData</span><span class="p">)</span> <span class="o">==</span> <span class="n">reader</span><span class="o">.</span><span class="n">privLength</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">privData</span> <span class="o">=</span> <span class="n">privData</span>
			<span class="n">transformedTables</span> <span class="o">=</span> <span class="p">[</span>
				<span class="n">tag</span>
				<span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
				<span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">transformed</span>
			<span class="p">]</span>
		<span class="k">elif</span> <span class="n">data</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">majorVersion</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">majorVersion</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">majorVersion</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">minorVersion</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metaData</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">metaData</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">privData</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">privData</span>
			<span class="k">if</span> <span class="n">transformedTables</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;transformedTables&quot;</span><span class="p">):</span>
				 <span class="n">transformedTables</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">transformedTables</span>

		<span class="k">if</span> <span class="n">transformedTables</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">transformedTables</span> <span class="o">=</span> <span class="n">woff2TransformedTableTags</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">transformedTables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">transformedTables</span><span class="p">)</span></div>


<div class="viewcode-block" id="unpackBase128"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.unpackBase128">[docs]</a><span class="k">def</span> <span class="nf">unpackBase128</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
	<span class="sa">r</span><span class="sd">&quot;&quot;&quot; Read one to five bytes from UIntBase128-encoded input string, and return</span>
<span class="sd">	a tuple containing the decoded integer plus any leftover data.</span>

<span class="sd">	&gt;&gt;&gt; unpackBase128(b&#39;\x3f\x00\x00&#39;) == (63, b&quot;\x00\x00&quot;)</span>
<span class="sd">	True</span>
<span class="sd">	&gt;&gt;&gt; unpackBase128(b&#39;\x8f\xff\xff\xff\x7f&#39;)[0] == 4294967295</span>
<span class="sd">	True</span>
<span class="sd">	&gt;&gt;&gt; unpackBase128(b&#39;\x80\x80\x3f&#39;)  # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">	Traceback (most recent call last):</span>
<span class="sd">	  File &quot;&lt;stdin&gt;&quot;, line 1, in ?</span>
<span class="sd">	TTLibError: UIntBase128 value must not start with leading zeros</span>
<span class="sd">	&gt;&gt;&gt; unpackBase128(b&#39;\x8f\xff\xff\xff\xff\x7f&#39;)[0]  # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">	Traceback (most recent call last):</span>
<span class="sd">	  File &quot;&lt;stdin&gt;&quot;, line 1, in ?</span>
<span class="sd">	TTLibError: UIntBase128-encoded sequence is longer than 5 bytes</span>
<span class="sd">	&gt;&gt;&gt; unpackBase128(b&#39;\x90\x80\x80\x80\x00&#39;)[0]  # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">	Traceback (most recent call last):</span>
<span class="sd">	  File &quot;&lt;stdin&gt;&quot;, line 1, in ?</span>
<span class="sd">	TTLibError: UIntBase128 value exceeds 2**32-1</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;not enough data to unpack UIntBase128&#39;</span><span class="p">)</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">if</span> <span class="n">byteord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">:</span>
		<span class="c1"># font must be rejected if UIntBase128 value starts with 0x80</span>
		<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;UIntBase128 value must not start with leading zeros&#39;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">woff2Base128MaxSize</span><span class="p">):</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;not enough data to unpack UIntBase128&#39;</span><span class="p">)</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">byteord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
		<span class="c1"># if any of the top seven bits are set then we&#39;re about to overflow</span>
		<span class="k">if</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xFE000000</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;UIntBase128 value exceeds 2**32-1&#39;</span><span class="p">)</span>
		<span class="c1"># set current value = old value times 128 bitwise-or (byte bitwise-and 127)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>
		<span class="c1"># repeat until the most significant bit of byte is false</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="c1"># return result plus left over data</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">data</span>
	<span class="c1"># make sure not to exceed the size bound</span>
	<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;UIntBase128-encoded sequence is longer than 5 bytes&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="base128Size"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.base128Size">[docs]</a><span class="k">def</span> <span class="nf">base128Size</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Return the length in bytes of a UIntBase128-encoded sequence with value n.</span>

<span class="sd">	&gt;&gt;&gt; base128Size(0)</span>
<span class="sd">	1</span>
<span class="sd">	&gt;&gt;&gt; base128Size(24567)</span>
<span class="sd">	3</span>
<span class="sd">	&gt;&gt;&gt; base128Size(2**32-1)</span>
<span class="sd">	5</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="k">while</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">:</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span>
	<span class="k">return</span> <span class="n">size</span></div>


<div class="viewcode-block" id="packBase128"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.packBase128">[docs]</a><span class="k">def</span> <span class="nf">packBase128</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
	<span class="sa">r</span><span class="sd">&quot;&quot;&quot; Encode unsigned integer in range 0 to 2**32-1 (inclusive) to a string of</span>
<span class="sd">	bytes using UIntBase128 variable-length encoding. Produce the shortest possible</span>
<span class="sd">	encoding.</span>

<span class="sd">	&gt;&gt;&gt; packBase128(63) == b&quot;\x3f&quot;</span>
<span class="sd">	True</span>
<span class="sd">	&gt;&gt;&gt; packBase128(2**32-1) == b&#39;\x8f\xff\xff\xff\x7f&#39;</span>
<span class="sd">	True</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
			<span class="s2">&quot;UIntBase128 format requires 0 &lt;= integer &lt;= 2**32-1&quot;</span><span class="p">)</span>
	<span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">base128Size</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
		<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
		<span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">b</span> <span class="o">|=</span> <span class="mh">0x80</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="unpack255UShort"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.unpack255UShort">[docs]</a><span class="k">def</span> <span class="nf">unpack255UShort</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot; Read one to three bytes from 255UInt16-encoded input string, and return a</span>
<span class="sd">	tuple containing the decoded integer plus any leftover data.</span>

<span class="sd">	&gt;&gt;&gt; unpack255UShort(bytechr(252))[0]</span>
<span class="sd">	252</span>

<span class="sd">	Note that some numbers (e.g. 506) can have multiple encodings:</span>
<span class="sd">	&gt;&gt;&gt; unpack255UShort(struct.pack(&quot;BB&quot;, 254, 0))[0]</span>
<span class="sd">	506</span>
<span class="sd">	&gt;&gt;&gt; unpack255UShort(struct.pack(&quot;BB&quot;, 255, 253))[0]</span>
<span class="sd">	506</span>
<span class="sd">	&gt;&gt;&gt; unpack255UShort(struct.pack(&quot;BBB&quot;, 253, 1, 250))[0]</span>
<span class="sd">	506</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">code</span> <span class="o">=</span> <span class="n">byteord</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
	<span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">253</span><span class="p">:</span>
		<span class="c1"># read two more bytes as an unsigned short</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;not enough data to unpack 255UInt16&#39;</span><span class="p">)</span>
		<span class="n">result</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&gt;H&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
	<span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">254</span><span class="p">:</span>
		<span class="c1"># read another byte, plus 253 * 2</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;not enough data to unpack 255UInt16&#39;</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">byteord</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">result</span> <span class="o">+=</span> <span class="mi">506</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
	<span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
		<span class="c1"># read another byte, plus 253</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span><span class="s1">&#39;not enough data to unpack 255UInt16&#39;</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">byteord</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">result</span> <span class="o">+=</span> <span class="mi">253</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="c1"># leave as is if lower than 253</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">code</span>
	<span class="c1"># return result plus left over data</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">data</span></div>


<div class="viewcode-block" id="pack255UShort"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.pack255UShort">[docs]</a><span class="k">def</span> <span class="nf">pack255UShort</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
	<span class="sa">r</span><span class="sd">&quot;&quot;&quot; Encode unsigned integer in range 0 to 65535 (inclusive) to a bytestring</span>
<span class="sd">	using 255UInt16 variable-length encoding.</span>

<span class="sd">	&gt;&gt;&gt; pack255UShort(252) == b&#39;\xfc&#39;</span>
<span class="sd">	True</span>
<span class="sd">	&gt;&gt;&gt; pack255UShort(506) == b&#39;\xfe\x00&#39;</span>
<span class="sd">	True</span>
<span class="sd">	&gt;&gt;&gt; pack255UShort(762) == b&#39;\xfd\x02\xfa&#39;</span>
<span class="sd">	True</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">TTLibError</span><span class="p">(</span>
			<span class="s2">&quot;255UInt16 format requires 0 &lt;= integer &lt;= 65535&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">253</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;B&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">506</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BB&quot;</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">253</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">762</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BB&quot;</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">506</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&gt;BH&quot;</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="compress"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.compress">[docs]</a><span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">transform_tables</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Compress OpenType font to WOFF2.</span>

<span class="sd">	Args:</span>
<span class="sd">		input_file: a file path, file or file-like object (open in binary mode)</span>
<span class="sd">			containing an OpenType font (either CFF- or TrueType-flavored).</span>
<span class="sd">		output_file: a file path, file or file-like object where to save the</span>
<span class="sd">			compressed WOFF2 font.</span>
<span class="sd">		transform_tables: Optional[Iterable[str]]: a set of table tags for which</span>
<span class="sd">			to enable preprocessing transformations. By default, only &#39;glyf&#39;</span>
<span class="sd">			and &#39;loca&#39; tables are transformed. An empty set means disable all</span>
<span class="sd">			transformations.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">))</span>

	<span class="n">font</span> <span class="o">=</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">recalcBBoxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recalcTimestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">font</span><span class="o">.</span><span class="n">flavor</span> <span class="o">=</span> <span class="s2">&quot;woff2&quot;</span>

	<span class="k">if</span> <span class="n">transform_tables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">font</span><span class="o">.</span><span class="n">flavorData</span> <span class="o">=</span> <span class="n">WOFF2FlavorData</span><span class="p">(</span>
			<span class="n">data</span><span class="o">=</span><span class="n">font</span><span class="o">.</span><span class="n">flavorData</span><span class="p">,</span> <span class="n">transformedTables</span><span class="o">=</span><span class="n">transform_tables</span>
		<span class="p">)</span>

	<span class="n">font</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">reorderTables</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="decompress"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.decompress">[docs]</a><span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Decompress WOFF2 font to OpenType font.</span>

<span class="sd">	Args:</span>
<span class="sd">		input_file: a file path, file or file-like object (open in binary mode)</span>
<span class="sd">			containing a compressed WOFF2 font.</span>
<span class="sd">		output_file: a file path, file or file-like object where to save the</span>
<span class="sd">			decompressed OpenType font.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">))</span>

	<span class="n">font</span> <span class="o">=</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">recalcBBoxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">recalcTimestamp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="n">font</span><span class="o">.</span><span class="n">flavor</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">font</span><span class="o">.</span><span class="n">flavorData</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">font</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">reorderTables</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../ttLib/woff2.html#fontTools.ttLib.woff2.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="kn">import</span> <span class="nn">argparse</span>
	<span class="kn">from</span> <span class="nn">fontTools</span> <span class="k">import</span> <span class="n">configLogger</span>
	<span class="kn">from</span> <span class="nn">fontTools.ttx</span> <span class="k">import</span> <span class="n">makeOutputFileName</span>

	<span class="k">class</span> <span class="nc">_NoGlyfTransformAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
		<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
			<span class="n">namespace</span><span class="o">.</span><span class="n">transform_tables</span><span class="o">.</span><span class="n">difference_update</span><span class="p">({</span><span class="s2">&quot;glyf&quot;</span><span class="p">,</span> <span class="s2">&quot;loca&quot;</span><span class="p">})</span>

	<span class="k">class</span> <span class="nc">_HmtxTransformAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
		<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
			<span class="n">namespace</span><span class="o">.</span><span class="n">transform_tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;hmtx&quot;</span><span class="p">)</span>

	<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
		<span class="n">prog</span><span class="o">=</span><span class="s2">&quot;fonttools ttLib.woff2&quot;</span><span class="p">,</span>
		<span class="n">description</span><span class="o">=</span><span class="s2">&quot;Compress and decompress WOFF2 fonts&quot;</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="n">parser_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;sub-commands&quot;</span><span class="p">)</span>
	<span class="n">parser_compress</span> <span class="o">=</span> <span class="n">parser_group</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;compress&quot;</span><span class="p">)</span>
	<span class="n">parser_decompress</span> <span class="o">=</span> <span class="n">parser_group</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s2">&quot;decompress&quot;</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">subparser</span> <span class="ow">in</span> <span class="p">(</span><span class="n">parser_compress</span><span class="p">,</span> <span class="n">parser_decompress</span><span class="p">):</span>
		<span class="n">group</span> <span class="o">=</span> <span class="n">subparser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
			<span class="s2">&quot;-v&quot;</span><span class="p">,</span>
			<span class="s2">&quot;--verbose&quot;</span><span class="p">,</span>
			<span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
			<span class="n">help</span><span class="o">=</span><span class="s2">&quot;print more messages to console&quot;</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
			<span class="s2">&quot;-q&quot;</span><span class="p">,</span>
			<span class="s2">&quot;--quiet&quot;</span><span class="p">,</span>
			<span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
			<span class="n">help</span><span class="o">=</span><span class="s2">&quot;do not print messages to console&quot;</span><span class="p">,</span>
		<span class="p">)</span>

	<span class="n">parser_compress</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
		<span class="s2">&quot;input_file&quot;</span><span class="p">,</span>
		<span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;INPUT&quot;</span><span class="p">,</span>
		<span class="n">help</span><span class="o">=</span><span class="s2">&quot;the input OpenType font (.ttf or .otf)&quot;</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="n">parser_decompress</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
		<span class="s2">&quot;input_file&quot;</span><span class="p">,</span>
		<span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;INPUT&quot;</span><span class="p">,</span>
		<span class="n">help</span><span class="o">=</span><span class="s2">&quot;the input WOFF2 font&quot;</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="n">parser_compress</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
		<span class="s2">&quot;-o&quot;</span><span class="p">,</span>
		<span class="s2">&quot;--output-file&quot;</span><span class="p">,</span>
		<span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT&quot;</span><span class="p">,</span>
		<span class="n">help</span><span class="o">=</span><span class="s2">&quot;the output WOFF2 font&quot;</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="n">parser_decompress</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
		<span class="s2">&quot;-o&quot;</span><span class="p">,</span>
		<span class="s2">&quot;--output-file&quot;</span><span class="p">,</span>
		<span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT&quot;</span><span class="p">,</span>
		<span class="n">help</span><span class="o">=</span><span class="s2">&quot;the output OpenType font&quot;</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="n">transform_group</span> <span class="o">=</span> <span class="n">parser_compress</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">()</span>
	<span class="n">transform_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
		<span class="s2">&quot;--no-glyf-transform&quot;</span><span class="p">,</span>
		<span class="n">dest</span><span class="o">=</span><span class="s2">&quot;transform_tables&quot;</span><span class="p">,</span>
		<span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
		<span class="n">action</span><span class="o">=</span><span class="n">_NoGlyfTransformAction</span><span class="p">,</span>
		<span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not transform glyf (and loca) tables&quot;</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="n">transform_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
		<span class="s2">&quot;--hmtx-transform&quot;</span><span class="p">,</span>
		<span class="n">dest</span><span class="o">=</span><span class="s2">&quot;transform_tables&quot;</span><span class="p">,</span>
		<span class="n">nargs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
		<span class="n">action</span><span class="o">=</span><span class="n">_HmtxTransformAction</span><span class="p">,</span>
		<span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable optional transformation for &#39;hmtx&#39; table&quot;</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="n">parser_compress</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span>
		<span class="n">subcommand</span><span class="o">=</span><span class="n">compress</span><span class="p">,</span>
		<span class="n">transform_tables</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;glyf&quot;</span><span class="p">,</span> <span class="s2">&quot;loca&quot;</span><span class="p">},</span>
	<span class="p">)</span>
	<span class="n">parser_decompress</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="n">subcommand</span><span class="o">=</span><span class="n">decompress</span><span class="p">)</span>

	<span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

	<span class="n">subcommand</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;subcommand&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">subcommand</span><span class="p">:</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
		<span class="k">return</span>

	<span class="n">quiet</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">)</span>
	<span class="n">verbose</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span>
	<span class="n">configLogger</span><span class="p">(</span>
		<span class="n">level</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span> <span class="k">if</span> <span class="n">quiet</span> <span class="k">else</span> <span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">),</span>
	<span class="p">)</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;output_file&quot;</span><span class="p">]:</span>
		<span class="k">if</span> <span class="n">subcommand</span> <span class="ow">is</span> <span class="n">compress</span><span class="p">:</span>
			<span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;.woff2&quot;</span>
		<span class="k">elif</span> <span class="n">subcommand</span> <span class="ow">is</span> <span class="n">decompress</span><span class="p">:</span>
			<span class="c1"># choose .ttf/.otf file extension depending on sfntVersion</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;input_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># skip &#39;wOF2&#39; signature</span>
				<span class="n">sfntVersion</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
			<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sfntVersion</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;not enough data&quot;</span>
			<span class="n">extension</span> <span class="o">=</span> <span class="s2">&quot;.otf&quot;</span> <span class="k">if</span> <span class="n">sfntVersion</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;OTTO&quot;</span> <span class="k">else</span> <span class="s2">&quot;.ttf&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>
		<span class="n">options</span><span class="p">[</span><span class="s2">&quot;output_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">makeOutputFileName</span><span class="p">(</span>
			<span class="n">options</span><span class="p">[</span><span class="s2">&quot;input_file&quot;</span><span class="p">],</span> <span class="n">outputDir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="n">extension</span>
		<span class="p">)</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="n">subcommand</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
	<span class="k">except</span> <span class="n">TTLibError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Just van Rossum, Behdad Esfahbod, and the fontTools Authors. CC BY-SA 4.0

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>