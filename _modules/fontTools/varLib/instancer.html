

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fontTools.varLib.instancer &mdash; fontTools Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> fontTools
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../afmLib.html">afmLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agl.html">agl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cffLib/index.html">cffLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../colorLib/index.html">colorLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cu2qu/index.html">cu2qu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../designspaceLib/index.html">designspaceLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../encodings/index.html">encodings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../feaLib/index.html">feaLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../merge.html">merge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mtiLib.html">mtiLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../otlLib/index.html">otlLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pens/index.html">pens</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subset/index.html">subset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svgLib/index.html">svgLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../t1Lib.html">t1Lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ttLib/index.html">ttLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ttx.html">ttx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ufoLib/index.html">ufoLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../unicode.html">unicode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../unicodedata/index.html">unicodedata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../varLib/index.html">varLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voltLib.html">voltLib</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">fontTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../varLib.html">fontTools.varLib</a> &raquo;</li>
        
      <li>fontTools.varLib.instancer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fontTools.varLib.instancer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Partially instantiate a variable font.</span>

<span class="sd">The module exports an `instantiateVariableFont` function and CLI that allow to</span>
<span class="sd">create full instances (i.e. static fonts) from variable fonts, as well as &quot;partial&quot;</span>
<span class="sd">variable fonts that only contain a subset of the original variation space.</span>

<span class="sd">For example, if you wish to pin the width axis to a given location while also</span>
<span class="sd">restricting the weight axis to 400..700 range, you can do:</span>

<span class="sd">$ fonttools varLib.instancer ./NotoSans-VF.ttf wdth=85 wght=400:700</span>

<span class="sd">See `fonttools varLib.instancer --help` for more info on the CLI options.</span>

<span class="sd">The module&#39;s entry point is the `instantiateVariableFont` function, which takes</span>
<span class="sd">a TTFont object and a dict specifying either axis coodinates or (min, max) ranges,</span>
<span class="sd">and returns a new TTFont representing either a partial VF, or full instance if all</span>
<span class="sd">the VF axes were given an explicit coordinate.</span>

<span class="sd">E.g. here&#39;s how to pin the wght axis at a given location in a wght+wdth variable</span>
<span class="sd">font, keeping only the deltas associated with the wdth axis:</span>

<span class="sd">| &gt;&gt;&gt; from fontTools import ttLib</span>
<span class="sd">| &gt;&gt;&gt; from fontTools.varLib import instancer</span>
<span class="sd">| &gt;&gt;&gt; varfont = ttLib.TTFont(&quot;path/to/MyVariableFont.ttf&quot;)</span>
<span class="sd">| &gt;&gt;&gt; [a.axisTag for a in varfont[&quot;fvar&quot;].axes]  # the varfont&#39;s current axes</span>
<span class="sd">| [&#39;wght&#39;, &#39;wdth&#39;]</span>
<span class="sd">| &gt;&gt;&gt; partial = instancer.instantiateVariableFont(varfont, {&quot;wght&quot;: 300})</span>
<span class="sd">| &gt;&gt;&gt; [a.axisTag for a in partial[&quot;fvar&quot;].axes]  # axes left after pinning &#39;wght&#39;</span>
<span class="sd">| [&#39;wdth&#39;]</span>

<span class="sd">If the input location specifies all the axes, the resulting instance is no longer</span>
<span class="sd">&#39;variable&#39; (same as using fontools varLib.mutator):</span>

<span class="sd">| &gt;&gt;&gt; instance = instancer.instantiateVariableFont(</span>
<span class="sd">| ...     varfont, {&quot;wght&quot;: 700, &quot;wdth&quot;: 67.5}</span>
<span class="sd">| ... )</span>
<span class="sd">| &gt;&gt;&gt; &quot;fvar&quot; not in instance</span>
<span class="sd">| True</span>

<span class="sd">If one just want to drop an axis at the default location, without knowing in</span>
<span class="sd">advance what the default value for that axis is, one can pass a `None` value:</span>

<span class="sd">| &gt;&gt;&gt; instance = instancer.instantiateVariableFont(varfont, {&quot;wght&quot;: None})</span>
<span class="sd">| &gt;&gt;&gt; len(varfont[&quot;fvar&quot;].axes)</span>
<span class="sd">| 1</span>

<span class="sd">From the console script, this is equivalent to passing `wght=drop` as input.</span>

<span class="sd">This module is similar to fontTools.varLib.mutator, which it&#39;s intended to supersede.</span>
<span class="sd">Note that, unlike varLib.mutator, when an axis is not mentioned in the input</span>
<span class="sd">location, the varLib.instancer will keep the axis and the corresponding deltas,</span>
<span class="sd">whereas mutator implicitly drops the axis at its default coordinate.</span>

<span class="sd">The module currently supports only the first three &quot;levels&quot; of partial instancing,</span>
<span class="sd">with the rest planned to be implemented in the future, namely:</span>
<span class="sd">L1) dropping one or more axes while leaving the default tables unmodified;</span>
<span class="sd">L2) dropping one or more axes while pinning them at non-default locations;</span>
<span class="sd">L3) restricting the range of variation of one or more axes, by setting either</span>
<span class="sd">    a new minimum or maximum, potentially -- though not necessarily -- dropping</span>
<span class="sd">    entire regions of variations that fall completely outside this new range.</span>
<span class="sd">L4) moving the default location of an axis.</span>

<span class="sd">Currently only TrueType-flavored variable fonts (i.e. containing &#39;glyf&#39; table)</span>
<span class="sd">are supported, but support for CFF2 variable fonts will be added soon.</span>

<span class="sd">The discussion and implementation of these features are tracked at</span>
<span class="sd">https://github.com/fonttools/fonttools/issues/1537</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">fontTools.misc.fixedTools</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">floatToFixedToFloat</span><span class="p">,</span>
    <span class="n">strToFixedToFloat</span><span class="p">,</span>
    <span class="n">otRound</span><span class="p">,</span>
    <span class="n">MAX_F2DOT14</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">fontTools.varLib.models</span> <span class="k">import</span> <span class="n">supportScalar</span><span class="p">,</span> <span class="n">normalizeValue</span><span class="p">,</span> <span class="n">piecewiseLinearMap</span>
<span class="kn">from</span> <span class="nn">fontTools.ttLib</span> <span class="k">import</span> <span class="n">TTFont</span>
<span class="kn">from</span> <span class="nn">fontTools.ttLib.tables.TupleVariation</span> <span class="k">import</span> <span class="n">TupleVariation</span>
<span class="kn">from</span> <span class="nn">fontTools.ttLib.tables</span> <span class="k">import</span> <span class="n">_g_l_y_f</span>
<span class="kn">from</span> <span class="nn">fontTools</span> <span class="k">import</span> <span class="n">varLib</span>

<span class="c1"># we import the `subset` module because we use the `prune_lookups` method on the GSUB</span>
<span class="c1"># table class, and that method is only defined dynamically upon importing `subset`</span>
<span class="kn">from</span> <span class="nn">fontTools</span> <span class="k">import</span> <span class="n">subset</span>  <span class="c1"># noqa: F401</span>
<span class="kn">from</span> <span class="nn">fontTools.varLib</span> <span class="k">import</span> <span class="n">builder</span>
<span class="kn">from</span> <span class="nn">fontTools.varLib.mvar</span> <span class="k">import</span> <span class="n">MVAR_ENTRIES</span>
<span class="kn">from</span> <span class="nn">fontTools.varLib.merger</span> <span class="k">import</span> <span class="n">MutatorMerger</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">islice</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;fontTools.varLib.instancer&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="AxisRange"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.AxisRange">[docs]</a><span class="k">class</span> <span class="nc">AxisRange</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;AxisRange&quot;</span><span class="p">,</span> <span class="s2">&quot;minimum maximum&quot;</span><span class="p">)):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Range minimum (</span><span class="si">{self.minimum:g}</span><span class="s2">) must be &lt;= maximum (</span><span class="si">{self.maximum:g}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;{type(self).__name__}(</span><span class="si">{self.minimum:g}</span><span class="s2">, </span><span class="si">{self.maximum:g}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="NormalizedAxisRange"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.NormalizedAxisRange">[docs]</a><span class="k">class</span> <span class="nc">NormalizedAxisRange</span><span class="p">(</span><span class="n">AxisRange</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis range values must be normalized to -1..+1 range&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Expected axis range minimum &lt;= 0; got </span><span class="si">{self.minimum}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Expected axis range maximum &gt;= 0; got </span><span class="si">{self.maximum}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="instantiateTupleVariationStore"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateTupleVariationStore">[docs]</a><span class="k">def</span> <span class="nf">instantiateTupleVariationStore</span><span class="p">(</span>
    <span class="n">variations</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">origCoords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endPts</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instantiate TupleVariation list at the given location, or limit axes&#39; min/max.</span>

<span class="sd">    The &#39;variations&#39; list of TupleVariation objects is modified in-place.</span>
<span class="sd">    The &#39;axisLimits&#39; (dict) maps axis tags (str) to either a single coordinate along the</span>
<span class="sd">    axis (float), or to minimum/maximum coordinates (NormalizedAxisRange).</span>

<span class="sd">    A &#39;full&#39; instance (i.e. static font) is produced when all the axes are pinned to</span>
<span class="sd">    single coordinates; a &#39;partial&#39; instance (i.e. a less variable font) is produced</span>
<span class="sd">    when some of the axes are omitted, or restricted with a new range.</span>

<span class="sd">    Tuples that do not participate are kept as they are. Those that have 0 influence</span>
<span class="sd">    at the given location are removed from the variation store.</span>
<span class="sd">    Those that are fully instantiated (i.e. all their axes are being pinned) are also</span>
<span class="sd">    removed from the variation store, their scaled deltas accummulated and returned, so</span>
<span class="sd">    that they can be added by the caller to the default instance&#39;s coordinates.</span>
<span class="sd">    Tuples that are only partially instantiated (i.e. not all the axes that they</span>
<span class="sd">    participate in are being pinned) are kept in the store, and their deltas multiplied</span>
<span class="sd">    by the scalar support of the axes to be pinned at the desired location.</span>

<span class="sd">    Args:</span>
<span class="sd">        variations: List[TupleVariation] from either &#39;gvar&#39; or &#39;cvar&#39;.</span>
<span class="sd">        axisLimits: Dict[str, Union[float, NormalizedAxisRange]]: axes&#39; coordinates for</span>
<span class="sd">            the full or partial instance, or ranges for restricting an axis&#39; min/max.</span>
<span class="sd">        origCoords: GlyphCoordinates: default instance&#39;s coordinates for computing &#39;gvar&#39;</span>
<span class="sd">            inferred points (cf. table__g_l_y_f.getCoordinatesAndControls).</span>
<span class="sd">        endPts: List[int]: indices of contour end points, for inferring &#39;gvar&#39; deltas.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[float]: the overall delta adjustment after applicable deltas were summed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pinnedLocation</span><span class="p">,</span> <span class="n">axisRanges</span> <span class="o">=</span> <span class="n">splitAxisLocationAndRanges</span><span class="p">(</span>
        <span class="n">axisLimits</span><span class="p">,</span> <span class="n">rangeType</span><span class="o">=</span><span class="n">NormalizedAxisRange</span>
    <span class="p">)</span>

    <span class="n">newVariations</span> <span class="o">=</span> <span class="n">variations</span>

    <span class="k">if</span> <span class="n">pinnedLocation</span><span class="p">:</span>
        <span class="n">newVariations</span> <span class="o">=</span> <span class="n">pinTupleVariationAxes</span><span class="p">(</span><span class="n">variations</span><span class="p">,</span> <span class="n">pinnedLocation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axisRanges</span><span class="p">:</span>
        <span class="n">newVariations</span> <span class="o">=</span> <span class="n">limitTupleVariationAxisRanges</span><span class="p">(</span><span class="n">newVariations</span><span class="p">,</span> <span class="n">axisRanges</span><span class="p">)</span>

    <span class="n">mergedVariations</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">newVariations</span><span class="p">:</span>
        <span class="c1"># compute inferred deltas only for gvar (&#39;origCoords&#39; is None for cvar)</span>
        <span class="k">if</span> <span class="n">origCoords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">calcInferredDeltas</span><span class="p">(</span><span class="n">origCoords</span><span class="p">,</span> <span class="n">endPts</span><span class="p">)</span>

        <span class="c1"># merge TupleVariations with overlapping &quot;tents&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">axes</span> <span class="ow">in</span> <span class="n">mergedVariations</span><span class="p">:</span>
            <span class="n">mergedVariations</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="o">+=</span> <span class="n">var</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mergedVariations</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>

    <span class="c1"># drop TupleVariation if all axes have been pinned (var.axes.items() is empty);</span>
    <span class="c1"># its deltas will be added to the default instance&#39;s coordinates</span>
    <span class="n">defaultVar</span> <span class="o">=</span> <span class="n">mergedVariations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">mergedVariations</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">var</span><span class="o">.</span><span class="n">roundDeltas</span><span class="p">()</span>
    <span class="n">variations</span><span class="p">[:]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mergedVariations</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">defaultVar</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">if</span> <span class="n">defaultVar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="pinTupleVariationAxes"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.pinTupleVariationAxes">[docs]</a><span class="k">def</span> <span class="nf">pinTupleVariationAxes</span><span class="p">(</span><span class="n">variations</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
    <span class="n">newVariations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variations</span><span class="p">:</span>
        <span class="c1"># Compute the scalar support of the axes to be pinned at the desired location,</span>
        <span class="c1"># excluding any axes that we are not pinning.</span>
        <span class="c1"># If a TupleVariation doesn&#39;t mention an axis, it implies that the axis peak</span>
        <span class="c1"># is 0 (i.e. the axis does not participate).</span>
        <span class="n">support</span> <span class="o">=</span> <span class="p">{</span><span class="n">axis</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">location</span><span class="p">}</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">supportScalar</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">support</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scalar</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="c1"># no influence, drop the TupleVariation</span>
            <span class="k">continue</span>

        <span class="n">var</span><span class="o">.</span><span class="n">scaleDeltas</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>
        <span class="n">newVariations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newVariations</span></div>


<div class="viewcode-block" id="limitTupleVariationAxisRanges"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.limitTupleVariationAxisRanges">[docs]</a><span class="k">def</span> <span class="nf">limitTupleVariationAxisRanges</span><span class="p">(</span><span class="n">variations</span><span class="p">,</span> <span class="n">axisRanges</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">axisRange</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">axisRanges</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">newVariations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variations</span><span class="p">:</span>
            <span class="n">newVariations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">limitTupleVariationAxisRange</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">axisRange</span><span class="p">))</span>
        <span class="n">variations</span> <span class="o">=</span> <span class="n">newVariations</span>
    <span class="k">return</span> <span class="n">variations</span></div>


<span class="k">def</span> <span class="nf">_negate</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>


<div class="viewcode-block" id="limitTupleVariationAxisRange"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.limitTupleVariationAxisRange">[docs]</a><span class="k">def</span> <span class="nf">limitTupleVariationAxisRange</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">axisRange</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axisRange</span><span class="p">,</span> <span class="n">NormalizedAxisRange</span><span class="p">):</span>
        <span class="n">axisRange</span> <span class="o">=</span> <span class="n">NormalizedAxisRange</span><span class="p">(</span><span class="o">*</span><span class="n">axisRange</span><span class="p">)</span>

    <span class="c1"># skip when current axis is missing (i.e. doesn&#39;t participate), or when the</span>
    <span class="c1"># &#39;tent&#39; isn&#39;t fully on either the negative or positive side</span>
    <span class="n">lower</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axisTag</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">peak</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lower</span> <span class="o">&gt;</span> <span class="n">peak</span> <span class="ow">or</span> <span class="n">peak</span> <span class="o">&gt;</span> <span class="n">upper</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">upper</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="n">negative</span> <span class="o">=</span> <span class="n">lower</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="n">limit</span> <span class="o">=</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span> <span class="k">if</span> <span class="n">negative</span> <span class="k">else</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span>

    <span class="c1"># Rebase axis bounds onto the new limit, which then becomes the new -1.0 or +1.0.</span>
    <span class="c1"># The results are always positive, because both dividend and divisor are either</span>
    <span class="c1"># all positive or all negative.</span>
    <span class="n">newLower</span> <span class="o">=</span> <span class="n">lower</span> <span class="o">/</span> <span class="n">limit</span>
    <span class="n">newPeak</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">/</span> <span class="n">limit</span>
    <span class="n">newUpper</span> <span class="o">=</span> <span class="n">upper</span> <span class="o">/</span> <span class="n">limit</span>
    <span class="c1"># for negative TupleVariation, swap lower and upper to simplify procedure</span>
    <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
        <span class="n">newLower</span><span class="p">,</span> <span class="n">newUpper</span> <span class="o">=</span> <span class="n">newUpper</span><span class="p">,</span> <span class="n">newLower</span>

    <span class="c1"># special case when innermost bound == peak == limit</span>
    <span class="k">if</span> <span class="n">newLower</span> <span class="o">==</span> <span class="n">newPeak</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">negative</span> <span class="k">else</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="c1"># case 1: the whole deltaset falls outside the new limit; we can drop it</span>
    <span class="k">elif</span> <span class="n">newLower</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># case 2: only the peak and outermost bound fall outside the new limit;</span>
    <span class="c1"># we keep the deltaset, update peak and outermost bound and and scale deltas</span>
    <span class="c1"># by the scalar value for the restricted axis at the new limit.</span>
    <span class="k">elif</span> <span class="n">newPeak</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">supportScalar</span><span class="p">({</span><span class="n">axisTag</span><span class="p">:</span> <span class="n">limit</span><span class="p">},</span> <span class="p">{</span><span class="n">axisTag</span><span class="p">:</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">upper</span><span class="p">)})</span>
        <span class="n">var</span><span class="o">.</span><span class="n">scaleDeltas</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span>
        <span class="n">newPeak</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">newUpper</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
            <span class="n">newLower</span><span class="p">,</span> <span class="n">newPeak</span><span class="p">,</span> <span class="n">newUpper</span> <span class="o">=</span> <span class="n">_negate</span><span class="p">(</span><span class="n">newUpper</span><span class="p">,</span> <span class="n">newPeak</span><span class="p">,</span> <span class="n">newLower</span><span class="p">)</span>
        <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newLower</span><span class="p">,</span> <span class="n">newPeak</span><span class="p">,</span> <span class="n">newUpper</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="c1"># case 3: peak falls inside but outermost limit still fits within F2Dot14 bounds;</span>
    <span class="c1"># we keep deltas as is and only scale the axes bounds. Deltas beyond -1.0</span>
    <span class="c1"># or +1.0 will never be applied as implementations must clamp to that range.</span>
    <span class="k">elif</span> <span class="n">newUpper</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
            <span class="n">newLower</span><span class="p">,</span> <span class="n">newPeak</span><span class="p">,</span> <span class="n">newUpper</span> <span class="o">=</span> <span class="n">_negate</span><span class="p">(</span><span class="n">newUpper</span><span class="p">,</span> <span class="n">newPeak</span><span class="p">,</span> <span class="n">newLower</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">MAX_F2DOT14</span> <span class="o">&lt;</span> <span class="n">newUpper</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="c1"># we clamp +2.0 to the max F2Dot14 (~1.99994) for convenience</span>
            <span class="n">newUpper</span> <span class="o">=</span> <span class="n">MAX_F2DOT14</span>
        <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newLower</span><span class="p">,</span> <span class="n">newPeak</span><span class="p">,</span> <span class="n">newUpper</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="c1"># case 4: new limit doesn&#39;t fit; we need to chop the deltaset into two &#39;tents&#39;,</span>
    <span class="c1"># because the shape of a triangle with part of one side cut off cannot be</span>
    <span class="c1"># represented as a triangle itself. It can be represented as sum of two triangles.</span>
    <span class="c1"># NOTE: This increases the file size!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># duplicate the tent, then adjust lower/peak/upper so that the outermost limit</span>
        <span class="c1"># of the original tent is +/-2.0, whereas the new tent&#39;s starts as the old</span>
        <span class="c1"># one peaks and maxes out at +/-1.0.</span>
        <span class="n">newVar</span> <span class="o">=</span> <span class="n">TupleVariation</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">negative</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">newPeak</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">newLower</span><span class="p">)</span>
            <span class="n">newVar</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">newPeak</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newLower</span><span class="p">,</span> <span class="n">newPeak</span><span class="p">,</span> <span class="n">MAX_F2DOT14</span><span class="p">)</span>
            <span class="n">newVar</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">newPeak</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="c1"># the new tent&#39;s deltas are scaled by the difference between the scalar value</span>
        <span class="c1"># for the old tent at the desired limit...</span>
        <span class="n">scalar1</span> <span class="o">=</span> <span class="n">supportScalar</span><span class="p">({</span><span class="n">axisTag</span><span class="p">:</span> <span class="n">limit</span><span class="p">},</span> <span class="p">{</span><span class="n">axisTag</span><span class="p">:</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">upper</span><span class="p">)})</span>
        <span class="c1"># ... and the scalar value for the clamped tent (with outer limit +/-2.0),</span>
        <span class="c1"># which can be simplified like this:</span>
        <span class="n">scalar2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">newPeak</span><span class="p">)</span>
        <span class="n">newVar</span><span class="o">.</span><span class="n">scaleDeltas</span><span class="p">(</span><span class="n">scalar1</span> <span class="o">-</span> <span class="n">scalar2</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">var</span><span class="p">,</span> <span class="n">newVar</span><span class="p">]</span></div>


<div class="viewcode-block" id="instantiateGvarGlyph"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateGvarGlyph">[docs]</a><span class="k">def</span> <span class="nf">instantiateGvarGlyph</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">glyphname</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">glyf</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;glyf&quot;</span><span class="p">]</span>
    <span class="n">coordinates</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">glyf</span><span class="o">.</span><span class="n">getCoordinatesAndControls</span><span class="p">(</span><span class="n">glyphname</span><span class="p">,</span> <span class="n">varfont</span><span class="p">)</span>
    <span class="n">endPts</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">endPts</span>

    <span class="n">gvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;gvar&quot;</span><span class="p">]</span>
    <span class="c1"># when exporting to TTX, a glyph with no variations is omitted; thus when loading</span>
    <span class="c1"># a TTFont from TTX, a glyph that&#39;s present in glyf table may be missing from gvar.</span>
    <span class="n">tupleVarStore</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">variations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">glyphname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tupleVarStore</span><span class="p">:</span>
        <span class="n">defaultDeltas</span> <span class="o">=</span> <span class="n">instantiateTupleVariationStore</span><span class="p">(</span>
            <span class="n">tupleVarStore</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">endPts</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">defaultDeltas</span><span class="p">:</span>
            <span class="n">coordinates</span> <span class="o">+=</span> <span class="n">_g_l_y_f</span><span class="o">.</span><span class="n">GlyphCoordinates</span><span class="p">(</span><span class="n">defaultDeltas</span><span class="p">)</span>

    <span class="c1"># setCoordinates also sets the hmtx/vmtx advance widths and sidebearings from</span>
    <span class="c1"># the four phantom points and glyph bounding boxes.</span>
    <span class="c1"># We call it unconditionally even if a glyph has no variations or no deltas are</span>
    <span class="c1"># applied at this location, in case the glyph&#39;s xMin and in turn its sidebearing</span>
    <span class="c1"># have changed. E.g. a composite glyph has no deltas for the component&#39;s (x, y)</span>
    <span class="c1"># offset nor for the 4 phantom points (e.g. it&#39;s monospaced). Thus its entry in</span>
    <span class="c1"># gvar table is empty; however, the composite&#39;s base glyph may have deltas</span>
    <span class="c1"># applied, hence the composite&#39;s bbox and left/top sidebearings may need updating</span>
    <span class="c1"># in the instanced font.</span>
    <span class="n">glyf</span><span class="o">.</span><span class="n">setCoordinates</span><span class="p">(</span><span class="n">glyphname</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">varfont</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tupleVarStore</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">glyphname</span> <span class="ow">in</span> <span class="n">gvar</span><span class="o">.</span><span class="n">variations</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">gvar</span><span class="o">.</span><span class="n">variations</span><span class="p">[</span><span class="n">glyphname</span><span class="p">]</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">optimize</span><span class="p">:</span>
        <span class="n">isComposite</span> <span class="o">=</span> <span class="n">glyf</span><span class="p">[</span><span class="n">glyphname</span><span class="p">]</span><span class="o">.</span><span class="n">isComposite</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">tupleVarStore</span><span class="p">:</span>
            <span class="n">var</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">endPts</span><span class="p">,</span> <span class="n">isComposite</span><span class="p">)</span></div>


<div class="viewcode-block" id="instantiateGvar"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateGvar">[docs]</a><span class="k">def</span> <span class="nf">instantiateGvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating glyf/gvar tables&quot;</span><span class="p">)</span>

    <span class="n">gvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;gvar&quot;</span><span class="p">]</span>
    <span class="n">glyf</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;glyf&quot;</span><span class="p">]</span>
    <span class="c1"># Get list of glyph names sorted by component depth.</span>
    <span class="c1"># If a composite glyph is processed before its base glyph, the bounds may</span>
    <span class="c1"># be calculated incorrectly because deltas haven&#39;t been applied to the</span>
    <span class="c1"># base glyph yet.</span>
    <span class="n">glyphnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="n">glyf</span><span class="o">.</span><span class="n">glyphOrder</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">glyf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">getCompositeMaxpValues</span><span class="p">(</span><span class="n">glyf</span><span class="p">)</span><span class="o">.</span><span class="n">maxComponentDepth</span>
            <span class="k">if</span> <span class="n">glyf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">isComposite</span><span class="p">()</span>
            <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">glyphname</span> <span class="ow">in</span> <span class="n">glyphnames</span><span class="p">:</span>
        <span class="n">instantiateGvarGlyph</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">glyphname</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="n">optimize</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">gvar</span><span class="o">.</span><span class="n">variations</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;gvar&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="setCvarDeltas"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.setCvarDeltas">[docs]</a><span class="k">def</span> <span class="nf">setCvarDeltas</span><span class="p">(</span><span class="n">cvt</span><span class="p">,</span> <span class="n">deltas</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">delta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deltas</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">delta</span><span class="p">:</span>
            <span class="n">cvt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">otRound</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span></div>


<div class="viewcode-block" id="instantiateCvar"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateCvar">[docs]</a><span class="k">def</span> <span class="nf">instantiateCvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating cvt/cvar tables&quot;</span><span class="p">)</span>

    <span class="n">cvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;cvar&quot;</span><span class="p">]</span>

    <span class="n">defaultDeltas</span> <span class="o">=</span> <span class="n">instantiateTupleVariationStore</span><span class="p">(</span><span class="n">cvar</span><span class="o">.</span><span class="n">variations</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">defaultDeltas</span><span class="p">:</span>
        <span class="n">setCvarDeltas</span><span class="p">(</span><span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;cvt &quot;</span><span class="p">],</span> <span class="n">defaultDeltas</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cvar</span><span class="o">.</span><span class="n">variations</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;cvar&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="setMvarDeltas"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.setMvarDeltas">[docs]</a><span class="k">def</span> <span class="nf">setMvarDeltas</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">deltas</span><span class="p">):</span>
    <span class="n">mvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;MVAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">mvar</span><span class="o">.</span><span class="n">ValueRecord</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="n">mvarTag</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">ValueTag</span>
        <span class="k">if</span> <span class="n">mvarTag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MVAR_ENTRIES</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tableTag</span><span class="p">,</span> <span class="n">itemName</span> <span class="o">=</span> <span class="n">MVAR_ENTRIES</span><span class="p">[</span><span class="n">mvarTag</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">deltas</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">VarIdx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="n">varfont</span><span class="p">[</span><span class="n">tableTag</span><span class="p">],</span>
                <span class="n">itemName</span><span class="p">,</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="n">varfont</span><span class="p">[</span><span class="n">tableTag</span><span class="p">],</span> <span class="n">itemName</span><span class="p">)</span> <span class="o">+</span> <span class="n">otRound</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="instantiateMVAR"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateMVAR">[docs]</a><span class="k">def</span> <span class="nf">instantiateMVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating MVAR table&quot;</span><span class="p">)</span>

    <span class="n">mvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;MVAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
    <span class="n">fvarAxes</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>
    <span class="n">varStore</span> <span class="o">=</span> <span class="n">mvar</span><span class="o">.</span><span class="n">VarStore</span>
    <span class="n">defaultDeltas</span> <span class="o">=</span> <span class="n">instantiateItemVariationStore</span><span class="p">(</span><span class="n">varStore</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>
    <span class="n">setMvarDeltas</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">defaultDeltas</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">varStore</span><span class="o">.</span><span class="n">VarRegionList</span><span class="o">.</span><span class="n">Region</span><span class="p">:</span>
        <span class="n">varIndexMapping</span> <span class="o">=</span> <span class="n">varStore</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">mvar</span><span class="o">.</span><span class="n">ValueRecord</span><span class="p">:</span>
            <span class="n">rec</span><span class="o">.</span><span class="n">VarIdx</span> <span class="o">=</span> <span class="n">varIndexMapping</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">VarIdx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;MVAR&quot;</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_remapVarIdxMap</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">attrName</span><span class="p">,</span> <span class="n">varIndexMapping</span><span class="p">,</span> <span class="n">glyphOrder</span><span class="p">):</span>
    <span class="n">oldMapping</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">attrName</span><span class="p">)</span><span class="o">.</span><span class="n">mapping</span>
    <span class="n">newMapping</span> <span class="o">=</span> <span class="p">[</span><span class="n">varIndexMapping</span><span class="p">[</span><span class="n">oldMapping</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]]</span> <span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyphOrder</span><span class="p">]</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">attrName</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">buildVarIdxMap</span><span class="p">(</span><span class="n">newMapping</span><span class="p">,</span> <span class="n">glyphOrder</span><span class="p">))</span>


<span class="c1"># TODO(anthrotype) Add support for HVAR/VVAR in CFF2</span>
<span class="k">def</span> <span class="nf">_instantiateVHVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">tableFields</span><span class="p">):</span>
    <span class="n">tableTag</span> <span class="o">=</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">tableTag</span>
    <span class="n">fvarAxes</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>
    <span class="c1"># Deltas from gvar table have already been applied to the hmtx/vmtx. For full</span>
    <span class="c1"># instances (i.e. all axes pinned), we can simply drop HVAR/VVAR and return</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">axisTag</span> <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">axisLimits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">axisTag</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">fvarAxes</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropping </span><span class="si">%s</span><span class="s2"> table&quot;</span><span class="p">,</span> <span class="n">tableTag</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="n">tableTag</span><span class="p">]</span>
        <span class="k">return</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating </span><span class="si">%s</span><span class="s2"> table&quot;</span><span class="p">,</span> <span class="n">tableTag</span><span class="p">)</span>
    <span class="n">vhvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="n">tableTag</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
    <span class="n">varStore</span> <span class="o">=</span> <span class="n">vhvar</span><span class="o">.</span><span class="n">VarStore</span>
    <span class="c1"># since deltas were already applied, the return value here is ignored</span>
    <span class="n">instantiateItemVariationStore</span><span class="p">(</span><span class="n">varStore</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">varStore</span><span class="o">.</span><span class="n">VarRegionList</span><span class="o">.</span><span class="n">Region</span><span class="p">:</span>
        <span class="c1"># Only re-optimize VarStore if the HVAR/VVAR already uses indirect AdvWidthMap</span>
        <span class="c1"># or AdvHeightMap. If a direct, implicit glyphID-&gt;VariationIndex mapping is</span>
        <span class="c1"># used for advances, skip re-optimizing and maintain original VariationIndex.</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">advMapping</span><span class="p">):</span>
            <span class="n">varIndexMapping</span> <span class="o">=</span> <span class="n">varStore</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
            <span class="n">glyphOrder</span> <span class="o">=</span> <span class="n">varfont</span><span class="o">.</span><span class="n">getGlyphOrder</span><span class="p">()</span>
            <span class="n">_remapVarIdxMap</span><span class="p">(</span><span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">advMapping</span><span class="p">,</span> <span class="n">varIndexMapping</span><span class="p">,</span> <span class="n">glyphOrder</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">sb1</span><span class="p">):</span>  <span class="c1"># left or top sidebearings</span>
                <span class="n">_remapVarIdxMap</span><span class="p">(</span><span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">sb1</span><span class="p">,</span> <span class="n">varIndexMapping</span><span class="p">,</span> <span class="n">glyphOrder</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">sb2</span><span class="p">):</span>  <span class="c1"># right or bottom sidebearings</span>
                <span class="n">_remapVarIdxMap</span><span class="p">(</span><span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">sb2</span><span class="p">,</span> <span class="n">varIndexMapping</span><span class="p">,</span> <span class="n">glyphOrder</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tableTag</span> <span class="o">==</span> <span class="s2">&quot;VVAR&quot;</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">vOrigMapping</span><span class="p">):</span>
                <span class="n">_remapVarIdxMap</span><span class="p">(</span>
                    <span class="n">vhvar</span><span class="p">,</span> <span class="n">tableFields</span><span class="o">.</span><span class="n">vOrigMapping</span><span class="p">,</span> <span class="n">varIndexMapping</span><span class="p">,</span> <span class="n">glyphOrder</span>
                <span class="p">)</span>


<div class="viewcode-block" id="instantiateHVAR"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateHVAR">[docs]</a><span class="k">def</span> <span class="nf">instantiateHVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_instantiateVHVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">varLib</span><span class="o">.</span><span class="n">HVAR_FIELDS</span><span class="p">)</span></div>


<div class="viewcode-block" id="instantiateVVAR"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateVVAR">[docs]</a><span class="k">def</span> <span class="nf">instantiateVVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_instantiateVHVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">varLib</span><span class="o">.</span><span class="n">VVAR_FIELDS</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">_TupleVarStoreAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">axisOrder</span><span class="p">,</span> <span class="n">tupleVarData</span><span class="p">,</span> <span class="n">itemCounts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axisOrder</span> <span class="o">=</span> <span class="n">axisOrder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tupleVarData</span> <span class="o">=</span> <span class="n">tupleVarData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemCounts</span> <span class="o">=</span> <span class="n">itemCounts</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromItemVarStore</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">itemVarStore</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">):</span>
        <span class="n">axisOrder</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">axisTag</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">fvarAxes</span><span class="p">]</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">region</span><span class="o">.</span><span class="n">get_support</span><span class="p">(</span><span class="n">fvarAxes</span><span class="p">)</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">itemVarStore</span><span class="o">.</span><span class="n">VarRegionList</span><span class="o">.</span><span class="n">Region</span>
        <span class="p">]</span>
        <span class="n">tupleVarData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">itemCounts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">varData</span> <span class="ow">in</span> <span class="n">itemVarStore</span><span class="o">.</span><span class="n">VarData</span><span class="p">:</span>
            <span class="n">variations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">varDataRegions</span> <span class="o">=</span> <span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">varData</span><span class="o">.</span><span class="n">VarRegionIndex</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axes</span><span class="p">,</span> <span class="n">coordinates</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">varDataRegions</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">varData</span><span class="o">.</span><span class="n">Item</span><span class="p">)):</span>
                <span class="n">variations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TupleVariation</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)))</span>
            <span class="n">tupleVarData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">variations</span><span class="p">)</span>
            <span class="n">itemCounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varData</span><span class="o">.</span><span class="n">ItemCount</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">axisOrder</span><span class="p">,</span> <span class="n">tupleVarData</span><span class="p">,</span> <span class="n">itemCounts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rebuildRegions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Collect the set of all unique region axes from the current TupleVariations.</span>
        <span class="c1"># We use an OrderedDict to de-duplicate regions while keeping the order.</span>
        <span class="n">uniqueRegions</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="nb">frozenset</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">variations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tupleVarData</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variations</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Maintain the original order for the regions that pre-existed, appending</span>
        <span class="c1"># the new regions at the end of the region list.</span>
        <span class="n">newRegions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">:</span>
            <span class="n">regionAxes</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">regionAxes</span> <span class="ow">in</span> <span class="n">uniqueRegions</span><span class="p">:</span>
                <span class="n">newRegions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">uniqueRegions</span><span class="p">[</span><span class="n">regionAxes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">uniqueRegions</span><span class="p">:</span>
            <span class="n">newRegions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">uniqueRegions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">newRegions</span>

    <span class="k">def</span> <span class="nf">instantiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
        <span class="n">defaultDeltaArray</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">variations</span><span class="p">,</span> <span class="n">itemCount</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tupleVarData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemCounts</span><span class="p">):</span>
            <span class="n">defaultDeltas</span> <span class="o">=</span> <span class="n">instantiateTupleVariationStore</span><span class="p">(</span><span class="n">variations</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">defaultDeltas</span><span class="p">:</span>
                <span class="n">defaultDeltas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">itemCount</span>
            <span class="n">defaultDeltaArray</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">defaultDeltas</span><span class="p">)</span>

        <span class="c1"># rebuild regions whose axes were dropped or limited</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebuildRegions</span><span class="p">()</span>

        <span class="n">pinnedAxes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">axisTag</span>
            <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">axisLimits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axisOrder</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">axisTag</span> <span class="k">for</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axisOrder</span> <span class="k">if</span> <span class="n">axisTag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pinnedAxes</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">defaultDeltaArray</span>

    <span class="k">def</span> <span class="nf">asItemVarStore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">regionOrder</span> <span class="o">=</span> <span class="p">[</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">for</span> <span class="n">axes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">]</span>
        <span class="n">varDatas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">variations</span><span class="p">,</span> <span class="n">itemCount</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tupleVarData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemCounts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">variations</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">variations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">==</span> <span class="n">itemCount</span>
                <span class="n">varRegionIndices</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">regionOrder</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variations</span>
                <span class="p">]</span>
                <span class="n">varDataItems</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">coordinates</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variations</span><span class="p">)))</span>
                <span class="n">varDatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">builder</span><span class="o">.</span><span class="n">buildVarData</span><span class="p">(</span><span class="n">varRegionIndices</span><span class="p">,</span> <span class="n">varDataItems</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">varDatas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">builder</span><span class="o">.</span><span class="n">buildVarData</span><span class="p">([],</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">itemCount</span><span class="p">)])</span>
                <span class="p">)</span>
        <span class="n">regionList</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">buildVarRegionList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axisOrder</span><span class="p">)</span>
        <span class="n">itemVarStore</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">buildVarStore</span><span class="p">(</span><span class="n">regionList</span><span class="p">,</span> <span class="n">varDatas</span><span class="p">)</span>
        <span class="c1"># remove unused regions from VarRegionList</span>
        <span class="n">itemVarStore</span><span class="o">.</span><span class="n">prune_regions</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">itemVarStore</span>


<div class="viewcode-block" id="instantiateItemVariationStore"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateItemVariationStore">[docs]</a><span class="k">def</span> <span class="nf">instantiateItemVariationStore</span><span class="p">(</span><span class="n">itemVarStore</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute deltas at partial location, and update varStore in-place.</span>

<span class="sd">    Remove regions in which all axes were instanced, or fall outside the new axis</span>
<span class="sd">    limits. Scale the deltas of the remaining regions where only some of the axes</span>
<span class="sd">    were instanced.</span>

<span class="sd">    The number of VarData subtables, and the number of items within each, are</span>
<span class="sd">    not modified, in order to keep the existing VariationIndex valid.</span>
<span class="sd">    One may call VarStore.optimize() method after this to further optimize those.</span>

<span class="sd">    Args:</span>
<span class="sd">        varStore: An otTables.VarStore object (Item Variation Store)</span>
<span class="sd">        fvarAxes: list of fvar&#39;s Axis objects</span>
<span class="sd">        axisLimits: Dict[str, float] mapping axis tags to normalized axis coordinates</span>
<span class="sd">            (float) or ranges for restricting an axis&#39; min/max (NormalizedAxisRange).</span>
<span class="sd">            May not specify coordinates/ranges for all the fvar axes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        defaultDeltas: to be added to the default instance, of type dict of floats</span>
<span class="sd">            keyed by VariationIndex compound values: i.e. (outer &lt;&lt; 16) + inner.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tupleVarStore</span> <span class="o">=</span> <span class="n">_TupleVarStoreAdapter</span><span class="o">.</span><span class="n">fromItemVarStore</span><span class="p">(</span><span class="n">itemVarStore</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">)</span>
    <span class="n">defaultDeltaArray</span> <span class="o">=</span> <span class="n">tupleVarStore</span><span class="o">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">axisLimits</span><span class="p">)</span>
    <span class="n">newItemVarStore</span> <span class="o">=</span> <span class="n">tupleVarStore</span><span class="o">.</span><span class="n">asItemVarStore</span><span class="p">()</span>

    <span class="n">itemVarStore</span><span class="o">.</span><span class="n">VarRegionList</span> <span class="o">=</span> <span class="n">newItemVarStore</span><span class="o">.</span><span class="n">VarRegionList</span>
    <span class="k">assert</span> <span class="n">itemVarStore</span><span class="o">.</span><span class="n">VarDataCount</span> <span class="o">==</span> <span class="n">newItemVarStore</span><span class="o">.</span><span class="n">VarDataCount</span>
    <span class="n">itemVarStore</span><span class="o">.</span><span class="n">VarData</span> <span class="o">=</span> <span class="n">newItemVarStore</span><span class="o">.</span><span class="n">VarData</span>

    <span class="n">defaultDeltas</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">((</span><span class="n">major</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">minor</span><span class="p">):</span> <span class="n">delta</span>
        <span class="k">for</span> <span class="n">major</span><span class="p">,</span> <span class="n">deltas</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">defaultDeltaArray</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">minor</span><span class="p">,</span> <span class="n">delta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">defaultDeltas</span></div>


<div class="viewcode-block" id="instantiateOTL"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateOTL">[docs]</a><span class="k">def</span> <span class="nf">instantiateOTL</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="c1"># TODO(anthrotype) Support partial instancing of JSTF and BASE tables</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="s2">&quot;GDEF&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varfont</span>
        <span class="ow">or</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;GDEF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Version</span> <span class="o">&lt;</span> <span class="mh">0x00010003</span>
        <span class="ow">or</span> <span class="ow">not</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;GDEF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">VarStore</span>
    <span class="p">):</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="s2">&quot;GPOS&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Instantiating GDEF and GPOS tables&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Instantiating GDEF table&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">gdef</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;GDEF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
    <span class="n">varStore</span> <span class="o">=</span> <span class="n">gdef</span><span class="o">.</span><span class="n">VarStore</span>
    <span class="n">fvarAxes</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span>

    <span class="n">defaultDeltas</span> <span class="o">=</span> <span class="n">instantiateItemVariationStore</span><span class="p">(</span><span class="n">varStore</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="c1"># When VF are built, big lookups may overflow and be broken into multiple</span>
    <span class="c1"># subtables. MutatorMerger (which inherits from AligningMerger) reattaches</span>
    <span class="c1"># them upon instancing, in case they can now fit a single subtable (if not,</span>
    <span class="c1"># they will be split again upon compilation).</span>
    <span class="c1"># This &#39;merger&#39; also works as a &#39;visitor&#39; that traverses the OTL tables and</span>
    <span class="c1"># calls specific methods when instances of a given type are found.</span>
    <span class="c1"># Specifically, it adds default deltas to GPOS Anchors/ValueRecords and GDEF</span>
    <span class="c1"># LigatureCarets, and optionally deletes all VariationIndex tables if the</span>
    <span class="c1"># VarStore is fully instanced.</span>
    <span class="n">merger</span> <span class="o">=</span> <span class="n">MutatorMerger</span><span class="p">(</span>
        <span class="n">varfont</span><span class="p">,</span> <span class="n">defaultDeltas</span><span class="p">,</span> <span class="n">deleteVariations</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">varStore</span><span class="o">.</span><span class="n">VarRegionList</span><span class="o">.</span><span class="n">Region</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">merger</span><span class="o">.</span><span class="n">mergeTables</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="p">[</span><span class="n">varfont</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;GDEF&quot;</span><span class="p">,</span> <span class="s2">&quot;GPOS&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">varStore</span><span class="o">.</span><span class="n">VarRegionList</span><span class="o">.</span><span class="n">Region</span><span class="p">:</span>
        <span class="n">varIndexMapping</span> <span class="o">=</span> <span class="n">varStore</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>
        <span class="n">gdef</span><span class="o">.</span><span class="n">remap_device_varidxes</span><span class="p">(</span><span class="n">varIndexMapping</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;GPOS&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
            <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;GPOS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">remap_device_varidxes</span><span class="p">(</span><span class="n">varIndexMapping</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Downgrade GDEF.</span>
        <span class="k">del</span> <span class="n">gdef</span><span class="o">.</span><span class="n">VarStore</span>
        <span class="n">gdef</span><span class="o">.</span><span class="n">Version</span> <span class="o">=</span> <span class="mh">0x00010002</span>
        <span class="k">if</span> <span class="n">gdef</span><span class="o">.</span><span class="n">MarkGlyphSetsDef</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">gdef</span><span class="o">.</span><span class="n">MarkGlyphSetsDef</span>
            <span class="n">gdef</span><span class="o">.</span><span class="n">Version</span> <span class="o">=</span> <span class="mh">0x00010000</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">gdef</span><span class="o">.</span><span class="n">LigCaretList</span>
            <span class="ow">or</span> <span class="n">gdef</span><span class="o">.</span><span class="n">MarkAttachClassDef</span>
            <span class="ow">or</span> <span class="n">gdef</span><span class="o">.</span><span class="n">GlyphClassDef</span>
            <span class="ow">or</span> <span class="n">gdef</span><span class="o">.</span><span class="n">AttachList</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">gdef</span><span class="o">.</span><span class="n">Version</span> <span class="o">&gt;=</span> <span class="mh">0x00010002</span> <span class="ow">and</span> <span class="n">gdef</span><span class="o">.</span><span class="n">MarkGlyphSetsDef</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;GDEF&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="instantiateFeatureVariations"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateFeatureVariations">[docs]</a><span class="k">def</span> <span class="nf">instantiateFeatureVariations</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">tableTag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GPOS&quot;</span><span class="p">,</span> <span class="s2">&quot;GSUB&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tableTag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varfont</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="n">varfont</span><span class="p">[</span><span class="n">tableTag</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;FeatureVariations&quot;</span>
        <span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating FeatureVariations of </span><span class="si">%s</span><span class="s2"> table&quot;</span><span class="p">,</span> <span class="n">tableTag</span><span class="p">)</span>
        <span class="n">_instantiateFeatureVariations</span><span class="p">(</span>
            <span class="n">varfont</span><span class="p">[</span><span class="n">tableTag</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">axisLimits</span>
        <span class="p">)</span>
        <span class="c1"># remove unreferenced lookups</span>
        <span class="n">varfont</span><span class="p">[</span><span class="n">tableTag</span><span class="p">]</span><span class="o">.</span><span class="n">prune_lookups</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_featureVariationRecordIsUnique</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
    <span class="n">conditionSet</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">ConditionSet</span><span class="o">.</span><span class="n">ConditionTable</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">Format</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># can&#39;t tell whether this is duplicate, assume is unique</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">conditionSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">,</span> <span class="n">cond</span><span class="o">.</span><span class="n">FilterRangeMinValue</span><span class="p">,</span> <span class="n">cond</span><span class="o">.</span><span class="n">FilterRangeMaxValue</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># besides the set of conditions, we also include the FeatureTableSubstitution</span>
    <span class="c1"># version to identify unique FeatureVariationRecords, even though only one</span>
    <span class="c1"># version is currently defined. It&#39;s theoretically possible that multiple</span>
    <span class="c1"># records with same conditions but different substitution table version be</span>
    <span class="c1"># present in the same font for backward compatibility.</span>
    <span class="n">recordKey</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">([</span><span class="n">rec</span><span class="o">.</span><span class="n">FeatureTableSubstitution</span><span class="o">.</span><span class="n">Version</span><span class="p">]</span> <span class="o">+</span> <span class="n">conditionSet</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">recordKey</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">recordKey</span><span class="p">)</span>  <span class="c1"># side effect</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_limitFeatureVariationConditionRange</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">axisRange</span><span class="p">):</span>
    <span class="n">minValue</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">FilterRangeMinValue</span>
    <span class="n">maxValue</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">FilterRangeMaxValue</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">minValue</span> <span class="o">&gt;</span> <span class="n">maxValue</span>
        <span class="ow">or</span> <span class="n">minValue</span> <span class="o">&gt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span>
        <span class="ow">or</span> <span class="n">maxValue</span> <span class="o">&lt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span>
    <span class="p">):</span>
        <span class="c1"># condition invalid or out of range</span>
        <span class="k">return</span>

    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">minValue</span><span class="p">,</span> <span class="n">maxValue</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newValue</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newValue</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newValue</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">newValue</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newValue</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newValue</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span>
                <span class="k">if</span> <span class="n">newValue</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">newValue</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newValue</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">newValue</span>

    <span class="k">return</span> <span class="n">AxisRange</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_instantiateFeatureVariationRecord</span><span class="p">(</span>
    <span class="n">record</span><span class="p">,</span> <span class="n">recIdx</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">,</span> <span class="n">axisIndexMap</span>
<span class="p">):</span>
    <span class="n">applies</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">newConditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">ConditionSet</span><span class="o">.</span><span class="n">ConditionTable</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">condition</span><span class="o">.</span><span class="n">Format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axisIdx</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">AxisIndex</span>
            <span class="n">axisTag</span> <span class="o">=</span> <span class="n">fvarAxes</span><span class="p">[</span><span class="n">axisIdx</span><span class="p">]</span><span class="o">.</span><span class="n">axisTag</span>
            <span class="k">if</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">location</span><span class="p">:</span>
                <span class="n">minValue</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">FilterRangeMinValue</span>
                <span class="n">maxValue</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">FilterRangeMaxValue</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">location</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">minValue</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">maxValue</span><span class="p">):</span>
                    <span class="c1"># condition not met so remove entire record</span>
                    <span class="n">applies</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">newConditions</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># axis not pinned, keep condition with remapped axis index</span>
                <span class="n">applies</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">condition</span><span class="o">.</span><span class="n">AxisIndex</span> <span class="o">=</span> <span class="n">axisIndexMap</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
                <span class="n">newConditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Condition table </span><span class="si">{0}</span><span class="s2"> of FeatureVariationRecord </span><span class="si">{1}</span><span class="s2"> has &quot;</span>
                <span class="s2">&quot;unsupported format (</span><span class="si">{2}</span><span class="s2">); ignored&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">recIdx</span><span class="p">,</span> <span class="n">condition</span><span class="o">.</span><span class="n">Format</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">applies</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">newConditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newConditions</span><span class="p">:</span>
        <span class="n">record</span><span class="o">.</span><span class="n">ConditionSet</span><span class="o">.</span><span class="n">ConditionTable</span> <span class="o">=</span> <span class="n">newConditions</span>
        <span class="n">shouldKeep</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shouldKeep</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">applies</span><span class="p">,</span> <span class="n">shouldKeep</span>


<span class="k">def</span> <span class="nf">_limitFeatureVariationRecord</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">axisRanges</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">):</span>
    <span class="n">newConditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">ConditionSet</span><span class="o">.</span><span class="n">ConditionTable</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">condition</span><span class="o">.</span><span class="n">Format</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axisIdx</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">AxisIndex</span>
            <span class="n">axisTag</span> <span class="o">=</span> <span class="n">fvarAxes</span><span class="p">[</span><span class="n">axisIdx</span><span class="p">]</span><span class="o">.</span><span class="n">axisTag</span>
            <span class="k">if</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">axisRanges</span><span class="p">:</span>
                <span class="n">axisRange</span> <span class="o">=</span> <span class="n">axisRanges</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
                <span class="n">newRange</span> <span class="o">=</span> <span class="n">_limitFeatureVariationConditionRange</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">axisRange</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newRange</span><span class="p">:</span>
                    <span class="c1"># keep condition with updated limits and remapped axis index</span>
                    <span class="n">condition</span><span class="o">.</span><span class="n">FilterRangeMinValue</span> <span class="o">=</span> <span class="n">newRange</span><span class="o">.</span><span class="n">minimum</span>
                    <span class="n">condition</span><span class="o">.</span><span class="n">FilterRangeMaxValue</span> <span class="o">=</span> <span class="n">newRange</span><span class="o">.</span><span class="n">maximum</span>
                    <span class="n">newConditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># condition out of range, remove entire record</span>
                    <span class="n">newConditions</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newConditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newConditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newConditions</span><span class="p">:</span>
        <span class="n">record</span><span class="o">.</span><span class="n">ConditionSet</span><span class="o">.</span><span class="n">ConditionTable</span> <span class="o">=</span> <span class="n">newConditions</span>
        <span class="n">shouldKeep</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shouldKeep</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">shouldKeep</span>


<span class="k">def</span> <span class="nf">_instantiateFeatureVariations</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="n">location</span><span class="p">,</span> <span class="n">axisRanges</span> <span class="o">=</span> <span class="n">splitAxisLocationAndRanges</span><span class="p">(</span>
        <span class="n">axisLimits</span><span class="p">,</span> <span class="n">rangeType</span><span class="o">=</span><span class="n">NormalizedAxisRange</span>
    <span class="p">)</span>
    <span class="n">pinnedAxes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">axisOrder</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="o">.</span><span class="n">axisTag</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">fvarAxes</span> <span class="k">if</span> <span class="n">axis</span><span class="o">.</span><span class="n">axisTag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pinnedAxes</span><span class="p">]</span>
    <span class="n">axisIndexMap</span> <span class="o">=</span> <span class="p">{</span><span class="n">axisTag</span><span class="p">:</span> <span class="n">axisOrder</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">axisTag</span><span class="p">)</span> <span class="k">for</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">axisOrder</span><span class="p">}</span>

    <span class="n">featureVariationApplied</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">uniqueRecords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">newRecords</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">FeatureVariations</span><span class="o">.</span><span class="n">FeatureVariationRecord</span><span class="p">):</span>
        <span class="n">applies</span><span class="p">,</span> <span class="n">shouldKeep</span> <span class="o">=</span> <span class="n">_instantiateFeatureVariationRecord</span><span class="p">(</span>
            <span class="n">record</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">,</span> <span class="n">axisIndexMap</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">shouldKeep</span><span class="p">:</span>
            <span class="n">shouldKeep</span> <span class="o">=</span> <span class="n">_limitFeatureVariationRecord</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">axisRanges</span><span class="p">,</span> <span class="n">fvarAxes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shouldKeep</span> <span class="ow">and</span> <span class="n">_featureVariationRecordIsUnique</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">uniqueRecords</span><span class="p">):</span>
            <span class="n">newRecords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">applies</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">featureVariationApplied</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">record</span><span class="o">.</span><span class="n">FeatureTableSubstitution</span><span class="o">.</span><span class="n">Version</span> <span class="o">==</span> <span class="mh">0x00010000</span>
            <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">FeatureTableSubstitution</span><span class="o">.</span><span class="n">SubstitutionRecord</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">FeatureList</span><span class="o">.</span><span class="n">FeatureRecord</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">FeatureIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Feature</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">Feature</span>
            <span class="c1"># Set variations only once</span>
            <span class="n">featureVariationApplied</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">newRecords</span><span class="p">:</span>
        <span class="n">table</span><span class="o">.</span><span class="n">FeatureVariations</span><span class="o">.</span><span class="n">FeatureVariationRecord</span> <span class="o">=</span> <span class="n">newRecords</span>
        <span class="n">table</span><span class="o">.</span><span class="n">FeatureVariations</span><span class="o">.</span><span class="n">FeatureVariationCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newRecords</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">table</span><span class="o">.</span><span class="n">FeatureVariations</span>


<span class="k">def</span> <span class="nf">_isValidAvarSegmentMap</span><span class="p">(</span><span class="n">axisTag</span><span class="p">,</span> <span class="n">segmentMap</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">segmentMap</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">{(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">segmentMap</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="n">f</span><span class="s2">&quot;Invalid avar SegmentMap record for axis &#39;</span><span class="si">{axisTag}</span><span class="s2">&#39;: does not &quot;</span>
            <span class="s2">&quot;include all required value maps {-1.0: -1.0, 0: 0, 1.0: 1.0}&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">previousValue</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">fromCoord</span><span class="p">,</span> <span class="n">toCoord</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">segmentMap</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">previousValue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">previousValue</span> <span class="o">&gt;</span> <span class="n">toCoord</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Invalid avar AxisValueMap(</span><span class="si">{fromCoord}</span><span class="s2">, </span><span class="si">{toCoord}</span><span class="s2">) record &quot;</span>
                <span class="n">f</span><span class="s2">&quot;for axis &#39;</span><span class="si">{axisTag}</span><span class="s2">&#39;: the toCoordinate value must be &gt;= to &quot;</span>
                <span class="n">f</span><span class="s2">&quot;the toCoordinate value of the preceding record (</span><span class="si">{previousValue}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">previousValue</span> <span class="o">=</span> <span class="n">toCoord</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="instantiateAvar"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateAvar">[docs]</a><span class="k">def</span> <span class="nf">instantiateAvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="c1"># &#39;axisLimits&#39; dict must contain user-space (non-normalized) coordinates.</span>

    <span class="n">location</span><span class="p">,</span> <span class="n">axisRanges</span> <span class="o">=</span> <span class="n">splitAxisLocationAndRanges</span><span class="p">(</span><span class="n">axisLimits</span><span class="p">)</span>

    <span class="n">segments</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;avar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">segments</span>

    <span class="c1"># drop table if we instantiate all the axes</span>
    <span class="n">pinnedAxes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">pinnedAxes</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">segments</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropping avar table&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;avar&quot;</span><span class="p">]</span>
        <span class="k">return</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating avar table&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">pinnedAxes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">segments</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>

    <span class="c1"># First compute the default normalization for axisRanges coordinates: i.e.</span>
    <span class="c1"># min = -1.0, default = 0, max = +1.0, and in between values interpolated linearly,</span>
    <span class="c1"># without using the avar table&#39;s mappings.</span>
    <span class="c1"># Then, for each SegmentMap, if we are restricting its axis, compute the new</span>
    <span class="c1"># mappings by dividing the key/value pairs by the desired new min/max values,</span>
    <span class="c1"># dropping any mappings that fall outside the restricted range.</span>
    <span class="c1"># The keys (&#39;fromCoord&#39;) are specified in default normalized coordinate space,</span>
    <span class="c1"># whereas the values (&#39;toCoord&#39;) are &quot;mapped forward&quot; using the SegmentMap.</span>
    <span class="n">normalizedRanges</span> <span class="o">=</span> <span class="n">normalizeAxisLimits</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisRanges</span><span class="p">,</span> <span class="n">usingAvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">newSegments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">segments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_isValidAvarSegmentMap</span><span class="p">(</span><span class="n">axisTag</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">mapping</span> <span class="ow">and</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">normalizedRanges</span><span class="p">:</span>
            <span class="n">axisRange</span> <span class="o">=</span> <span class="n">normalizedRanges</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
            <span class="n">mappedMin</span> <span class="o">=</span> <span class="n">floatToFixedToFloat</span><span class="p">(</span>
                <span class="n">piecewiseLinearMap</span><span class="p">(</span><span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span> <span class="mi">14</span>
            <span class="p">)</span>
            <span class="n">mappedMax</span> <span class="o">=</span> <span class="n">floatToFixedToFloat</span><span class="p">(</span>
                <span class="n">piecewiseLinearMap</span><span class="p">(</span><span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span><span class="p">,</span> <span class="n">mapping</span><span class="p">),</span> <span class="mi">14</span>
            <span class="p">)</span>
            <span class="n">newMapping</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">fromCoord</span><span class="p">,</span> <span class="n">toCoord</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">fromCoord</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">fromCoord</span> <span class="o">&lt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fromCoord</span> <span class="o">/=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">fromCoord</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">fromCoord</span> <span class="o">&gt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fromCoord</span> <span class="o">/=</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span>
                <span class="k">if</span> <span class="n">toCoord</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">mappedMin</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="k">assert</span> <span class="n">toCoord</span> <span class="o">&gt;=</span> <span class="n">mappedMin</span>
                    <span class="n">toCoord</span> <span class="o">/=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mappedMin</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">toCoord</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">mappedMax</span> <span class="o">!=</span> <span class="mi">0</span>
                    <span class="k">assert</span> <span class="n">toCoord</span> <span class="o">&lt;=</span> <span class="n">mappedMax</span>
                    <span class="n">toCoord</span> <span class="o">/=</span> <span class="n">mappedMax</span>
                <span class="n">fromCoord</span> <span class="o">=</span> <span class="n">floatToFixedToFloat</span><span class="p">(</span><span class="n">fromCoord</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
                <span class="n">toCoord</span> <span class="o">=</span> <span class="n">floatToFixedToFloat</span><span class="p">(</span><span class="n">toCoord</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
                <span class="n">newMapping</span><span class="p">[</span><span class="n">fromCoord</span><span class="p">]</span> <span class="o">=</span> <span class="n">toCoord</span>
            <span class="n">newMapping</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="o">-</span><span class="mf">1.0</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">})</span>
            <span class="n">newSegments</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">newMapping</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newSegments</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span>
    <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;avar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="n">newSegments</span></div>


<div class="viewcode-block" id="isInstanceWithinAxisRanges"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.isInstanceWithinAxisRanges">[docs]</a><span class="k">def</span> <span class="nf">isInstanceWithinAxisRanges</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">axisRanges</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">location</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">axisRanges</span><span class="p">:</span>
            <span class="n">axisRange</span> <span class="o">=</span> <span class="n">axisRanges</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">coord</span> <span class="o">&lt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span> <span class="ow">or</span> <span class="n">coord</span> <span class="o">&gt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="instantiateFvar"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateFvar">[docs]</a><span class="k">def</span> <span class="nf">instantiateFvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="c1"># &#39;axisLimits&#39; dict must contain user-space (non-normalized) coordinates</span>

    <span class="n">location</span><span class="p">,</span> <span class="n">axisRanges</span> <span class="o">=</span> <span class="n">splitAxisLocationAndRanges</span><span class="p">(</span><span class="n">axisLimits</span><span class="p">,</span> <span class="n">rangeType</span><span class="o">=</span><span class="n">AxisRange</span><span class="p">)</span>

    <span class="n">fvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span>

    <span class="c1"># drop table if we instantiate all the axes</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">axisTag</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropping fvar table&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span>
        <span class="k">return</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating fvar table&quot;</span><span class="p">)</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
        <span class="n">axisTag</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">axisTag</span>
        <span class="k">if</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">location</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">axisRanges</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">minValue</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">maxValue</span> <span class="o">=</span> <span class="n">axisRanges</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">fvar</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span>

    <span class="c1"># only keep NamedInstances whose coordinates == pinned axis location</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span> <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">location</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">location</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">instance</span><span class="o">.</span><span class="n">coordinates</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isInstanceWithinAxisRanges</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">axisRanges</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
    <span class="n">fvar</span><span class="o">.</span><span class="n">instances</span> <span class="o">=</span> <span class="n">instances</span></div>


<div class="viewcode-block" id="instantiateSTAT"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateSTAT">[docs]</a><span class="k">def</span> <span class="nf">instantiateSTAT</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="c1"># &#39;axisLimits&#39; dict must contain user-space (non-normalized) coordinates</span>

    <span class="n">stat</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;STAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stat</span><span class="o">.</span><span class="n">DesignAxisRecord</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">stat</span><span class="o">.</span><span class="n">AxisValueArray</span> <span class="ow">and</span> <span class="n">stat</span><span class="o">.</span><span class="n">AxisValueArray</span><span class="o">.</span><span class="n">AxisValue</span>
    <span class="p">):</span>
        <span class="k">return</span>  <span class="c1"># STAT table empty, nothing to do</span>

    <span class="n">location</span><span class="p">,</span> <span class="n">axisRanges</span> <span class="o">=</span> <span class="n">splitAxisLocationAndRanges</span><span class="p">(</span><span class="n">axisLimits</span><span class="p">,</span> <span class="n">rangeType</span><span class="o">=</span><span class="n">AxisRange</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isAxisValueOutsideLimits</span><span class="p">(</span><span class="n">axisTag</span><span class="p">,</span> <span class="n">axisValue</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">location</span> <span class="ow">and</span> <span class="n">axisValue</span> <span class="o">!=</span> <span class="n">location</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">axisTag</span> <span class="ow">in</span> <span class="n">axisRanges</span><span class="p">:</span>
            <span class="n">axisRange</span> <span class="o">=</span> <span class="n">axisRanges</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">axisValue</span> <span class="o">&lt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">minimum</span> <span class="ow">or</span> <span class="n">axisValue</span> <span class="o">&gt;</span> <span class="n">axisRange</span><span class="o">.</span><span class="n">maximum</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Instantiating STAT table&quot;</span><span class="p">)</span>

    <span class="c1"># only keep AxisValues whose axis is not pinned nor restricted, or is pinned at the</span>
    <span class="c1"># exact (nominal) value, or is restricted but the value is within the new range</span>
    <span class="n">designAxes</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">DesignAxisRecord</span><span class="o">.</span><span class="n">Axis</span>
    <span class="n">newAxisValueTables</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">axisValueTable</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">AxisValueArray</span><span class="o">.</span><span class="n">AxisValue</span><span class="p">:</span>
        <span class="n">axisValueFormat</span> <span class="o">=</span> <span class="n">axisValueTable</span><span class="o">.</span><span class="n">Format</span>
        <span class="k">if</span> <span class="n">axisValueFormat</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">axisTag</span> <span class="o">=</span> <span class="n">designAxes</span><span class="p">[</span><span class="n">axisValueTable</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">]</span><span class="o">.</span><span class="n">AxisTag</span>
            <span class="k">if</span> <span class="n">axisValueFormat</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">axisValue</span> <span class="o">=</span> <span class="n">axisValueTable</span><span class="o">.</span><span class="n">NominalValue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axisValue</span> <span class="o">=</span> <span class="n">axisValueTable</span><span class="o">.</span><span class="n">Value</span>
            <span class="k">if</span> <span class="n">isAxisValueOutsideLimits</span><span class="p">(</span><span class="n">axisTag</span><span class="p">,</span> <span class="n">axisValue</span><span class="p">):</span>
                <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">axisValueFormat</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># drop &#39;non-analytic&#39; AxisValue if _any_ AxisValueRecord doesn&#39;t match</span>
            <span class="c1"># the pinned location or is outside range</span>
            <span class="n">dropAxisValueTable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">axisValueTable</span><span class="o">.</span><span class="n">AxisValueRecord</span><span class="p">:</span>
                <span class="n">axisTag</span> <span class="o">=</span> <span class="n">designAxes</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">AxisIndex</span><span class="p">]</span><span class="o">.</span><span class="n">AxisTag</span>
                <span class="n">axisValue</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">Value</span>
                <span class="k">if</span> <span class="n">isAxisValueOutsideLimits</span><span class="p">(</span><span class="n">axisTag</span><span class="p">,</span> <span class="n">axisValue</span><span class="p">):</span>
                    <span class="n">dropAxisValueTable</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">dropAxisValueTable</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Unknown AxisValue table format (</span><span class="si">%s</span><span class="s2">); ignored&quot;</span><span class="p">,</span> <span class="n">axisValueFormat</span><span class="p">)</span>
        <span class="n">newAxisValueTables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axisValueTable</span><span class="p">)</span>

    <span class="n">stat</span><span class="o">.</span><span class="n">AxisValueArray</span><span class="o">.</span><span class="n">AxisValue</span> <span class="o">=</span> <span class="n">newAxisValueTables</span>
    <span class="n">stat</span><span class="o">.</span><span class="n">AxisValueCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">AxisValueArray</span><span class="o">.</span><span class="n">AxisValue</span><span class="p">)</span></div>


<div class="viewcode-block" id="getVariationNameIDs"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.getVariationNameIDs">[docs]</a><span class="k">def</span> <span class="nf">getVariationNameIDs</span><span class="p">(</span><span class="n">varfont</span><span class="p">):</span>
    <span class="n">used</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;fvar&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">fvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>
            <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">axisNameID</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
            <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">subfamilyNameID</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">postscriptNameID</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">:</span>
                <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">postscriptNameID</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;STAT&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;STAT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">DesignAxisRecord</span><span class="o">.</span><span class="n">Axis</span> <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">DesignAxisRecord</span> <span class="k">else</span> <span class="p">():</span>
            <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">AxisNameID</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">stat</span><span class="o">.</span><span class="n">AxisValueArray</span><span class="o">.</span><span class="n">AxisValue</span> <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">AxisValueArray</span> <span class="k">else</span> <span class="p">():</span>
            <span class="n">used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">ValueNameID</span><span class="p">)</span>
    <span class="c1"># nameIDs &lt;= 255 are reserved by OT spec so we don&#39;t touch them</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">nameID</span> <span class="k">for</span> <span class="n">nameID</span> <span class="ow">in</span> <span class="n">used</span> <span class="k">if</span> <span class="n">nameID</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">}</span></div>


<div class="viewcode-block" id="pruningUnusedNames"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.pruningUnusedNames">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">pruningUnusedNames</span><span class="p">(</span><span class="n">varfont</span><span class="p">):</span>
    <span class="n">origNameIDs</span> <span class="o">=</span> <span class="n">getVariationNameIDs</span><span class="p">(</span><span class="n">varfont</span><span class="p">)</span>

    <span class="k">yield</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pruning name table&quot;</span><span class="p">)</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="n">origNameIDs</span> <span class="o">-</span> <span class="n">getVariationNameIDs</span><span class="p">(</span><span class="n">varfont</span><span class="p">)</span>
    <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">names</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">record</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">nameID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;ltag&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="c1"># Drop the whole &#39;ltag&#39; table if all the language-dependent Unicode name</span>
        <span class="c1"># records that reference it have been dropped.</span>
        <span class="c1"># TODO: Only prune unused ltag tags, renumerating langIDs accordingly.</span>
        <span class="c1"># Note ltag can also be used by feat or morx tables, so check those too.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">record</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">names</span>
            <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">platformID</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">record</span><span class="o">.</span><span class="n">langID</span> <span class="o">!=</span> <span class="mh">0xFFFF</span>
        <span class="p">):</span>
            <span class="k">del</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;ltag&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="setMacOverlapFlags"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.setMacOverlapFlags">[docs]</a><span class="k">def</span> <span class="nf">setMacOverlapFlags</span><span class="p">(</span><span class="n">glyfTable</span><span class="p">):</span>
    <span class="n">flagOverlapCompound</span> <span class="o">=</span> <span class="n">_g_l_y_f</span><span class="o">.</span><span class="n">OVERLAP_COMPOUND</span>
    <span class="n">flagOverlapSimple</span> <span class="o">=</span> <span class="n">_g_l_y_f</span><span class="o">.</span><span class="n">flagOverlapSimple</span>
    <span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyfTable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">glyph</span> <span class="o">=</span> <span class="n">glyfTable</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
        <span class="c1"># Set OVERLAP_COMPOUND bit for compound glyphs</span>
        <span class="k">if</span> <span class="n">glyph</span><span class="o">.</span><span class="n">isComposite</span><span class="p">():</span>
            <span class="n">glyph</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flagOverlapCompound</span>
        <span class="c1"># Set OVERLAP_SIMPLE bit for simple glyphs</span>
        <span class="k">elif</span> <span class="n">glyph</span><span class="o">.</span><span class="n">numberOfContours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">glyph</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">flagOverlapSimple</span></div>


<div class="viewcode-block" id="normalize"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.normalize">[docs]</a><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">triple</span><span class="p">,</span> <span class="n">avarMapping</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">normalizeValue</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">triple</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">avarMapping</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">piecewiseLinearMap</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">avarMapping</span><span class="p">)</span>
    <span class="c1"># Quantize to F2Dot14, to avoid surprise interpolations.</span>
    <span class="k">return</span> <span class="n">floatToFixedToFloat</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span></div>


<div class="viewcode-block" id="normalizeAxisLimits"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.normalizeAxisLimits">[docs]</a><span class="k">def</span> <span class="nf">normalizeAxisLimits</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">usingAvar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">fvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span>
    <span class="n">badLimits</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">axisLimits</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">axisTag</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">badLimits</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot limit: </span><span class="si">{}</span><span class="s2"> not present in fvar&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">badLimits</span><span class="p">))</span>

    <span class="n">axes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">a</span><span class="o">.</span><span class="n">axisTag</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">minValue</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">defaultValue</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">maxValue</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">axes</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">axisTag</span> <span class="ow">in</span> <span class="n">axisLimits</span>
    <span class="p">}</span>

    <span class="n">avarSegments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">usingAvar</span> <span class="ow">and</span> <span class="s2">&quot;avar&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">avarSegments</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;avar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">segments</span>

    <span class="k">for</span> <span class="n">axis_tag</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">axisLimits</span><span class="p">[</span><span class="n">axis_tag</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">minV</span><span class="p">,</span> <span class="n">maxV</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">if</span> <span class="n">minV</span> <span class="o">&gt;</span> <span class="n">default</span> <span class="ow">or</span> <span class="n">maxV</span> <span class="o">&lt;</span> <span class="n">default</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;Unsupported range </span><span class="si">{axis_tag}</span><span class="s2">=</span><span class="si">{minV:g}</span><span class="s2">:</span><span class="si">{maxV:g}</span><span class="s2">; &quot;</span>
                    <span class="n">f</span><span class="s2">&quot;can&#39;t change default position (</span><span class="si">{axis_tag}</span><span class="s2">=</span><span class="si">{default:g}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>

    <span class="n">normalizedLimits</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">axis_tag</span><span class="p">,</span> <span class="n">triple</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">avarMapping</span> <span class="o">=</span> <span class="n">avarSegments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">axis_tag</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">axisLimits</span><span class="p">[</span><span class="n">axis_tag</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">normalizedLimits</span><span class="p">[</span><span class="n">axis_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">NormalizedAxisRange</span><span class="p">(</span>
                <span class="o">*</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">triple</span><span class="p">,</span> <span class="n">avarMapping</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">normalizedLimits</span><span class="p">[</span><span class="n">axis_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">triple</span><span class="p">,</span> <span class="n">avarMapping</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">normalizedLimits</span></div>


<div class="viewcode-block" id="sanityCheckVariableTables"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.sanityCheckVariableTables">[docs]</a><span class="k">def</span> <span class="nf">sanityCheckVariableTables</span><span class="p">(</span><span class="n">varfont</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;fvar&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing required table fvar&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;gvar&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;glyf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t have gvar without glyf&quot;</span><span class="p">)</span>
    <span class="c1"># TODO(anthrotype) Remove once we do support partial instancing CFF2</span>
    <span class="k">if</span> <span class="s2">&quot;CFF2&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Instancing CFF2 variable fonts is not supported yet&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="populateAxisDefaults"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.populateAxisDefaults">[docs]</a><span class="k">def</span> <span class="nf">populateAxisDefaults</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">axisLimits</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">fvar</span> <span class="o">=</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span>
        <span class="n">defaultValues</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">axisTag</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">defaultValue</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fvar</span><span class="o">.</span><span class="n">axes</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">axisTag</span><span class="p">:</span> <span class="n">defaultValues</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">axisLimits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">axisLimits</span></div>


<div class="viewcode-block" id="instantiateVariableFont"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.instantiateVariableFont">[docs]</a><span class="k">def</span> <span class="nf">instantiateVariableFont</span><span class="p">(</span>
    <span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Instantiate variable font, either fully or partially.</span>

<span class="sd">    Depending on whether the `axisLimits` dictionary references all or some of the</span>
<span class="sd">    input varfont&#39;s axes, the output font will either be a full instance (static</span>
<span class="sd">    font) or a variable font with possibly less variation data.</span>

<span class="sd">    Args:</span>
<span class="sd">        varfont: a TTFont instance, which must contain at least an &#39;fvar&#39; table.</span>
<span class="sd">            Note that variable fonts with &#39;CFF2&#39; table are not supported yet.</span>
<span class="sd">        axisLimits: a dict keyed by axis tags (str) containing the coordinates (float)</span>
<span class="sd">            along one or more axes where the desired instance will be located.</span>
<span class="sd">            If the value is `None`, the default coordinate as per &#39;fvar&#39; table for</span>
<span class="sd">            that axis is used.</span>
<span class="sd">            The limit values can also be (min, max) tuples for restricting an</span>
<span class="sd">            axis&#39;s variation range, but this is not implemented yet.</span>
<span class="sd">        inplace (bool): whether to modify input TTFont object in-place instead of</span>
<span class="sd">            returning a distinct object.</span>
<span class="sd">        optimize (bool): if False, do not perform IUP-delta optimization on the</span>
<span class="sd">            remaining &#39;gvar&#39; table&#39;s deltas. Possibly faster, and might work around</span>
<span class="sd">            rendering issues in some buggy environments, at the cost of a slightly</span>
<span class="sd">            larger file size.</span>
<span class="sd">        overlap (bool): variable fonts usually contain overlapping contours, and some</span>
<span class="sd">            font rendering engines on Apple platforms require that the `OVERLAP_SIMPLE`</span>
<span class="sd">            and `OVERLAP_COMPOUND` flags in the &#39;glyf&#39; table be set to force rendering</span>
<span class="sd">            using a non-zero fill rule. Thus we always set these flags on all glyphs</span>
<span class="sd">            to maximise cross-compatibility of the generated instance. You can disable</span>
<span class="sd">            this by setting `overalap` to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sanityCheckVariableTables</span><span class="p">(</span><span class="n">varfont</span><span class="p">)</span>

    <span class="n">axisLimits</span> <span class="o">=</span> <span class="n">populateAxisDefaults</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="n">normalizedLimits</span> <span class="o">=</span> <span class="n">normalizeAxisLimits</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalized limits: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">varfont</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">varfont</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;gvar&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">instantiateGvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="n">optimize</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;cvar&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">instantiateCvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;MVAR&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">instantiateMVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;HVAR&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">instantiateHVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;VVAR&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">instantiateVVAR</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">)</span>

    <span class="n">instantiateOTL</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">)</span>

    <span class="n">instantiateFeatureVariations</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">normalizedLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;avar&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="n">instantiateAvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">pruningUnusedNames</span><span class="p">(</span><span class="n">varfont</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;STAT&quot;</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
            <span class="n">instantiateSTAT</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

        <span class="n">instantiateFvar</span><span class="p">(</span><span class="n">varfont</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;fvar&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;glyf&quot;</span> <span class="ow">in</span> <span class="n">varfont</span> <span class="ow">and</span> <span class="n">overlap</span><span class="p">:</span>
            <span class="n">setMacOverlapFlags</span><span class="p">(</span><span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;glyf&quot;</span><span class="p">])</span>

    <span class="n">varLib</span><span class="o">.</span><span class="n">set_default_weight_width_slant</span><span class="p">(</span>
        <span class="n">varfont</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="p">{</span>
            <span class="n">axisTag</span><span class="p">:</span> <span class="n">limit</span>
            <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">axisLimits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">varfont</span></div>


<div class="viewcode-block" id="splitAxisLocationAndRanges"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.splitAxisLocationAndRanges">[docs]</a><span class="k">def</span> <span class="nf">splitAxisLocationAndRanges</span><span class="p">(</span><span class="n">axisLimits</span><span class="p">,</span> <span class="n">rangeType</span><span class="o">=</span><span class="n">AxisRange</span><span class="p">):</span>
    <span class="n">location</span><span class="p">,</span> <span class="n">axisRanges</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">axisLimits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">rangeType</span><span class="p">):</span>
            <span class="n">axisRanges</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">location</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">axisRanges</span><span class="p">[</span><span class="n">axisTag</span><span class="p">]</span> <span class="o">=</span> <span class="n">rangeType</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="n">f</span><span class="s2">&quot;Expected number or </span><span class="si">{rangeType.__name__}</span><span class="s2">, &quot;</span>
                <span class="n">f</span><span class="s2">&quot;got {type(value).__name__}: </span><span class="si">{value!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">location</span><span class="p">,</span> <span class="n">axisRanges</span></div>


<div class="viewcode-block" id="parseLimits"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.parseLimits">[docs]</a><span class="k">def</span> <span class="nf">parseLimits</span><span class="p">(</span><span class="n">limits</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">limitString</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\w{1,4})=(?:(drop)|(?:([^:]+)(?:[:](.+))?))$&quot;</span><span class="p">,</span> <span class="n">limitString</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid location format: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">limitString</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># &#39;drop&#39;</span>
            <span class="n">lbound</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lbound</span> <span class="o">=</span> <span class="n">strToFixedToFloat</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">precisionBits</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ubound</span> <span class="o">=</span> <span class="n">lbound</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">ubound</span> <span class="o">=</span> <span class="n">strToFixedToFloat</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">precisionBits</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lbound</span> <span class="o">!=</span> <span class="n">ubound</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">AxisRange</span><span class="p">(</span><span class="n">lbound</span><span class="p">,</span> <span class="n">ubound</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">lbound</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="parseArgs"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.parseArgs">[docs]</a><span class="k">def</span> <span class="nf">parseArgs</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse argv.</span>

<span class="sd">    Returns:</span>
<span class="sd">        3-tuple (infile, axisLimits, options)</span>
<span class="sd">        axisLimits is either a Dict[str, Optional[float]], for pinning variation axes</span>
<span class="sd">        to specific coordinates along those axes (with `None` as a placeholder for an</span>
<span class="sd">        axis&#39; default value); or a Dict[str, Tuple(float, float)], meaning limit this</span>
<span class="sd">        axis to min/max range.</span>
<span class="sd">        Axes locations are in user-space coordinates, as defined in the &quot;fvar&quot; table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">fontTools</span> <span class="k">import</span> <span class="n">configLogger</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="s2">&quot;fonttools varLib.instancer&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Partially instantiate a variable font&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;INPUT.ttf&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Input variable TTF file.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;locargs&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;AXIS=LOC&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of space separated locations. A location consist in &quot;</span>
        <span class="s2">&quot;the tag of a variation axis, followed by &#39;=&#39; and one of number, &quot;</span>
        <span class="s2">&quot;number:number or the literal string &#39;drop&#39;. &quot;</span>
        <span class="s2">&quot;E.g.: wdth=100 or wght=75.0:125.0 or wght=drop&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;OUTPUT.ttf&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output instance TTF file (default: INPUT-instance.ttf).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-optimize&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;optimize&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Don&#39;t perform IUP optimization on the remaining gvar TupleVariations&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-overlap-flag&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;overlap&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_false&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Don&#39;t set OVERLAP_SIMPLE/OVERLAP_COMPOUND glyf flags (only applicable &quot;</span>
        <span class="s2">&quot;when generating a full instance)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">loggingGroup</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">loggingGroup</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run more verbosely.&quot;</span>
    <span class="p">)</span>
    <span class="n">loggingGroup</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;--quiet&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Turn verbosity off.&quot;</span>
    <span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">infile</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">input</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No such file &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>

    <span class="n">configLogger</span><span class="p">(</span>
        <span class="n">level</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="s2">&quot;ERROR&quot;</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">quiet</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">axisLimits</span> <span class="o">=</span> <span class="n">parseLimits</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">locargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axisLimits</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">locargs</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Specified multiple limits for the same axis&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../varLib/instancer.html#fontTools.varLib.instancer.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">infile</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">parseArgs</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Restricting axes: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">axisLimits</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading variable font&quot;</span><span class="p">)</span>
    <span class="n">varfont</span> <span class="o">=</span> <span class="n">TTFont</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

    <span class="n">isFullInstance</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">axisTag</span> <span class="k">for</span> <span class="n">axisTag</span><span class="p">,</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">axisLimits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="p">}</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">axisTag</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">varfont</span><span class="p">[</span><span class="s2">&quot;fvar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>

    <span class="n">instantiateVariableFont</span><span class="p">(</span>
        <span class="n">varfont</span><span class="p">,</span>
        <span class="n">axisLimits</span><span class="p">,</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">optimize</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">optimize</span><span class="p">,</span>
        <span class="n">overlap</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">overlap</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">outfile</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">infile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="o">+</span> <span class="s2">&quot;-</span><span class="si">{}</span><span class="s2">.ttf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;instance&quot;</span> <span class="k">if</span> <span class="n">isFullInstance</span> <span class="k">else</span> <span class="s2">&quot;partial&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span>
        <span class="k">else</span> <span class="n">options</span><span class="o">.</span><span class="n">output</span>
    <span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Saving </span><span class="si">%s</span><span class="s2"> font </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;instance&quot;</span> <span class="k">if</span> <span class="n">isFullInstance</span> <span class="k">else</span> <span class="s2">&quot;partial variable&quot;</span><span class="p">,</span>
        <span class="n">outfile</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">varfont</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Just van Rossum, Behdad Esfahbod, and the fontTools Authors. CC BY-SA 4.0

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>