

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>fontTools.ufoLib.glifLib &mdash; fontTools Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> fontTools
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../afmLib.html">afmLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../agl.html">agl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cffLib/index.html">cffLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../colorLib/index.html">colorLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cu2qu/index.html">cu2qu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../designspaceLib/index.html">designspaceLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../encodings/index.html">encodings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../feaLib/index.html">feaLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../merge.html">merge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/index.html">misc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mtiLib.html">mtiLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../otlLib/index.html">otlLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pens/index.html">pens</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../subset/index.html">subset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../svgLib/index.html">svgLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../t1Lib.html">t1Lib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ttLib/index.html">ttLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ttx.html">ttx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ufoLib/index.html">ufoLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../unicode.html">unicode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../unicodedata/index.html">unicodedata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../varLib/index.html">varLib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../voltLib.html">voltLib</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">fontTools</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../ufoLib.html">fontTools.ufoLib</a> &raquo;</li>
        
      <li>fontTools.ufoLib.glifLib</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for fontTools.ufoLib.glifLib</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">glifLib.py -- Generic module for reading and writing the .glif format.</span>

<span class="sd">More info about the .glif format (GLyphInterchangeFormat) can be found here:</span>

<span class="sd">	http://unifiedfontobject.org</span>

<span class="sd">The main class in this module is GlyphSet. It manages a set of .glif files</span>
<span class="sd">in a folder. It offers two ways to read glyph data, and one way to write</span>
<span class="sd">glyph data. See the class doc string for details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">fs</span>
<span class="kn">import</span> <span class="nn">fs.base</span>
<span class="kn">import</span> <span class="nn">fs.errors</span>
<span class="kn">import</span> <span class="nn">fs.osfs</span>
<span class="kn">import</span> <span class="nn">fs.path</span>
<span class="kn">from</span> <span class="nn">fontTools.misc.py23</span> <span class="k">import</span> <span class="n">tobytes</span>
<span class="kn">from</span> <span class="nn">fontTools.misc</span> <span class="k">import</span> <span class="n">plistlib</span>
<span class="kn">from</span> <span class="nn">fontTools.pens.pointPen</span> <span class="k">import</span> <span class="n">AbstractPointPen</span><span class="p">,</span> <span class="n">PointToSegmentPen</span>
<span class="kn">from</span> <span class="nn">fontTools.ufoLib.errors</span> <span class="k">import</span> <span class="n">GlifLibError</span>
<span class="kn">from</span> <span class="nn">fontTools.ufoLib.filenames</span> <span class="k">import</span> <span class="n">userNameToFileName</span>
<span class="kn">from</span> <span class="nn">fontTools.ufoLib.validators</span> <span class="k">import</span> <span class="p">(</span>
	<span class="n">genericTypeValidator</span><span class="p">,</span>
	<span class="n">colorValidator</span><span class="p">,</span>
	<span class="n">guidelinesValidator</span><span class="p">,</span>
	<span class="n">anchorsValidator</span><span class="p">,</span>
	<span class="n">identifierValidator</span><span class="p">,</span>
	<span class="n">imageValidator</span><span class="p">,</span>
	<span class="n">glyphLibValidator</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">fontTools.misc</span> <span class="k">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">fontTools.ufoLib</span> <span class="k">import</span> <span class="n">_UFOBaseIO</span>
<span class="kn">from</span> <span class="nn">fontTools.ufoLib.utils</span> <span class="k">import</span> <span class="n">numberTypes</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
	<span class="s2">&quot;GlyphSet&quot;</span><span class="p">,</span>
	<span class="s2">&quot;GlifLibError&quot;</span><span class="p">,</span>
	<span class="s2">&quot;readGlyphFromString&quot;</span><span class="p">,</span> <span class="s2">&quot;writeGlyphToString&quot;</span><span class="p">,</span>
	<span class="s2">&quot;glyphNameToFileName&quot;</span>
<span class="p">]</span>


<span class="c1"># ---------</span>
<span class="c1"># Constants</span>
<span class="c1"># ---------</span>

<span class="n">CONTENTS_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;contents.plist&quot;</span>
<span class="n">LAYERINFO_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;layerinfo.plist&quot;</span>
<span class="n">supportedUFOFormatVersions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">supportedGLIFFormatVersions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>


<span class="c1"># ------------</span>
<span class="c1"># Simple Glyph</span>
<span class="c1"># ------------</span>

<span class="k">class</span> <span class="nc">Glyph</span><span class="p">:</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Minimal glyph object. It has no glyph attributes until either</span>
<span class="sd">	the draw() or the drawPoints() method has been called.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphSet</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphName</span> <span class="o">=</span> <span class="n">glyphName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphSet</span> <span class="o">=</span> <span class="n">glyphSet</span>

	<span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pen</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Draw this glyph onto a *FontTools* Pen.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">pointPen</span> <span class="o">=</span> <span class="n">PointToSegmentPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">drawPoints</span><span class="p">(</span><span class="n">pointPen</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">drawPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Draw this glyph onto a PointPen.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphSet</span><span class="o">.</span><span class="n">readGlyph</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glyphName</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">)</span>


<span class="c1"># ---------</span>
<span class="c1"># Glyph Set</span>
<span class="c1"># ---------</span>

<div class="viewcode-block" id="GlyphSet"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet">[docs]</a><span class="k">class</span> <span class="nc">GlyphSet</span><span class="p">(</span><span class="n">_UFOBaseIO</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	GlyphSet manages a set of .glif files inside one directory.</span>

<span class="sd">	GlyphSet&#39;s constructor takes a path to an existing directory as it&#39;s</span>
<span class="sd">	first argument. Reading glyph data can either be done through the</span>
<span class="sd">	readGlyph() method, or by using GlyphSet&#39;s dictionary interface, where</span>
<span class="sd">	the keys are glyph names and the values are (very) simple glyph objects.</span>

<span class="sd">	To write a glyph to the glyph set, you use the writeGlyph() method.</span>
<span class="sd">	The simple glyph objects returned through the dict interface do not</span>
<span class="sd">	support writing, they are just a convenient way to get at the glyph data.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">glyphClass</span> <span class="o">=</span> <span class="n">Glyph</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
		<span class="bp">self</span><span class="p">,</span>
		<span class="n">path</span><span class="p">,</span>
		<span class="n">glyphNameToFileNameFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">ufoFormatVersion</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
		<span class="n">validateRead</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
		<span class="n">validateWrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
	<span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		&#39;path&#39; should be a path (string) to an existing local directory, or</span>
<span class="sd">		an instance of fs.base.FS class.</span>

<span class="sd">		The optional &#39;glyphNameToFileNameFunc&#39; argument must be a callback</span>
<span class="sd">		function that takes two arguments: a glyph name and a list of all</span>
<span class="sd">		existing filenames (if any exist). It should return a file name</span>
<span class="sd">		(including the .glif extension). The glyphNameToFileName function</span>
<span class="sd">		is called whenever a file name is created for a given glyph name.</span>

<span class="sd">		``validateRead`` will validate read operations. Its default is ``True``.</span>
<span class="sd">		``validateWrite`` will validate write operations. Its default is ``True``.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">ufoFormatVersion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supportedUFOFormatVersions</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unsupported UFO format version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ufoFormatVersion</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">filesystem</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">osfs</span><span class="o">.</span><span class="n">OSFS</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
			<span class="k">except</span> <span class="n">fs</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">CreateFailed</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;No glyphs directory &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_shouldClose</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">FS</span><span class="p">):</span>
			<span class="n">filesystem</span> <span class="o">=</span> <span class="n">path</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">filesystem</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>
			<span class="k">except</span> <span class="n">fs</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">FilesystemClosed</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;the filesystem &#39;</span><span class="si">%s</span><span class="s2">&#39; is closed&quot;</span> <span class="o">%</span> <span class="n">filesystem</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_shouldClose</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
				<span class="s2">&quot;Expected a path string or fs object, found </span><span class="si">%s</span><span class="s2">&quot;</span>
				<span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
			<span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">filesystem</span><span class="o">.</span><span class="n">getsyspath</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">fs</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">NoSysPath</span><span class="p">:</span>
			<span class="c1"># network or in-memory FS may not map to the local one</span>
			<span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filesystem</span><span class="p">)</span>
		<span class="c1"># &#39;dirName&#39; is kept for backward compatibility only, but it&#39;s DEPRECATED</span>
		<span class="c1"># as it&#39;s not guaranteed that it maps to an existing OSFS directory.</span>
		<span class="c1"># Client could use the FS api via the `self.fs` attribute instead.</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dirName</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parts</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">filesystem</span>
		<span class="c1"># if glyphSet contains no &#39;contents.plist&#39;, we consider it empty</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_havePreviousFile</span> <span class="o">=</span> <span class="n">filesystem</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CONTENTS_FILENAME</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">=</span> <span class="n">ufoFormatVersion</span>
		<span class="k">if</span> <span class="n">glyphNameToFileNameFunc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">glyphNameToFileNameFunc</span> <span class="o">=</span> <span class="n">glyphNameToFileName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">glyphNameToFileName</span> <span class="o">=</span> <span class="n">glyphNameToFileNameFunc</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_validateRead</span> <span class="o">=</span> <span class="n">validateRead</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_validateWrite</span> <span class="o">=</span> <span class="n">validateWrite</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">rebuildContents</span><span class="p">()</span>

<div class="viewcode-block" id="GlyphSet.rebuildContents"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.rebuildContents">[docs]</a>	<span class="k">def</span> <span class="nf">rebuildContents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validateRead</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Rebuild the contents dict by loading contents.plist.</span>

<span class="sd">		``validateRead`` will validate the data, by default it is set to the</span>
<span class="sd">		class&#39;s ``validateRead`` value, can be overridden.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">validateRead</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">validateRead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateRead</span>
		<span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPlist</span><span class="p">(</span><span class="n">CONTENTS_FILENAME</span><span class="p">,</span> <span class="p">{})</span>
		<span class="c1"># validate the contents</span>
		<span class="k">if</span> <span class="n">validateRead</span><span class="p">:</span>
			<span class="n">invalidFormat</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="n">invalidFormat</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
						<span class="n">invalidFormat</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
						<span class="n">invalidFormat</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
						<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span>
							<span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> references a file that does not exist: </span><span class="si">%s</span><span class="s2">&quot;</span>
							<span class="o">%</span> <span class="p">(</span><span class="n">CONTENTS_FILENAME</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
						<span class="p">)</span>
			<span class="k">if</span> <span class="n">invalidFormat</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not properly formatted&quot;</span> <span class="o">%</span> <span class="n">CONTENTS_FILENAME</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GlyphSet.getReverseContents"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.getReverseContents">[docs]</a>	<span class="k">def</span> <span class="nf">getReverseContents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a reversed dict of self.contents, mapping file names to</span>
<span class="sd">		glyph names. This is primarily an aid for custom glyph name to file</span>
<span class="sd">		name schemes that want to make sure they don&#39;t generate duplicate</span>
<span class="sd">		file names. The file names are converted to lowercase so we can</span>
<span class="sd">		reliably check for duplicates that only differ in case, which is</span>
<span class="sd">		important for case-insensitive file systems.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">d</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">k</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="o">=</span> <span class="n">d</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span></div>

<div class="viewcode-block" id="GlyphSet.writeContents"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.writeContents">[docs]</a>	<span class="k">def</span> <span class="nf">writeContents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Write the contents.plist file out to disk. Call this method when</span>
<span class="sd">		you&#39;re done writing glyphs.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_writePlist</span><span class="p">(</span><span class="n">CONTENTS_FILENAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span></div>

	<span class="c1"># layer info</span>

<div class="viewcode-block" id="GlyphSet.readLayerInfo"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.readLayerInfo">[docs]</a>	<span class="k">def</span> <span class="nf">readLayerInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">validateRead</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		``validateRead`` will validate the data, by default it is set to the</span>
<span class="sd">		class&#39;s ``validateRead`` value, can be overridden.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">validateRead</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">validateRead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateRead</span>
		<span class="n">infoDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getPlist</span><span class="p">(</span><span class="n">LAYERINFO_FILENAME</span><span class="p">,</span> <span class="p">{})</span>
		<span class="k">if</span> <span class="n">validateRead</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">infoDict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;layerinfo.plist is not properly formatted.&quot;</span><span class="p">)</span>
			<span class="n">infoDict</span> <span class="o">=</span> <span class="n">validateLayerInfoVersion3Data</span><span class="p">(</span><span class="n">infoDict</span><span class="p">)</span>
		<span class="c1"># populate the object</span>
		<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">infoDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="nb">setattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The supplied layer info object does not support setting a necessary attribute (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span></div>

<div class="viewcode-block" id="GlyphSet.writeLayerInfo"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.writeLayerInfo">[docs]</a>	<span class="k">def</span> <span class="nf">writeLayerInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">validateWrite</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		``validateWrite`` will validate the data, by default it is set to the</span>
<span class="sd">		class&#39;s ``validateWrite`` value, can be overridden.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">validateWrite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">validateWrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateWrite</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;layerinfo.plist is not allowed in UFO </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span><span class="p">)</span>
		<span class="c1"># gather data</span>
		<span class="n">infoData</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">layerInfoVersion3ValueData</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The supplied info object does not support getting a necessary attribute (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;lib&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">):</span>
					<span class="k">continue</span>
				<span class="n">infoData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
		<span class="k">if</span> <span class="n">infoData</span><span class="p">:</span>
			<span class="c1"># validate</span>
			<span class="k">if</span> <span class="n">validateWrite</span><span class="p">:</span>
				<span class="n">infoData</span> <span class="o">=</span> <span class="n">validateLayerInfoVersion3Data</span><span class="p">(</span><span class="n">infoData</span><span class="p">)</span>
			<span class="c1"># write file</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_writePlist</span><span class="p">(</span><span class="n">LAYERINFO_FILENAME</span><span class="p">,</span> <span class="n">infoData</span><span class="p">)</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_havePreviousFile</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">LAYERINFO_FILENAME</span><span class="p">):</span>
			<span class="c1"># data empty, remove existing file</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">LAYERINFO_FILENAME</span><span class="p">)</span></div>

<div class="viewcode-block" id="GlyphSet.getGLIF"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.getGLIF">[docs]</a>	<span class="k">def</span> <span class="nf">getGLIF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get the raw GLIF text for a given glyph name. This only works</span>
<span class="sd">		for GLIF files that are already on disk.</span>

<span class="sd">		This method is useful in situations when the raw XML needs to be</span>
<span class="sd">		read from a glyph set for a particular glyph before fully parsing</span>
<span class="sd">		it into an object structure via the readGlyph method.</span>

<span class="sd">		Raises KeyError if &#39;glyphName&#39; is not in contents.plist, or</span>
<span class="sd">		GlifLibError if the file associated with can&#39;t be found.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">readbytes</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
		<span class="k">except</span> <span class="n">fs</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span>
				<span class="s2">&quot;The file &#39;</span><span class="si">%s</span><span class="s2">&#39; associated with glyph &#39;</span><span class="si">%s</span><span class="s2">&#39; in contents.plist &quot;</span>
				<span class="s2">&quot;does not exist on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
			<span class="p">)</span></div>

<div class="viewcode-block" id="GlyphSet.getGLIFModificationTime"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.getGLIFModificationTime">[docs]</a>	<span class="k">def</span> <span class="nf">getGLIFModificationTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Returns the modification time for the GLIF file with &#39;glyphName&#39;, as</span>
<span class="sd">		a floating point number giving the number of seconds since the epoch.</span>
<span class="sd">		Return None if the associated file does not exist or the underlying</span>
<span class="sd">		filesystem does not support getting modified times.</span>
<span class="sd">		Raises KeyError if the glyphName is not in contents.plist.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFileModificationTime</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span></div>

	<span class="c1"># reading/writing API</span>

<div class="viewcode-block" id="GlyphSet.readGlyph"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.readGlyph">[docs]</a>	<span class="k">def</span> <span class="nf">readGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Read a .glif file for &#39;glyphName&#39; from the glyph set. The</span>
<span class="sd">		&#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">		the readGlyph() method will attempt to set the following</span>
<span class="sd">		attributes on it:</span>
<span class="sd">			&quot;width&quot;      the advance width of the glyph</span>
<span class="sd">			&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">			&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">			&quot;note&quot;       a string</span>
<span class="sd">			&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">			&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">			&quot;guidelines&quot; a list of guideline data dictionaries</span>
<span class="sd">			&quot;anchors&quot;    a list of anchor data dictionaries</span>

<span class="sd">		All attributes are optional, in two ways:</span>
<span class="sd">			1) An attribute *won&#39;t* be set if the .glif file doesn&#39;t</span>
<span class="sd">			   contain data for it. &#39;glyphObject&#39; will have to deal</span>
<span class="sd">			   with default values itself.</span>
<span class="sd">			2) If setting the attribute fails with an AttributeError</span>
<span class="sd">			   (for example if the &#39;glyphObject&#39; attribute is read-</span>
<span class="sd">			   only), readGlyph() will not propagate that exception,</span>
<span class="sd">			   but ignore that attribute.</span>

<span class="sd">		To retrieve outline information, you need to pass an object</span>
<span class="sd">		conforming to the PointPen protocol as the &#39;pointPen&#39; argument.</span>
<span class="sd">		This argument may be None if you don&#39;t need the outline data.</span>

<span class="sd">		readGlyph() will raise KeyError if the glyph is not present in</span>
<span class="sd">		the glyph set.</span>

<span class="sd">		``validate`` will validate the data, by default it is set to the</span>
<span class="sd">		class&#39;s ``validateRead`` value, can be overridden.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateRead</span>
		<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="n">tree</span> <span class="o">=</span> <span class="n">_glifTreeFromString</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
			<span class="n">formatVersions</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">formatVersions</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">_readGlyphFromTree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">,</span> <span class="n">formatVersions</span><span class="o">=</span><span class="n">formatVersions</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span></div>

<div class="viewcode-block" id="GlyphSet.writeGlyph"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.writeGlyph">[docs]</a>	<span class="k">def</span> <span class="nf">writeGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drawPointsFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formatVersion</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Write a .glif file for &#39;glyphName&#39; to the glyph set. The</span>
<span class="sd">		&#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">		the writeGlyph() method will attempt to get the following</span>
<span class="sd">		attributes from it:</span>
<span class="sd">			&quot;width&quot;      the advance with of the glyph</span>
<span class="sd">			&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">			&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">			&quot;note&quot;       a string</span>
<span class="sd">			&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">			&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">			&quot;guidelines&quot; a list of guideline data dictionaries</span>
<span class="sd">			&quot;anchors&quot;    a list of anchor data dictionaries</span>

<span class="sd">		All attributes are optional: if &#39;glyphObject&#39; doesn&#39;t</span>
<span class="sd">		have the attribute, it will simply be skipped.</span>

<span class="sd">		To write outline data to the .glif file, writeGlyph() needs</span>
<span class="sd">		a function (any callable object actually) that will take one</span>
<span class="sd">		argument: an object that conforms to the PointPen protocol.</span>
<span class="sd">		The function will be called by writeGlyph(); it has to call the</span>
<span class="sd">		proper PointPen methods to transfer the outline to the .glif file.</span>

<span class="sd">		The GLIF format version will be chosen based on the ufoFormatVersion</span>
<span class="sd">		passed during the creation of this object. If a particular format</span>
<span class="sd">		version is desired, it can be passed with the formatVersion argument.</span>

<span class="sd">		``validate`` will validate the data, by default it is set to the</span>
<span class="sd">		class&#39;s ``validateWrite`` value, can be overridden.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">formatVersion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
				<span class="n">formatVersion</span> <span class="o">=</span> <span class="mi">2</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">formatVersion</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="k">if</span> <span class="n">formatVersion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supportedGLIFFormatVersions</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unsupported GLIF format version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">formatVersion</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span>
				<span class="s2">&quot;Unsupported GLIF format version (</span><span class="si">%d</span><span class="s2">) for UFO format version </span><span class="si">%d</span><span class="s2">.&quot;</span>
				<span class="o">%</span> <span class="p">(</span><span class="n">formatVersion</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ufoFormatVersion</span><span class="p">)</span>
			<span class="p">)</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validateWrite</span>
		<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span><span class="p">[</span><span class="n">fileName</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
			<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphNameToFileName</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileName</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span><span class="p">[</span><span class="n">fileName</span><span class="p">]</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span><span class="p">[</span><span class="n">fileName</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">glyphName</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">_writeGlyphToBytes</span><span class="p">(</span>
			<span class="n">glyphName</span><span class="p">,</span>
			<span class="n">glyphObject</span><span class="p">,</span>
			<span class="n">drawPointsFunc</span><span class="p">,</span>
			<span class="n">formatVersion</span><span class="o">=</span><span class="n">formatVersion</span><span class="p">,</span>
			<span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
		<span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_havePreviousFile</span>
			<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
			<span class="ow">and</span> <span class="n">data</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">readbytes</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
		<span class="p">):</span>
			<span class="k">return</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">writebytes</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="GlyphSet.deleteGlyph"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.deleteGlyph">[docs]</a>	<span class="k">def</span> <span class="nf">deleteGlyph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;Permanently delete the glyph from the glyph set on disk. Will</span>
<span class="sd">		raise KeyError if the glyph is not present in the glyph set.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_existingFileNames</span><span class="p">[</span><span class="n">fileName</span><span class="p">]</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverseContents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
		<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span></div>

	<span class="c1"># dict-like support</span>

<div class="viewcode-block" id="GlyphSet.keys"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.keys">[docs]</a>	<span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="GlyphSet.has_key"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.has_key">[docs]</a>	<span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="k">return</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span></div>

	<span class="fm">__contains__</span> <span class="o">=</span> <span class="n">has_key</span>

	<span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">glyphName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">glyphClass</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

	<span class="c1"># quickly fetch unicode values</span>

<div class="viewcode-block" id="GlyphSet.getUnicodes"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.getUnicodes">[docs]</a>	<span class="k">def</span> <span class="nf">getUnicodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphNames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a dictionary that maps glyph names to lists containing</span>
<span class="sd">		the unicode value[s] for that glyph, if any. This parses the .glif</span>
<span class="sd">		files partially, so it is a lot faster than parsing all files completely.</span>
<span class="sd">		By default this checks all glyphs, but a subset can be passed with glyphNames.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">unicodes</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">glyphNames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">glyphNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyphNames</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
			<span class="n">unicodes</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fetchUnicodes</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">unicodes</span></div>

<div class="viewcode-block" id="GlyphSet.getComponentReferences"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.getComponentReferences">[docs]</a>	<span class="k">def</span> <span class="nf">getComponentReferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphNames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a dictionary that maps glyph names to lists containing the</span>
<span class="sd">		base glyph name of components in the glyph. This parses the .glif</span>
<span class="sd">		files partially, so it is a lot faster than parsing all files completely.</span>
<span class="sd">		By default this checks all glyphs, but a subset can be passed with glyphNames.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">glyphNames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">glyphNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyphNames</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
			<span class="n">components</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fetchComponentBases</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">components</span></div>

<div class="viewcode-block" id="GlyphSet.getImageReferences"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.getImageReferences">[docs]</a>	<span class="k">def</span> <span class="nf">getImageReferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphNames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return a dictionary that maps glyph names to the file name of the image</span>
<span class="sd">		referenced by the glyph. This parses the .glif files partially, so it is a</span>
<span class="sd">		lot faster than parsing all files completely.</span>
<span class="sd">		By default this checks all glyphs, but a subset can be passed with glyphNames.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">images</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">glyphNames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">glyphNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">for</span> <span class="n">glyphName</span> <span class="ow">in</span> <span class="n">glyphNames</span><span class="p">:</span>
			<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGLIF</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span>
			<span class="n">images</span><span class="p">[</span><span class="n">glyphName</span><span class="p">]</span> <span class="o">=</span> <span class="n">_fetchImageFileName</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">images</span></div>

<div class="viewcode-block" id="GlyphSet.close"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.GlyphSet.close">[docs]</a>	<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shouldClose</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

	<span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span>

	<span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># -----------------------</span>
<span class="c1"># Glyph Name to File Name</span>
<span class="c1"># -----------------------</span>

<div class="viewcode-block" id="glyphNameToFileName"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.glyphNameToFileName">[docs]</a><span class="k">def</span> <span class="nf">glyphNameToFileName</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="n">existingFileNames</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Wrapper around the userNameToFileName function in filenames.py</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">existingFileNames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">existingFileNames</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">return</span> <span class="n">userNameToFileName</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="n">existing</span><span class="o">=</span><span class="n">existingFileNames</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.glif&quot;</span><span class="p">)</span></div>

<span class="c1"># -----------------------</span>
<span class="c1"># GLIF To and From String</span>
<span class="c1"># -----------------------</span>

<div class="viewcode-block" id="readGlyphFromString"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.readGlyphFromString">[docs]</a><span class="k">def</span> <span class="nf">readGlyphFromString</span><span class="p">(</span><span class="n">aString</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formatVersions</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Read .glif data from a string into a glyph object.</span>

<span class="sd">	The &#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">	the readGlyphFromString() method will attempt to set the following</span>
<span class="sd">	attributes on it:</span>
<span class="sd">		&quot;width&quot;      the advance with of the glyph</span>
<span class="sd">		&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">		&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">		&quot;note&quot;       a string</span>
<span class="sd">		&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">		&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">		&quot;guidelines&quot; a list of guideline data dictionaries</span>
<span class="sd">		&quot;anchors&quot;    a list of anchor data dictionaries</span>

<span class="sd">	All attributes are optional, in two ways:</span>
<span class="sd">		1) An attribute *won&#39;t* be set if the .glif file doesn&#39;t</span>
<span class="sd">		   contain data for it. &#39;glyphObject&#39; will have to deal</span>
<span class="sd">		   with default values itself.</span>
<span class="sd">		2) If setting the attribute fails with an AttributeError</span>
<span class="sd">		   (for example if the &#39;glyphObject&#39; attribute is read-</span>
<span class="sd">		   only), readGlyphFromString() will not propagate that</span>
<span class="sd">		   exception, but ignore that attribute.</span>

<span class="sd">	To retrieve outline information, you need to pass an object</span>
<span class="sd">	conforming to the PointPen protocol as the &#39;pointPen&#39; argument.</span>
<span class="sd">	This argument may be None if you don&#39;t need the outline data.</span>

<span class="sd">	The formatVersions argument defined the GLIF format versions</span>
<span class="sd">	that are allowed to be read.</span>

<span class="sd">	``validate`` will validate the read data. It is set to ``True`` by default.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">tree</span> <span class="o">=</span> <span class="n">_glifTreeFromString</span><span class="p">(</span><span class="n">aString</span><span class="p">)</span>
	<span class="n">_readGlyphFromTree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">,</span> <span class="n">formatVersions</span><span class="o">=</span><span class="n">formatVersions</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_writeGlyphToBytes</span><span class="p">(</span>
		<span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drawPointsFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
		<span class="n">formatVersion</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;Return .glif data for a glyph as a UTF-8 encoded bytes string.&quot;&quot;&quot;</span>
	<span class="c1"># start</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The glyph name is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">glyphName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The glyph name is empty.&quot;</span><span class="p">)</span>
	<span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s2">&quot;glyph&quot;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">formatVersion</span><span class="p">))]))</span>
	<span class="n">identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
	<span class="c1"># advance</span>
	<span class="n">_writeAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># unicodes</span>
	<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;unicodes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">_writeUnicodes</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># note</span>
	<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">_writeNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># image</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">_writeImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># guidelines</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;guidelines&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">_writeGuidelines</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># anchors</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;anchors&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="n">_writeAnchors</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># outline</span>
	<span class="k">if</span> <span class="n">drawPointsFunc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">outline</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;outline&quot;</span><span class="p">)</span>
		<span class="n">pen</span> <span class="o">=</span> <span class="n">GLIFPointPen</span><span class="p">(</span><span class="n">outline</span><span class="p">,</span> <span class="n">identifiers</span><span class="o">=</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
		<span class="n">drawPointsFunc</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">anchors</span><span class="p">:</span>
			<span class="n">_writeAnchorsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="c1"># prevent lxml from writing self-closing tags</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">outline</span><span class="p">):</span>
			<span class="n">outline</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span>
	<span class="c1"># lib</span>
	<span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
		<span class="n">_writeLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># return the text</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span>
		<span class="n">root</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">data</span>


<div class="viewcode-block" id="writeGlyphToString"><a class="viewcode-back" href="../../../ufoLib/glifLib.html#fontTools.ufoLib.glifLib.writeGlyphToString">[docs]</a><span class="k">def</span> <span class="nf">writeGlyphToString</span><span class="p">(</span><span class="n">glyphName</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drawPointsFunc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formatVersion</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Return .glif data for a glyph as a string. The XML declaration&#39;s</span>
<span class="sd">	encoding is always set to &quot;UTF-8&quot;.</span>
<span class="sd">	The &#39;glyphObject&#39; argument can be any kind of object (even None);</span>
<span class="sd">	the writeGlyphToString() method will attempt to get the following</span>
<span class="sd">	attributes from it:</span>
<span class="sd">		&quot;width&quot;      the advance width of the glyph</span>
<span class="sd">		&quot;height&quot;     the advance height of the glyph</span>
<span class="sd">		&quot;unicodes&quot;   a list of unicode values for this glyph</span>
<span class="sd">		&quot;note&quot;       a string</span>
<span class="sd">		&quot;lib&quot;        a dictionary containing custom data</span>
<span class="sd">		&quot;image&quot;      a dictionary containing image data</span>
<span class="sd">		&quot;guidelines&quot; a list of guideline data dictionaries</span>
<span class="sd">		&quot;anchors&quot;    a list of anchor data dictionaries</span>

<span class="sd">	All attributes are optional: if &#39;glyphObject&#39; doesn&#39;t</span>
<span class="sd">	have the attribute, it will simply be skipped.</span>

<span class="sd">	To write outline data to the .glif file, writeGlyphToString() needs</span>
<span class="sd">	a function (any callable object actually) that will take one</span>
<span class="sd">	argument: an object that conforms to the PointPen protocol.</span>
<span class="sd">	The function will be called by writeGlyphToString(); it has to call the</span>
<span class="sd">	proper PointPen methods to transfer the outline to the .glif file.</span>

<span class="sd">	The GLIF format version can be specified with the formatVersion argument.</span>

<span class="sd">	``validate`` will validate the written data. It is set to ``True`` by default.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">_writeGlyphToBytes</span><span class="p">(</span>
		<span class="n">glyphName</span><span class="p">,</span>
		<span class="n">glyphObject</span><span class="o">=</span><span class="n">glyphObject</span><span class="p">,</span>
		<span class="n">drawPointsFunc</span><span class="o">=</span><span class="n">drawPointsFunc</span><span class="p">,</span>
		<span class="n">formatVersion</span><span class="o">=</span><span class="n">formatVersion</span><span class="p">,</span>
		<span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
	<span class="p">)</span>
	<span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_writeAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">width</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">numberTypes</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;width attribute must be int or float&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">width</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">height</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">numberTypes</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;height attribute must be int or float&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">height</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;advance&quot;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">height</span><span class="p">)),</span> <span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">width</span><span class="p">))]))</span>
	<span class="k">elif</span> <span class="n">width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;advance&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">width</span><span class="p">)))</span>
	<span class="k">elif</span> <span class="n">height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;advance&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="n">height</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">_writeUnicodes</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">unicodes</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;unicodes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unicodes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
		<span class="n">unicodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">unicodes</span><span class="p">]</span>
	<span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">unicodes</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;unicode values must be int&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
			<span class="k">continue</span>
		<span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
		<span class="n">hexCode</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%04X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">code</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;unicode&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">hex</span><span class="o">=</span><span class="n">hexCode</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">_writeNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">note</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;note attribute must be str&quot;</span><span class="p">)</span>
	<span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
	<span class="n">note</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">note</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
	<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;note&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">note</span>

<span class="k">def</span> <span class="nf">_writeImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">image</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">imageValidator</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;image attribute must be a dict or dict-like object with the proper structure.&quot;</span><span class="p">)</span>
	<span class="n">attrs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s2">&quot;fileName&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">[</span><span class="s2">&quot;fileName&quot;</span><span class="p">])])</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">default</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="n">color</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
	<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_writeGuidelines</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">guidelines</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;guidelines&quot;</span><span class="p">,</span> <span class="p">[])</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">guidelinesValidator</span><span class="p">(</span><span class="n">guidelines</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;guidelines attribute does not have the proper structure.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">guideline</span> <span class="ow">in</span> <span class="n">guidelines</span><span class="p">:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">angle</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angle&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
		<span class="n">identifier</span> <span class="o">=</span> <span class="n">guideline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
			<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;guideline&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_writeAnchorsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">anchors</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;anchors attribute does not have the proper structure.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">()</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">endPath</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_writeAnchors</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;anchors&quot;</span><span class="p">,</span> <span class="p">[])</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;anchors attribute does not have the proper structure.&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">anchor</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
		<span class="n">color</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;color&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
		<span class="n">identifier</span> <span class="o">=</span> <span class="n">anchor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
			<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;anchor&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_writeLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">lib</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">lib</span><span class="p">:</span>
		<span class="c1"># don&#39;t write empty lib</span>
		<span class="k">return</span>
	<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
		<span class="n">valid</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">glyphLibValidator</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
		<span class="n">lib</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
	<span class="c1"># plist inside GLIF begins with 2 levels of indentation</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">totree</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">indent_level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
	<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="c1"># -----------------------</span>
<span class="c1"># layerinfo.plist Support</span>
<span class="c1"># -----------------------</span>

<span class="n">layerInfoVersion3ValueData</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s2">&quot;color&quot;</span>			<span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">valueValidator</span><span class="o">=</span><span class="n">colorValidator</span><span class="p">),</span>
	<span class="s2">&quot;lib&quot;</span>			<span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">valueValidator</span><span class="o">=</span><span class="n">genericTypeValidator</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">validateLayerInfoVersion3ValueForAttribute</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	This performs very basic validation of the value for attribute</span>
<span class="sd">	following the UFO 3 fontinfo.plist specification. The results</span>
<span class="sd">	of this should not be interpretted as *correct* for the font</span>
<span class="sd">	that they are part of. This merely indicates that the value</span>
<span class="sd">	is of the proper type and, where the specification defines</span>
<span class="sd">	a set range of possible values for an attribute, that the</span>
<span class="sd">	value is in the accepted range.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layerInfoVersion3ValueData</span><span class="p">:</span>
		<span class="k">return</span> <span class="kc">False</span>
	<span class="n">dataValidationDict</span> <span class="o">=</span> <span class="n">layerInfoVersion3ValueData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
	<span class="n">valueType</span> <span class="o">=</span> <span class="n">dataValidationDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
	<span class="n">validator</span> <span class="o">=</span> <span class="n">dataValidationDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valueValidator&quot;</span><span class="p">)</span>
	<span class="n">valueOptions</span> <span class="o">=</span> <span class="n">dataValidationDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valueOptions&quot;</span><span class="p">)</span>
	<span class="c1"># have specific options for the validator</span>
	<span class="k">if</span> <span class="n">valueOptions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">valueOptions</span><span class="p">)</span>
	<span class="c1"># no specific options</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validator</span> <span class="o">==</span> <span class="n">genericTypeValidator</span><span class="p">:</span>
			<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">valueType</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validator</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">isValidValue</span>

<span class="k">def</span> <span class="nf">validateLayerInfoVersion3Data</span><span class="p">(</span><span class="n">infoData</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	This performs very basic validation of the value for infoData</span>
<span class="sd">	following the UFO 3 layerinfo.plist specification. The results</span>
<span class="sd">	of this should not be interpretted as *correct* for the font</span>
<span class="sd">	that they are part of. This merely indicates that the values</span>
<span class="sd">	are of the proper type and, where the specification defines</span>
<span class="sd">	a set range of possible values for an attribute, that the</span>
<span class="sd">	value is in the accepted range.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">infoData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layerInfoVersion3ValueData</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown attribute </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
		<span class="n">isValidValue</span> <span class="o">=</span> <span class="n">validateLayerInfoVersion3ValueForAttribute</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">isValidValue</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Invalid value for attribute </span><span class="si">{attr}</span><span class="s2"> (</span><span class="si">{value!r}</span><span class="s2">).&quot;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">infoData</span>

<span class="c1"># -----------------</span>
<span class="c1"># GLIF Tree Support</span>
<span class="c1"># -----------------</span>

<span class="k">def</span> <span class="nf">_glifTreeFromFile</span><span class="p">(</span><span class="n">aFile</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">etree</span><span class="o">.</span><span class="n">_have_lxml</span><span class="p">:</span>
		<span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">aFile</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">(</span><span class="n">remove_comments</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">aFile</span><span class="p">)</span>
	<span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;glyph&quot;</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The GLIF is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Invalid GLIF structure.&quot;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">root</span>


<span class="k">def</span> <span class="nf">_glifTreeFromString</span><span class="p">(</span><span class="n">aString</span><span class="p">):</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">tobytes</span><span class="p">(</span><span class="n">aString</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">etree</span><span class="o">.</span><span class="n">_have_lxml</span><span class="p">:</span>
		<span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">etree</span><span class="o">.</span><span class="n">XMLParser</span><span class="p">(</span><span class="n">remove_comments</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;glyph&quot;</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The GLIF is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Invalid GLIF structure.&quot;</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">root</span>

<span class="k">def</span> <span class="nf">_readGlyphFromTree</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formatVersions</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="c1"># check the format version</span>
	<span class="n">formatVersion</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">formatVersion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unspecified format version in GLIF.&quot;</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">formatVersion</span><span class="p">)</span>
		<span class="n">formatVersion</span> <span class="o">=</span> <span class="n">v</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">formatVersion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">formatVersions</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Forbidden GLIF format version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">formatVersion</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">_readGlyphFromTreeFormat1</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="n">pointPen</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
	<span class="k">elif</span> <span class="n">formatVersion</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
		<span class="n">_readGlyphFromTreeFormat2</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="n">pointPen</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unsupported GLIF format version: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">formatVersion</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_readGlyphFromTreeFormat1</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="c1"># get the name</span>
	<span class="n">_readName</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># populate the sub elements</span>
	<span class="n">unicodes</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="n">haveSeenLib</span> <span class="o">=</span> <span class="n">haveSeenNote</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;outline&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">haveSeenOutline</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The outline element occurs more than once.&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The outline element contains unknown attributes.&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Invalid outline structure.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">buildOutlineFormat1</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">continue</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;advance&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">haveSeenAdvance</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The advance element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">_readAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span>
				<span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unicodes</span><span class="p">:</span>
					<span class="n">unicodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Illegal value for hex attribute of unicode element.&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;note&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">haveSeenNote</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The note element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenNote</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">_readNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;lib&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">haveSeenLib</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The lib element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenLib</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">_readLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown element in GLIF: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
	<span class="c1"># set the collected unicodes</span>
	<span class="k">if</span> <span class="n">unicodes</span><span class="p">:</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;unicodes&quot;</span><span class="p">,</span> <span class="n">unicodes</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readGlyphFromTreeFormat2</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">glyphObject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pointPen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
	<span class="c1"># get the name</span>
	<span class="n">_readName</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="c1"># populate the sub elements</span>
	<span class="n">unicodes</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">guidelines</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="n">haveSeenImage</span> <span class="o">=</span> <span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="n">haveSeenLib</span> <span class="o">=</span> <span class="n">haveSeenNote</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="n">identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
	<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;outline&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">haveSeenOutline</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The outline element occurs more than once.&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The outline element contains unknown attributes.&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Invalid outline structure.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenOutline</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="k">if</span> <span class="n">pointPen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">buildOutlineFormat2</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pointPen</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">continue</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;advance&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">haveSeenAdvance</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The advance element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenAdvance</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">_readAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;unicode&quot;</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span>
				<span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unicodes</span><span class="p">:</span>
					<span class="n">unicodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Illegal value for hex attribute of unicode element.&quot;</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;guideline&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown children in guideline element.&quot;</span><span class="p">)</span>
			<span class="n">attrib</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;angle&quot;</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
					<span class="n">attrib</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
			<span class="n">guidelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrib</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;anchor&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown children in anchor element.&quot;</span><span class="p">)</span>
			<span class="n">attrib</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
					<span class="n">attrib</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">attrib</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>
			<span class="n">anchors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attrib</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">haveSeenImage</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The image element occurs more than once.&quot;</span><span class="p">)</span>
				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown children in image element.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenImage</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">_readImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;note&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">haveSeenNote</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The note element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenNote</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">_readNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;lib&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">haveSeenLib</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The lib element occurs more than once.&quot;</span><span class="p">)</span>
			<span class="n">haveSeenLib</span> <span class="o">=</span> <span class="kc">True</span>
			<span class="n">_readLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown element in GLIF: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
	<span class="c1"># set the collected unicodes</span>
	<span class="k">if</span> <span class="n">unicodes</span><span class="p">:</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;unicodes&quot;</span><span class="p">,</span> <span class="n">unicodes</span><span class="p">)</span>
	<span class="c1"># set the collected guidelines</span>
	<span class="k">if</span> <span class="n">guidelines</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">guidelinesValidator</span><span class="p">(</span><span class="n">guidelines</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The guidelines are improperly formatted.&quot;</span><span class="p">)</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;guidelines&quot;</span><span class="p">,</span> <span class="n">guidelines</span><span class="p">)</span>
	<span class="c1"># set the collected anchors</span>
	<span class="k">if</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The anchors are improperly formatted.&quot;</span><span class="p">)</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;anchors&quot;</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readName</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">glyphName</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">glyphName</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Empty glyph name in GLIF.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">glyphName</span> <span class="ow">and</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readAdvance</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">advance</span><span class="p">):</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">advance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">advance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readNote</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">note</span><span class="p">):</span>
	<span class="n">lines</span> <span class="o">=</span> <span class="n">note</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
	<span class="n">note</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="n">note</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readLib</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
	<span class="n">child</span> <span class="o">=</span> <span class="n">lib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">plist</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">fromtree</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
		<span class="n">valid</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">glyphLibValidator</span><span class="p">(</span><span class="n">plist</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="n">plist</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_readImage</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">imageData</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">imageData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
		<span class="n">imageData</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">imageValidator</span><span class="p">(</span><span class="n">imageData</span><span class="p">):</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The image element is not properly formatted.&quot;</span><span class="p">)</span>
	<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">imageData</span><span class="p">)</span>

<span class="c1"># ----------------</span>
<span class="c1"># GLIF to PointPen</span>
<span class="c1"># ----------------</span>

<span class="n">contourAttributesFormat2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;identifier&quot;</span><span class="p">}</span>
<span class="n">componentAttributesFormat1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;xScale&quot;</span><span class="p">,</span> <span class="s2">&quot;xyScale&quot;</span><span class="p">,</span> <span class="s2">&quot;yxScale&quot;</span><span class="p">,</span> <span class="s2">&quot;yScale&quot;</span><span class="p">,</span> <span class="s2">&quot;xOffset&quot;</span><span class="p">,</span> <span class="s2">&quot;yOffset&quot;</span><span class="p">}</span>
<span class="n">componentAttributesFormat2</span> <span class="o">=</span> <span class="n">componentAttributesFormat1</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;identifier&quot;</span><span class="p">}</span>
<span class="n">pointAttributesFormat1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;smooth&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">}</span>
<span class="n">pointAttributesFormat2</span> <span class="o">=</span> <span class="n">pointAttributesFormat1</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;identifier&quot;</span><span class="p">}</span>
<span class="n">pointSmoothOptions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">}</span>
<span class="n">pointTypeOptions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">,</span> <span class="s2">&quot;curve&quot;</span><span class="p">,</span> <span class="s2">&quot;qcurve&quot;</span><span class="p">}</span>

<span class="c1"># format 1</span>

<span class="k">def</span> <span class="nf">buildOutlineFormat1</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pen</span><span class="p">,</span> <span class="n">outline</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="n">anchors</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">outline</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;contour&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
				<span class="n">point</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
					<span class="n">anchor</span> <span class="o">=</span> <span class="n">_buildAnchorFormat1</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">anchor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">anchors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
						<span class="k">continue</span>
			<span class="k">if</span> <span class="n">pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">_buildOutlineContourFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;component&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">_buildOutlineComponentFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown element in outline element: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">glyphObject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">anchors</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">anchorsValidator</span><span class="p">(</span><span class="n">anchors</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;GLIF 1 anchors are not properly formatted.&quot;</span><span class="p">)</span>
		<span class="n">_relaxedSetattr</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="s2">&quot;anchors&quot;</span><span class="p">,</span> <span class="n">anchors</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildAnchorFormat1</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;move&quot;</span><span class="p">:</span>
		<span class="k">return</span> <span class="kc">None</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">return</span> <span class="kc">None</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Required x attribute is missing in point element.&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Required y attribute is missing in point element.&quot;</span><span class="p">)</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
	<span class="n">anchor</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">anchor</span>

<span class="k">def</span> <span class="nf">_buildOutlineContourFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">contour</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">contour</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown attributes in contour element.&quot;</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">()</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
		<span class="n">massaged</span> <span class="o">=</span> <span class="n">_validateAndMassagePointStructures</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">pointAttributesFormat1</span><span class="p">,</span> <span class="n">openContourOffCurveLeniency</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
		<span class="n">_buildOutlinePointsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">massaged</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">endPath</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_buildOutlinePointsFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">contour</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">segmentType</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;segmentType&quot;</span><span class="p">]</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;smooth&quot;</span><span class="p">]</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="n">segmentType</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildOutlineComponentFormat1</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">component</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown child elements of component element.&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">component</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">componentAttributesFormat1</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown attribute in component element: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
	<span class="n">baseGlyphName</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">baseGlyphName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The base attribute is not defined in the component.&quot;</span><span class="p">)</span>
	<span class="n">transformation</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">transformation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">baseGlyphName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">transformation</span><span class="p">))</span>

<span class="c1"># format 2</span>

<span class="k">def</span> <span class="nf">buildOutlineFormat2</span><span class="p">(</span><span class="n">glyphObject</span><span class="p">,</span> <span class="n">pen</span><span class="p">,</span> <span class="n">outline</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">outline</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;contour&quot;</span><span class="p">:</span>
			<span class="n">_buildOutlineContourFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;component&quot;</span><span class="p">:</span>
			<span class="n">_buildOutlineComponentFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown element in outline element: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildOutlineContourFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">contour</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">contour</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">contourAttributesFormat2</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown attribute in contour element: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
	<span class="n">identifier</span> <span class="o">=</span> <span class="n">contour</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The identifier </span><span class="si">%s</span><span class="s2"> is used more than once.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The contour identifier </span><span class="si">%s</span><span class="s2"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
		<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">beginPath</span><span class="p">()</span>
		<span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The beginPath method needs an identifier kwarg. The contour&#39;s identifier value has been discarded.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
		<span class="n">massaged</span> <span class="o">=</span> <span class="n">_validateAndMassagePointStructures</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">pointAttributesFormat2</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
		<span class="n">_buildOutlinePointsFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">massaged</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">)</span>
	<span class="n">pen</span><span class="o">.</span><span class="n">endPath</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_buildOutlinePointsFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">contour</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">contour</span><span class="p">:</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
		<span class="n">segmentType</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;segmentType&quot;</span><span class="p">]</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;smooth&quot;</span><span class="p">]</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
		<span class="n">identifier</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The identifier </span><span class="si">%s</span><span class="s2"> is used more than once.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The identifier </span><span class="si">%s</span><span class="s2"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="n">segmentType</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
			<span class="n">pen</span><span class="o">.</span><span class="n">addPoint</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">segmentType</span><span class="o">=</span><span class="n">segmentType</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
			<span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The addPoint method needs an identifier kwarg. The point&#39;s identifier value has been discarded.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_buildOutlineComponentFormat2</span><span class="p">(</span><span class="n">pen</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">validate</span><span class="p">):</span>
	<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">component</span><span class="p">):</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown child elements of component element.&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">component</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">componentAttributesFormat2</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown attribute in component element: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
	<span class="n">baseGlyphName</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">baseGlyphName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The base attribute is not defined in the component.&quot;</span><span class="p">)</span>
	<span class="n">transformation</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">_transformationInfo</span><span class="p">:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">transformation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
	<span class="n">identifier</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">identifiers</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The identifier </span><span class="si">%s</span><span class="s2"> is used more than once.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;The identifier </span><span class="si">%s</span><span class="s2"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
		<span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">baseGlyphName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">transformation</span><span class="p">),</span> <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
		<span class="n">pen</span><span class="o">.</span><span class="n">addComponent</span><span class="p">(</span><span class="n">baseGlyphName</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">transformation</span><span class="p">))</span>
		<span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The addComponent method needs an identifier kwarg. The component&#39;s identifier value has been discarded.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="c1"># all formats</span>

<span class="k">def</span> <span class="nf">_validateAndMassagePointStructures</span><span class="p">(</span><span class="n">contour</span><span class="p">,</span> <span class="n">pointAttributes</span><span class="p">,</span> <span class="n">openContourOffCurveLeniency</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
		<span class="k">return</span>
	<span class="c1"># store some data for later validation</span>
	<span class="n">lastOnCurvePoint</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="n">haveOffCurvePoint</span> <span class="o">=</span> <span class="kc">False</span>
	<span class="c1"># validate and massage the individual point elements</span>
	<span class="n">massaged</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contour</span><span class="p">):</span>
		<span class="c1"># not &lt;point&gt;</span>
		<span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown child element (</span><span class="si">%s</span><span class="s2">) of contour element.&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
		<span class="n">point</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
		<span class="n">massaged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
			<span class="c1"># unknown attributes</span>
			<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">point</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pointAttributes</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown attribute in point element: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
			<span class="c1"># search for unknown children</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown child elements in point element.&quot;</span><span class="p">)</span>
		<span class="c1"># x and y are required</span>
		<span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">):</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Required </span><span class="si">%s</span><span class="s2"> attribute is missing in point element.&quot;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
			<span class="n">point</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="c1"># segment type</span>
		<span class="n">pointType</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">pointType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pointTypeOptions</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown point type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pointType</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">pointType</span> <span class="o">==</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="n">pointType</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">point</span><span class="p">[</span><span class="s2">&quot;segmentType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pointType</span>
		<span class="k">if</span> <span class="n">pointType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">haveOffCurvePoint</span> <span class="o">=</span> <span class="kc">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">lastOnCurvePoint</span> <span class="o">=</span> <span class="n">index</span>
		<span class="c1"># move can only occur as the first point</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">pointType</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;A move point occurs after the first point in the contour.&quot;</span><span class="p">)</span>
		<span class="c1"># smooth is optional</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;smooth&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">smooth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pointSmoothOptions</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Unknown point smooth value: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">smooth</span><span class="p">)</span>
		<span class="n">smooth</span> <span class="o">=</span> <span class="n">smooth</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span>
		<span class="n">point</span><span class="p">[</span><span class="s2">&quot;smooth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth</span>
		<span class="c1"># smooth can only be applied to curve and qcurve</span>
		<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">smooth</span> <span class="ow">and</span> <span class="n">pointType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;smooth attribute set in an offcurve point.&quot;</span><span class="p">)</span>
		<span class="c1"># name is optional</span>
		<span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
			<span class="n">point</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">if</span> <span class="n">openContourOffCurveLeniency</span><span class="p">:</span>
		<span class="c1"># remove offcurves that precede a move. this is technically illegal,</span>
		<span class="c1"># but we let it slide because there are fonts out there in the wild like this.</span>
		<span class="k">if</span> <span class="n">massaged</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;segmentType&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span><span class="p">:</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">massaged</span><span class="p">):</span>
				<span class="k">if</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;segmentType&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">break</span>
			<span class="k">if</span> <span class="n">count</span><span class="p">:</span>
				<span class="n">massaged</span> <span class="o">=</span> <span class="n">massaged</span><span class="p">[:</span><span class="o">-</span><span class="n">count</span><span class="p">]</span>
	<span class="c1"># validate the off-curves in the segments</span>
	<span class="k">if</span> <span class="n">validate</span> <span class="ow">and</span> <span class="n">haveOffCurvePoint</span> <span class="ow">and</span> <span class="n">lastOnCurvePoint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
		<span class="c1"># we only care about how many offCurves there are before an onCurve</span>
		<span class="c1"># filter out the trailing offCurves</span>
		<span class="n">offCurvesCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">massaged</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lastOnCurvePoint</span>
		<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">massaged</span><span class="p">:</span>
			<span class="n">segmentType</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="s2">&quot;segmentType&quot;</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">segmentType</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">offCurvesCount</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">offCurvesCount</span><span class="p">:</span>
					<span class="c1"># move and line can&#39;t be preceded by off-curves</span>
					<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span><span class="p">:</span>
						<span class="c1"># this will have been filtered out already</span>
						<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;move can not have an offcurve.&quot;</span><span class="p">)</span>
					<span class="k">elif</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
						<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;line can not have an offcurve.&quot;</span><span class="p">)</span>
					<span class="k">elif</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;curve&quot;</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">offCurvesCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
							<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Too many offcurves defined for curve.&quot;</span><span class="p">)</span>
					<span class="k">elif</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;qcurve&quot;</span><span class="p">:</span>
						<span class="k">pass</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="c1"># unknown segment type. it&#39;ll be caught later.</span>
						<span class="k">pass</span>
				<span class="n">offCurvesCount</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">return</span> <span class="n">massaged</span>

<span class="c1"># ---------------------</span>
<span class="c1"># Misc Helper Functions</span>
<span class="c1"># ---------------------</span>

<span class="k">def</span> <span class="nf">_relaxedSetattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="nb">setattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
	<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
		<span class="k">pass</span>

<span class="k">def</span> <span class="nf">_number</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Given a numeric string, return an integer or a float, whichever</span>
<span class="sd">	the string indicates. _number(&quot;1&quot;) will return the integer 1,</span>
<span class="sd">	_number(&quot;1.0&quot;) will return the float 1.0.</span>

<span class="sd">	&gt;&gt;&gt; _number(&quot;1&quot;)</span>
<span class="sd">	1</span>
<span class="sd">	&gt;&gt;&gt; _number(&quot;1.0&quot;)</span>
<span class="sd">	1.0</span>
<span class="sd">	&gt;&gt;&gt; _number(&quot;a&quot;)  # doctest: +IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">	Traceback (most recent call last):</span>
<span class="sd">	    ...</span>
<span class="sd">	GlifLibError: Could not convert a to an int or float.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">n</span>
	<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
		<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;Could not convert </span><span class="si">%s</span><span class="s2"> to an int or float.&quot;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

<span class="c1"># --------------------</span>
<span class="c1"># Rapid Value Fetching</span>
<span class="c1"># --------------------</span>

<span class="c1"># base</span>

<span class="k">class</span> <span class="nc">_DoneParsing</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">_BaseParser</span><span class="p">:</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
		<span class="kn">from</span> <span class="nn">xml.parsers.expat</span> <span class="k">import</span> <span class="n">ParserCreate</span>
		<span class="n">parser</span> <span class="o">=</span> <span class="n">ParserCreate</span><span class="p">()</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">StartElementHandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startElementHandler</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">EndElementHandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endElementHandler</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">endElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="n">other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">assert</span> <span class="n">other</span> <span class="o">==</span> <span class="n">name</span>


<span class="c1"># unicodes</span>

<span class="k">def</span> <span class="nf">_fetchUnicodes</span><span class="p">(</span><span class="n">glif</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Get a list of unicodes listed in glif.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">_FetchUnicodesParser</span><span class="p">()</span>
	<span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">glif</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">unicodes</span>

<span class="k">class</span> <span class="nc">_FetchUnicodesParser</span><span class="p">(</span><span class="n">_BaseParser</span><span class="p">):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">unicodes</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;unicode&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;glyph&quot;</span><span class="p">:</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unicodes</span><span class="p">:</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">unicodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
				<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
					<span class="k">pass</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">startElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="c1"># image</span>

<span class="k">def</span> <span class="nf">_fetchImageFileName</span><span class="p">(</span><span class="n">glif</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The image file name (if any) from glif.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">_FetchImageFileNameParser</span><span class="p">()</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">glif</span><span class="p">)</span>
	<span class="k">except</span> <span class="n">_DoneParsing</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">fileName</span>

<span class="k">class</span> <span class="nc">_FetchImageFileNameParser</span><span class="p">(</span><span class="n">_BaseParser</span><span class="p">):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;glyph&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fileName&quot;</span><span class="p">)</span>
			<span class="k">raise</span> <span class="n">_DoneParsing</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">startElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="c1"># component references</span>

<span class="k">def</span> <span class="nf">_fetchComponentBases</span><span class="p">(</span><span class="n">glif</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Get a list of component base glyphs listed in glif.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">parser</span> <span class="o">=</span> <span class="n">_FetchComponentBasesParser</span><span class="p">()</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">glif</span><span class="p">)</span>
	<span class="k">except</span> <span class="n">_DoneParsing</span><span class="p">:</span>
		<span class="k">pass</span>
	<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">bases</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_FetchComponentBasesParser</span><span class="p">(</span><span class="n">_BaseParser</span><span class="p">):</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">startElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;component&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elementStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;outline&quot;</span><span class="p">:</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">startElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">endElementHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;outline&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">_DoneParsing</span>
		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">endElementHandler</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># --------------</span>
<span class="c1"># GLIF Point Pen</span>
<span class="c1"># --------------</span>

<span class="n">_transformationInfo</span> <span class="o">=</span> <span class="p">[</span>
	<span class="c1"># field name, default value</span>
	<span class="p">(</span><span class="s2">&quot;xScale&quot;</span><span class="p">,</span>    <span class="mi">1</span><span class="p">),</span>
	<span class="p">(</span><span class="s2">&quot;xyScale&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
	<span class="p">(</span><span class="s2">&quot;yxScale&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
	<span class="p">(</span><span class="s2">&quot;yScale&quot;</span><span class="p">,</span>    <span class="mi">1</span><span class="p">),</span>
	<span class="p">(</span><span class="s2">&quot;xOffset&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
	<span class="p">(</span><span class="s2">&quot;yOffset&quot;</span><span class="p">,</span>   <span class="mi">0</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">GLIFPointPen</span><span class="p">(</span><span class="n">AbstractPointPen</span><span class="p">):</span>

	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Helper class using the PointPen protocol to write the &lt;outline&gt;</span>
<span class="sd">	part of .glif files.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">formatVersion</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">identifiers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">identifiers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">identifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">=</span> <span class="n">formatVersion</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">identifiers</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">outline</span> <span class="o">=</span> <span class="n">element</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">validate</span> <span class="o">=</span> <span class="n">validate</span>

	<span class="k">def</span> <span class="nf">beginPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier not formatted properly: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">,</span> <span class="s2">&quot;contour&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>

	<span class="k">def</span> <span class="nf">endPath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;open contour has loose offcurve point&quot;</span><span class="p">)</span>
		<span class="c1"># prevent lxml from writing self-closing tags</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">contour</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointType</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="k">def</span> <span class="nf">addPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">segmentType</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
		<span class="c1"># coordinates</span>
		<span class="k">if</span> <span class="n">pt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">pt</span><span class="p">:</span>
					<span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">numberTypes</span><span class="p">):</span>
						<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;coordinates must be int or float&quot;</span><span class="p">)</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="c1"># segment type</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="n">segmentType</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;move occurs after a point has already been added to the contour.&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">segmentType</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;line&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;offcurve occurs before </span><span class="si">%s</span><span class="s2"> point.&quot;</span> <span class="o">%</span> <span class="n">segmentType</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;curve&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;too many offcurve points before curve point.&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segmentType</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">segmentType</span> <span class="o">=</span> <span class="s2">&quot;offcurve&quot;</span>
		<span class="k">if</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">+=</span> <span class="mi">1</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">prevOffCurveCount</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">prevPointTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segmentType</span><span class="p">)</span>
		<span class="c1"># smooth</span>
		<span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span> <span class="ow">and</span> <span class="n">segmentType</span> <span class="o">==</span> <span class="s2">&quot;offcurve&quot;</span><span class="p">:</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;can&#39;t set smooth in an offcurve point.&quot;</span><span class="p">)</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;smooth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>
		<span class="c1"># name</span>
		<span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
		<span class="c1"># identifier</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier not formatted properly: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contour</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">addComponent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="n">glyphName</span><span class="p">)])</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="p">),</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_transformationInfo</span><span class="p">,</span> <span class="n">transformation</span><span class="p">):</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">numberTypes</span><span class="p">):</span>
				<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;transformation values must be int or float&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">default</span><span class="p">:</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">formatVersion</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">:</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier used more than once: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">identifierValidator</span><span class="p">(</span><span class="n">identifier</span><span class="p">):</span>
					<span class="k">raise</span> <span class="n">GlifLibError</span><span class="p">(</span><span class="s2">&quot;identifier not formatted properly: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">identifier</span><span class="p">)</span>
			<span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
		<span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outline</span><span class="p">,</span> <span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">doctest</span>
	<span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Just van Rossum, Behdad Esfahbod, and the fontTools Authors. CC BY-SA 4.0

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>